# Применение значений ко всем похожим операциям

## Описание

Функционал автоматического применения значений полей ко всем похожим операциям при импорте банковских выписок. Это значительно упрощает обработку типовых операций, позволяя заполнить одинаковые поля для множества похожих операций одним действием.

## Пользовательский сценарий

### Пример

Пользователь загружает банковскую выписку с множеством операций. Среди них есть несколько типовых переводов:

```
982  14.11.2025  Перевод собственных средств. НДС не облагается  1 030 ₽
     ИНДИВИДУАЛЬНЫЙ ПРЕДПРИНИМАТЕЛЬ ШТАНЬ ЮЛИЯ ВАЛЕРЬЕВНА
     ИНН: 370381967950

981  13.11.2025  Перевод собственных средств. НДС не облагается  1 530 ₽
     ИНДИВИДУАЛЬНЫЙ ПРЕДПРИНИМАТЕЛЬ ШТАНЬ ЮЛИЯ ВАЛЕРЬЕВНА
     ИНН: 370381967950

980  12.11.2025  Перевод собственных средств. НДС не облагается  2 100 ₽
     ИНДИВИДУАЛЬНЫЙ ПРЕДПРИНИМАТЕЛЬ ШТАНЬ ЮЛИЯ ВАЛЕРЬЕВНА
     ИНН: 370381967950
```

Когда пользователь выбирает статью для первой операции, система:

1. Автоматически определяет все похожие операции
2. Показывает диалог с предложением применить выбранную статью ко всем похожим
3. Пользователь может принять или отклонить предложение

## Как это работает

### 1. Определение похожих операций

Операции считаются похожими, если совпадают:

**Обязательный критерий:**

- Описание операции (первые 30 символов, без учета регистра)

**Дополнительные критерии (хотя бы один):**

- ИНН контрагента (плательщика или получателя в зависимости от направления)
- Имя контрагента (первые 30 символов, без учета регистра)

**Исключения:**

- Уже обработанные операции (processed = true) не учитываются
- Сама текущая операция не включается в список похожих

### 2. Показ диалога

После изменения любого из следующих полей система проверяет наличие похожих операций:

- Статья
- Контрагент
- Счет
- Сделка
- Подразделение
- Валюта
- Тип операции (направление)

Если найдены похожие операции, показывается диалог с:

- Информацией о текущей операции
- Количеством найденных похожих операций
- Критериями похожести
- Двумя кнопками: "Только эту операцию" и "Применить ко всем (N)"

### 3. Применение к похожим

При нажатии "Применить ко всем":

1. Система использует bulk update API для обновления всех похожих операций
2. Обновляется только измененное поле
3. Показывается уведомление об успешном обновлении с количеством операций
4. Таблица автоматически обновляется

При нажатии "Только эту операцию":

- Диалог закрывается без дополнительных действий
- Изменяется только текущая операция

## Технические детали

### Frontend

**Новые компоненты:**

1. `ApplySimilarDialog.tsx` - диалоговое окно для подтверждения применения
2. `utils/findSimilarOperations.ts` - утилита для поиска похожих операций

**Изменения в существующих компонентах:**

1. `ImportMappingTable.tsx`:
   - Добавлено состояние `similarDialog` для управления диалогом
   - Функция `handleFieldUpdate` для обработки изменений полей
   - Функции `handleApplySimilar` и `handleSkipSimilar` для действий диалога
   - Передача `onFieldUpdate` во все колонки таблицы

2. `ImportMappingRow.tsx`:
   - Добавлен проп `onFieldUpdate` для уведомления о изменениях
   - Вызов callback после успешного обновления поля

### Backend

**Расширенные типы:**

```typescript
interface BulkUpdateRequest {
  operationIds: string[];
  matchedArticleId?: string | null;
  matchedCounterpartyId?: string | null;
  matchedAccountId?: string | null;
  matchedDealId?: string | null; // Добавлено
  matchedDepartmentId?: string | null; // Добавлено
  currency?: string; // Добавлено
  direction?: 'income' | 'expense' | 'transfer' | null; // Добавлено
  confirmed?: boolean;
}
```

**API Endpoint:**

- `PATCH /api/imports/sessions/:sessionId/operations/bulk`
- Поддерживает обновление всех полей: статья, контрагент, счет, сделка, подразделение, валюта, направление

### Алгоритм поиска похожих операций

```typescript
function findSimilarOperations(
  targetOperation: ImportedOperation,
  allOperations: ImportedOperation[]
): ImportedOperation[];
```

**Логика:**

1. Определяет контрагента и ИНН целевой операции (в зависимости от направления)
2. Нормализует текст (первые 30 символов, нижний регистр, без лишних пробелов)
3. Фильтрует операции по критериям:
   - Исключает саму операцию
   - Исключает обработанные операции
   - Проверяет совпадение описания (обязательно)
   - Проверяет совпадение ИНН (если есть)
   - Проверяет совпадение имени контрагента (если есть)
4. Возвращает список похожих операций

## UI/UX

### Диалог применения

**Структура:**

- Заголовок с иконкой и количеством похожих операций
- Информационная панель с описанием действия
- Детали текущей операции (описание, контрагент, ИНН)
- Подсказка о критериях похожести
- Две кнопки: "Только эту операцию" и "Применить ко всем (N)"

**Цветовая схема:**

- Иконка: синяя (Copy icon)
- Информационная панель: светло-синий фон
- Кнопки: вторичная (серая) для пропуска, первичная (синяя) для применения

**Адаптивность:**

- Фиксированная позиция по центру экрана
- Полупрозрачный темный фон
- Максимальная ширина 448px (max-w-md)
- Отступы 16px от краев на мобильных устройствах

## Примеры использования

### Сценарий 1: Типовые переводы

**Ситуация:** В выписке 50 переводов собственных средств с одинаковым описанием и контрагентом.

**Действия:**

1. Пользователь выбирает статью "Собственные средства" для первой операции
2. Система находит 49 похожих операций
3. Показывается диалог: "Найдено 49 похожих операций"
4. Пользователь нажимает "Применить ко всем (49)"
5. Все 50 операций получают статью "Собственные средства"

**Результат:** Экономия времени - вместо 50 кликов всего 2.

### Сценарий 2: Разные статьи для похожих операций

**Ситуация:** В выписке несколько операций с одним контрагентом, но разными услугами.

**Действия:**

1. Пользователь выбирает статью для первой операции
2. Система находит похожие операции
3. Пользователь нажимает "Только эту операцию", так как услуги разные
4. Для следующей операции выбирает другую статью

**Результат:** Гибкость - пользователь решает, когда применять к похожим.

### Сценарий 3: Последовательное заполнение полей

**Ситуация:** Пользователь заполняет несколько полей для типовых операций.

**Действия:**

1. Выбирает статью → применяет ко всем похожим (20 операций)
2. Выбирает контрагента → применяет ко всем похожим (20 операций)
3. Выбирает счет → применяет ко всем похожим (20 операций)
4. Выбирает подразделение → применяет ко всем похожим (20 операций)

**Результат:** Быстрое заполнение всех полей для группы операций.

## Ограничения

1. **Поиск только на текущей странице:** Функция ищет похожие операции только среди загруженных (текущая страница, лимит 20). Если похожие операции находятся на других страницах, они не будут найдены.

2. **Точность сопоставления:** Используются первые 30 символов описания и имени контрагента, что может привести к:
   - Ложным срабатываниям при похожих, но разных операциях
   - Пропуску похожих операций с отличающимися окончаниями

3. **Направление операции:** Контрагент определяется по направлению операции (expense → receiver, income → payer). Если направление определено неправильно, поиск может не найти похожие операции.

4. **Обработанные операции:** Уже импортированные операции (processed = true) всегда исключаются из поиска.

## Будущие улучшения

- [ ] Поиск похожих операций по всем страницам сессии
- [ ] Настройка чувствительности поиска (строгий/мягкий режим)
- [ ] Предпросмотр операций перед применением
- [ ] Возможность исключить отдельные операции из списка похожих
- [ ] История применения к похожим операциям
- [ ] Статистика по использованию функции
- [ ] Автоматическое применение без диалога (с настройкой в профиле)

## Метрики успеха

1. **Снижение времени обработки выписок** - цель: 30-50% для выписок с типовыми операциями
2. **Количество использований функции** - цель: 70%+ пользователей используют при импорте
3. **Точность определения похожих** - цель: < 5% ложных срабатываний
4. **Удовлетворенность пользователей** - цель: 4.5/5 в опросах

## Связанные документы

- [Duplicate Detection](./duplicate-detection.md) - обнаружение дубликатов
- [Bank Import Loading Indicator](./bank-import-loading-indicator.md) - индикатор загрузки
- [Notification System](./notification-system.md) - система уведомлений
