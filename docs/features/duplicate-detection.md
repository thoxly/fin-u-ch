# Обнаружение дубликатов при импорте банковских выписок

## Описание

Система автоматически обнаруживает дубликаты операций при импорте банковских выписок. Это помогает избежать повторного импорта одних и тех же операций.

## Как работает обнаружение дубликатов

**⚠️ ВАЖНО:** Система сравнивает **только исходные данные из банковской выписки**, не учитывая ручное распределение пользователем (статьи, счета, контрагенты и т.д.). Это значит, что даже если вы вручную изменили статью или контрагента, операция всё равно будет распознана как дубликат при повторном импорте той же выписки.

### Критерии обнаружения

Операция считается дубликатом, если:

1. **Совпадает дата** (в пределах ±2 дня от импортируемой операции)
2. **Совпадает сумма** (точное совпадение)
3. **И выполняется одно из условий:**

### Для уже импортированных операций (таблица `operation`):

- Совпадает **назначение платежа** (первые 50 символов)

_Примечание: В таблице `operation` не сохраняются исходные данные плательщика/получателя из выписки, поэтому проверка ограничена только назначением платежа._

### Для загруженных операций (таблица `imported_operations`):

- Совпадает **номер документа** (если указан)
- Совпадают **ИНН плательщика или получателя**
- Совпадают **имена плательщика и получателя** (частичное совпадение первых 20 символов)
- Совпадает **назначение платежа** (частичное совпадение первых 30 символов)

**Система проверяет дубликаты в двух таблицах последовательно:**

1. **Уже импортированные операции** (таблица `operation`) - сравнение по дате, сумме и назначению платежа
2. **Загруженные, но не обработанные операции** (таблица `imported_operations`) - полное сравнение по исходным данным выписки

Это означает, что если вы загрузите один и тот же файл дважды, система обнаружит дубликаты независимо от того, как пользователь вручную распределил операции.

## Пользовательский интерфейс

### При загрузке файла

После загрузки файла система показывает:

- Общее количество найденных операций
- Количество обнаруженных дубликатов
- Статистику парсинга (если часть документов не была обработана):
  - Количество найденных секций документов в файле
  - Количество пропущенных документов (неподдерживаемый тип)
  - Количество невалидных документов (отсутствуют обязательные поля)
  - Типы документов, найденные в файле

Пример: `Файл загружен. Найдено операций: 50. Обнаружено дубликатов: 5`

Пример с предупреждением:

```
Файл загружен. Найдено операций: 815

Внимание: В файле найдено 2000 документов, но обработано только 815:
• Пропущено (неподдерживаемый тип): 1150 (типы: Платежное требование, Инкассовое поручение)
• Невалидных (нет даты или суммы): 35
```

### В таблице импорта

**Визуальные индикаторы:**

- Дубликаты подсвечены **оранжевым фоном** с оранжевой границей слева
- В колонке "Статус" показана иконка копирования (Copy) для дубликатов
- При наведении на иконку показывается подсказка: "Возможный дубликат - операция с похожими параметрами уже существует"

**Статистика:**
В верхней панели отображается:

- Всего операций
- Количество несопоставленных операций
- Количество дубликатов (если есть)

**Фильтры:**
Доступны фильтры для просмотра:

- Все операции
- Только дубликаты
- Без дубликатов

### Импорт операций

**Автоматический пропуск дубликатов:**

- При импорте **всех операций** (без выбора конкретных) дубликаты автоматически пропускаются
- Это предотвращает случайное создание повторных операций

**Явный импорт дубликатов:**

- Пользователь может **вручную выбрать** дубликаты и импортировать их
- Это полезно, если операция действительно повторяется (например, ежемесячный платеж)

## Технические детали

### Алгоритм обнаружения

Функция `detectDuplicate` выполняет последовательную проверку **только по исходным данным из выписки**:

1. **Первый этап:** Поиск среди уже импортированных операций (`operation`)
   - Выбираются операции с той же суммой и датой в диапазоне ±2 дня
   - Сравнивается **только назначение платежа** (первые 50 символов)
   - ⚠️ **Ограничение:** В таблице `operation` не сохраняются исходные данные из выписки (payer, receiver, payerInn, receiverInn), поэтому полное сравнение невозможно
2. **Второй этап:** Поиск среди загруженных операций (`imported_operations`)
   - Выбираются только необработанные операции (`processed: false`)
   - Полное сравнение по исходным данным: номер документа, ИНН, имена плательщика/получателя, назначение
   - ⚠️ Не учитываются сопоставленные поля (статья, счет, контрагент) - они могли быть изменены пользователем вручную
3. **Результат:** Если найдено совпадение на любом этапе, операция помечается как дубликат

### База данных

Добавлены поля в таблицу `imported_operations`:

- `isDuplicate` (boolean) - помечает операцию как дубликат
- `duplicateOfId` (string) - ID существующей операции или импортированной операции, с которой совпала текущая

### API

**Endpoint `POST /imports/upload`:**
Возвращает дополнительное поле:

```json
{
  "sessionId": "...",
  "importedCount": 50,
  "duplicatesCount": 5,
  "fileName": "..."
}
```

**Endpoint `GET /imports/sessions/:sessionId/operations`:**

- Принимает параметр `duplicate` (boolean | undefined) для фильтрации
- Возвращает поле `duplicates` в ответе с количеством дубликатов

**Endpoint `POST /imports/sessions/:sessionId/import`:**

- Автоматически пропускает дубликаты при импорте всех операций
- Позволяет импортировать дубликаты при явном указании их ID

## Примеры использования

### Сценарий 1: Полное перекрытие периодов

Пользователь загрузил выписку за январь, а затем загрузил выписку за весь год:

1. При загрузке годовой выписки система обнаружит все операции января как дубликаты
2. Дубликаты будут подсвечены оранжевым
3. При импорте они будут автоматически пропущены
4. Импортируются только новые операции (февраль-декабрь)

### Сценарий 2: Частичное перекрытие

Пользователь загрузил выписку за первую неделю января, затем за весь январь:

1. Операции первой недели будут помечены как дубликаты
2. Остальные операции месяца будут новыми
3. При импорте дубликаты пропустятся, новые операции импортируются

### Сценарий 3: Повторяющийся платеж

Если компания платит аренду каждый месяц одинаковой суммой:

1. Операция может быть помечена как дубликат
2. Пользователь может вручную выбрать её и импортировать
3. Или добавить другой уникальный идентификатор (например, в номер документа)

## Ограничения

1. **Ложноположительные результаты:** Операции с одинаковой суммой и контрагентом в близкие даты могут быть ошибочно помечены как дубликаты (например, ежемесячная аренда)
2. **Временное окно:** Проверка проводится в окне ±2 дня. Операции за пределами этого окна не сравниваются
3. **Производительность:** Проверка ограничена 10 потенциальными совпадениями для каждой операции
4. **Частичное совпадение:** Используется только первые 20 символов для имен и 30 для описания, что может приводить к ложным срабатываниям при похожих названиях
5. **Лимит операций:** Система может обработать до 5000 операций за один импорт. Файлы с большим количеством операций следует разделить на части
6. **Поддерживаемые типы документов:** Обрабатываются только "Платежные поручения". Другие типы документов (Платежные требования, Инкассовые поручения и т.д.) пропускаются

## Будущие улучшения

- [ ] Настройка чувствительности обнаружения дубликатов
- [ ] Показ конкретной существующей операции, с которой совпадает дубликат
- [ ] Возможность "объединения" дубликатов (например, обновление существующей операции)
- [ ] Статистика по дубликатам в разрезе периодов
