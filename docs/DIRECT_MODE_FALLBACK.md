# Fallback –Ω–∞ Direct —Ä–µ–∂–∏–º: –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, –µ—Å–ª–∏ API –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç?

## –ö—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç

**–î–∞, –µ—Å–ª–∏ API –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –æ–ø–µ—Ä–∞—Ü–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ —á–µ—Ä–µ–∑ –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ –ë–î.**

Worker –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ **Direct —Ä–µ–∂–∏–º** (–ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ –ë–î –∏ Ozon API), –µ—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API

–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–π Worker —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API:

```typescript
// apps/worker/src/jobs/ozon.generate.operations.ts

logger.info('üè• –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API...');
let useApiMode = false;

try {
  const isHealthy = await ozonOperationService.healthCheck();
  if (isHealthy) {
    useApiMode = true;
    logger.info('‚úÖ API –¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º API —Ä–µ–∂–∏–º');
  } else {
    logger.warn('‚ö†Ô∏è  API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –ø—Ä—è–º–æ–π —Ä–µ–∂–∏–º (direct)');
  }
} catch (apiError: any) {
  logger.warn(`‚ö†Ô∏è  –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ API: ${apiError.message}`);
  logger.warn('üí° –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –ø—Ä—è–º–æ–π —Ä–µ–∂–∏–º (direct)');
}
```

### 2. –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã

–í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ Worker –≤—ã–±–∏—Ä–∞–µ—Ç —Ä–µ–∂–∏–º:

```typescript
if (useApiMode) {
  // API —Ä–µ–∂–∏–º - —á–µ—Ä–µ–∑ API —Å–µ—Ä–≤–µ—Ä
  logger.info('üìã –ü—Ä–æ–¥—É–∫—Ü–∏–æ–Ω–Ω—ã–π —Ä–µ–∂–∏–º - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ API');
  result = await ozonOperationService.createOperationsForAllIntegrations();
} else {
  // Direct —Ä–µ–∂–∏–º - –Ω–∞–ø—Ä—è–º—É—é –∫ –ë–î –∏ Ozon API
  logger.info('üìã –ü—Ä–æ–¥—É–∫—Ü–∏–æ–Ω–Ω—ã–π —Ä–µ–∂–∏–º - –æ–±—Ä–∞–±–æ—Ç–∫–∞ (–ø—Ä—è–º–æ–π —Ä–µ–∂–∏–º)');
  const { ozonDirectService } = await import('./ozon.direct.service');
  result = await ozonDirectService.createOperationsForAllIntegrations();
}
```

## –ß—Ç–æ –¥–µ–ª–∞–µ—Ç Direct —Ä–µ–∂–∏–º?

### –®–∞–≥–∏ —Å–æ–∑–¥–∞–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ Direct —Ä–µ–∂–∏–º–µ:

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π** - –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –ë–î —á–µ—Ä–µ–∑ Prisma
2. **–ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö –∏–∑ Ozon API** - Worker —Å–∞–º –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ Ozon
3. **–†–∞—Å—á–µ—Ç —Å—É–º–º—ã –≤—ã–ø–ª–∞—Ç—ã** - –ª–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –≤ Worker
4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –≤ –ë–î
5. **–°–æ–∑–¥–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏** - –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ `prisma.operation.create()`

### –ö–æ–¥ —Å–æ–∑–¥–∞–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏:

```typescript
// apps/worker/src/jobs/ozon.direct.service.ts

const createdOperation = await prisma.operation.create({
  data: {
    type: 'expense',
    operationDate: paymentDates.paymentDate,
    amount: operationAmount,
    currency,
    articleId: integration.articleId,
    accountId: integration.accountId,
    counterpartyId: counterpartyId,
    description,
    isConfirmed: true,
    companyId: integration.companyId,
  },
  include: {
    article: true,
    account: true,
    counterparty: true,
  },
});
```

## –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Direct —Ä–µ–∂–∏–º?

Direct —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –≤ —Å–ª–µ–¥—É—é—â–∏—Ö —Å–ª—É—á–∞—è—Ö:

1. **API —Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω** - Worker –Ω–µ –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ API
2. **WORKER_API_KEY –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω** - –Ω–µ—Ç –∫–ª—é—á–∞ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
3. **–û—à–∏–±–∫–∞ health check** - API –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ
4. **–°–µ—Ç–µ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã** - –≤—Ä–µ–º–µ–Ω–Ω–∞—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API

## –ß—Ç–æ —Ç–µ—Ä—è–µ—Ç—Å—è –≤ Direct —Ä–µ–∂–∏–º–µ?

–ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ Direct —Ä–µ–∂–∏–º–∞ **–Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç** —Å–ª–µ–¥—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ API:

### ‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ –≤ Direct —Ä–µ–∂–∏–º–µ:

1. **ImportSession** - –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è —Å–µ—Å—Å–∏–∏ –∏–º–ø–æ—Ä—Ç–∞ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
2. **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ª–æ–≥–∏ —Ç–æ–ª—å–∫–æ –≤ Worker
3. **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ dataHash** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
4. **Retry —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π** - –±–∞–∑–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
5. **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è** - Worker —Å–∞–º –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–∞–Ω–Ω—ã–µ

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ Direct —Ä–µ–∂–∏–º–µ:

1. **–°–æ–∑–¥–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π** - –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤** - –±–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –¥–∞—Ç–µ –∏ –æ–ø–∏—Å–∞–Ω–∏—é
3. **–†–∞—Å—á–µ—Ç —Å—É–º–º** - –ª–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –∏–¥–µ–Ω—Ç–∏—á–Ω–∞ API
4. **–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ/–¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ** - API –∫–ª—é—á–∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞—é—Ç—Å—è
5. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** - –±–∞–∑–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Direct —Ä–µ–∂–∏–º–µ

Worker –ø–æ–¥—Ä–æ–±–Ω–æ –ª–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ —à–∞–≥–∏:

```
üîÑ –ù–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π (–ø—Ä—è–º–æ–π —Ä–µ–∂–∏–º)...
üì¶ –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø [1/1]
   ID –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏: xxx
   –ö–æ–º–ø–∞–Ω–∏—è: Company Name
   –ì—Ä–∞—Ñ–∏–∫ –≤—ã–ø–ª–∞—Ç: next_week

   üöÄ –ù–ê–ß–ê–õ–û –°–û–ó–î–ê–ù–ò–Ø –û–ü–ï–†–ê–¶–ò–ò
   üîç –®–∞–≥ 1/7: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π...
   ‚úÖ –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç
   üîç –®–∞–≥ 2/7: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç –¥–ª—è Ozon API...
   üîç –®–∞–≥ 3/7: –ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö –∏–∑ Ozon API...
   ‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã –∏–∑ Ozon API
   üîç –®–∞–≥ 4/7: –†–∞—Å—á–µ—Ç —Å—É–º–º—ã –≤—ã–ø–ª–∞—Ç—ã...
   üîç –®–∞–≥ 5/7: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–∏...
   üîç –®–∞–≥ 6/7: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã...
   ‚úÖ –î—É–±–ª–∏–∫–∞—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
   üîç –®–∞–≥ 7/7: –†–∞—Å—á–µ—Ç –¥–∞—Ç –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏...
   üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö...
   ‚úÖ –û–ü–ï–†–ê–¶–ò–Ø –£–°–ü–ï–®–ù–û –°–û–ó–î–ê–ù–ê
```

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:

- Direct —Ä–µ–∂–∏–º —É–¥–æ–±–µ–Ω –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑ –∑–∞–ø—É—Å–∫–∞ API
- –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –ª–æ–≥–∏–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π

### –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞:

- **–í—Å–µ–≥–¥–∞ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–π—Ç–µ WORKER_API_KEY** –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è API —Ä–µ–∂–∏–º–∞
- API —Ä–µ–∂–∏–º –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:
  - –ü–æ–ª–Ω–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π (ImportSession)
  - –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
  - –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ dataHash
  - Retry —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:

- –°–ª–µ–¥–∏—Ç–µ –∑–∞ –ª–æ–≥–∞–º–∏ Worker'–∞
- –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ "‚ö†Ô∏è API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –ø—Ä—è–º–æ–π —Ä–µ–∂–∏–º" - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
  1. –ó–∞–ø—É—â–µ–Ω –ª–∏ API —Å–µ—Ä–≤–µ—Ä
  2. –ù–∞—Å—Ç—Ä–æ–µ–Ω –ª–∏ WORKER_API_KEY
  3. –î–æ—Å—Ç—É–ø–µ–Ω –ª–∏ API –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É URL

## –í—ã–≤–æ–¥

**–î–∞, –æ–ø–µ—Ä–∞—Ü–∏—è –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ —á–µ—Ä–µ–∑ –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ –ë–î, –µ—Å–ª–∏ API –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç.**

Direct —Ä–µ–∂–∏–º - —ç—Ç–æ **–Ω–∞–¥–µ–∂–Ω—ã–π fallback**, –∫–æ—Ç–æ—Ä—ã–π –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç:

- ‚úÖ –û–ø–µ—Ä–∞—Ü–∏–∏ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã –¥–∞–∂–µ –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API
- ‚úÖ –í—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞—Ç—å

–û–¥–Ω–∞–∫–æ –¥–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å API —Ä–µ–∂–∏–º, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.
