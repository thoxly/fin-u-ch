# –¢–∏–∫–µ—Ç: –ò–º–ø–æ—Ä—Ç –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –≤—ã–ø–∏—Å–æ–∫ (—Ñ–æ—Ä–º–∞—Ç 1–° ClientBankExchange)

## üéØ –¶–µ–ª—å

–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∏–º–ø–æ—Ä—Ç–∞ –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –≤—ã–ø–∏—Å–æ–∫ –∏–∑ —Ñ–∞–π–ª–æ–≤ —Ñ–æ—Ä–º–∞—Ç–∞ 1–° ClientBankExchange (.txt) —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Å–æ–∑–¥–∞–Ω–∏–µ–º –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —Å–∏—Å—Ç–µ–º–µ, –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Ä—É—á–Ω–æ–≥–æ –º–∞–ø–ø–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª –¥–ª—è –±—É–¥—É—â–∏—Ö –∏–º–ø–æ—Ä—Ç–æ–≤.

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ò–ò-–º–æ–¥—É–ª—å –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞ —Å—Ç–∞—Ä—Ç–µ, —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–æ–∏—Ç—Å—è –Ω–∞ —à–∞–±–ª–æ–Ω–∞—Ö, –ø—Ä–∞–≤–∏–ª–∞—Ö –∏ —ç–≤—Ä–∏—Å—Ç–∏–∫–∞—Ö.

---

## üìã –û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å:

1. –ó–∞–≥—Ä—É–∂–∞—Ç—å —Ñ–∞–π–ª—ã –≤—ã–ø–∏—Å–æ–∫ –≤ —Ñ–æ—Ä–º–∞—Ç–µ 1–° ClientBankExchange
2. –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫–∏ –æ–ø–µ—Ä–∞—Ü–∏–π –ø–µ—Ä–µ–¥ –∏–º–ø–æ—Ä—Ç–æ–º
3. –°–æ—Ö—Ä–∞–Ω—è—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –º–∞–ø–ø–∏–Ω–≥–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –≤ –±—É–¥—É—â–∏—Ö –∏–º–ø–æ—Ä—Ç–∞—Ö
4. –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ –æ—Å–Ω–æ–≤–Ω—É—é –∫–æ–ª–ª–µ–∫—Ü–∏—é

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –ú—É–ª—å—Ç–∏—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç—å

‚ö†Ô∏è **–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:** –í—Å–µ —Å—É—â–Ω–æ—Å—Ç–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã –ø–æ `companyId`. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å middleware `extractTenant` –∏–∑ `apps/api/src/middlewares/tenant.ts` –¥–ª—è –≤—Å–µ—Ö endpoints.

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

- **ORM:** Prisma
- **–ë–∞–∑–∞:** PostgreSQL
- **–ú–∏–≥—Ä–∞—Ü–∏–∏:** –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –Ω–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

- **Backend:** `apps/api/src/modules/imports/` (–Ω–æ–≤—ã–π –º–æ–¥—É–ª—å)
- **Frontend:** `apps/web/src/features/bank-import/` (–Ω–æ–≤—ã–π feature)
- **Shared types:** `packages/shared/src/types/imports.ts`

---

## üóÑÔ∏è –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö

### 1. ImportSession (—Å–µ—Å—Å–∏—è –∏–º–ø–æ—Ä—Ç–∞)

–ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç —á–µ—Ä–Ω–æ–≤–∏–∫–∏ –æ–ø–µ—Ä–∞—Ü–∏–π –æ–¥–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞.

```prisma
model ImportSession {
  id            String   @id @default(uuid())
  companyId     String
  userId        String   // –∫—Ç–æ –∑–∞–≥—Ä—É–∑–∏–ª
  fileName      String
  status        String   @default("draft") // draft|confirmed|processed|canceled
  importedCount Int      @default(0) // –≤—Å–µ–≥–æ —Å—Ç—Ä–æ–∫ –∏–∑ —Ñ–∞–π–ª–∞
  confirmedCount Int     @default(0) // –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
  processedCount Int     @default(0) // —Å–æ–∑–¥–∞–Ω–æ –æ–ø–µ—Ä–∞—Ü–∏–π
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  company           Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  importedOperations ImportedOperation[]

  @@index([companyId, status])
  @@index([companyId, createdAt])
  @@map("import_sessions")
}
```

### 2. ImportedOperation (—á–µ—Ä–Ω–æ–≤–∏–∫ –æ–ø–µ—Ä–∞—Ü–∏–∏)

–í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–∑ –≤—ã–ø–∏—Å–∫–∏.

```prisma
model ImportedOperation {
  id                String   @id @default(uuid())
  importSessionId   String
  companyId         String

  // –î–∞–Ω–Ω—ã–µ –∏–∑ –≤—ã–ø–∏—Å–∫–∏
  date              DateTime
  number            String?  // –Ω–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞
  amount            Float
  description       String   // –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ–ü–ª–∞—Ç–µ–∂–∞
  direction         String   // income|expense|transfer

  // –ü–ª–∞—Ç–µ–ª—å—â–∏–∫
  payer             String?
  payerInn          String?
  payerAccount      String?  // –ü–ª–∞—Ç–µ–ª—å—â–∏–∫–°—á–µ—Ç

  // –ü–æ–ª—É—á–∞—Ç–µ–ª—å
  receiver          String?
  receiverInn       String?
  receiverAccount   String?  // –ü–æ–ª—É—á–∞—Ç–µ–ª—å–°—á–µ—Ç

  // –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–≤—Ç–æ—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è
  matchedArticleId        String?
  matchedCounterpartyId   String?
  matchedAccountId        String?
  matchedBy               String?  // template|fuzzy|manual|null
  matchedRuleId           String?  // —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ

  // –°—Ç–∞—Ç—É—Å—ã
  confirmed         Boolean  @default(false)
  processed         Boolean  @default(false)
  draft             Boolean  @default(true)

  // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  importSession     ImportSession @relation(fields: [importSessionId], references: [id], onDelete: Cascade)
  company           Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)

  matchedArticle      Article?      @relation(fields: [matchedArticleId], references: [id], onDelete: SetNull)
  matchedCounterparty Counterparty? @relation(fields: [matchedCounterpartyId], references: [id], onDelete: SetNull)
  matchedAccount      Account?      @relation(fields: [matchedAccountId], references: [id], onDelete: SetNull)
  matchedRule         MappingRule?  @relation(fields: [matchedRuleId], references: [id], onDelete: SetNull)

  @@index([companyId, importSessionId])
  @@index([companyId, confirmed, processed])
  @@index([importSessionId])
  @@map("imported_operations")
}
```

### 3. MappingRule (–ø—Ä–∞–≤–∏–ª–æ –º–∞–ø–ø–∏–Ω–≥–∞)

–ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.

```prisma
model MappingRule {
  id          String   @id @default(uuid())
  companyId   String
  userId      String   // –∫—Ç–æ —Å–æ–∑–¥–∞–ª –ø—Ä–∞–≤–∏–ª–æ

  ruleType    String   // contains|equals|regex|alias
  pattern     String   // —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞
  targetType  String   // article|counterparty|account|operationType
  targetId    String?  // ID —Å—É—â–Ω–æ—Å—Ç–∏ (–µ—Å–ª–∏ null, —Ç–æ targetName –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è)
  targetName  String?  // —á–∏—Ç–∞–µ–º–æ–µ –∏–º—è –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞

  sourceField String   @default("description") // description|receiver|payer|inn

  usageCount  Int      @default(0)
  lastUsedAt  DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company           Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  importedOperations ImportedOperation[]

  @@index([companyId, ruleType, sourceField])
  @@index([companyId, targetType])
  @@map("mapping_rules")
}
```

### 4. Company (–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ)

‚ö†Ô∏è **–¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ò–ù–ù –∫–æ–º–ø–∞–Ω–∏–∏** (–¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π):

```prisma
model Company {
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è
  inn         String?  // –ò–ù–ù –∫–æ–º–ø–∞–Ω–∏–∏ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
}
```

---

## üîÑ API Endpoints

### Backend: `apps/api/src/modules/imports/`

#### 1. –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏

```
POST /api/imports/upload
Content-Type: multipart/form-data

Request:
  file: File (.txt)
  companyId: string (–∏–∑ middleware)

Response:
{
  sessionId: string
  importedCount: number
  fileName: string
}
```

**–õ–æ–≥–∏–∫–∞:**

- –ü–∞—Ä—Å–∏—Ç —Ñ–∞–π–ª —Ñ–æ—Ä–º–∞—Ç–∞ 1–° ClientBankExchange
- –°–æ–∑–¥–∞–µ—Ç `ImportSession` —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `draft`
- –î–ª—è –∫–∞–∂–¥–æ–π `–°–µ–∫—Ü–∏—è–î–æ–∫—É–º–µ–Ω—Ç=–ü–ª–∞—Ç–µ–∂–Ω–æ–µ –ø–æ—Ä—É—á–µ–Ω–∏–µ` —Å–æ–∑–¥–∞–µ—Ç `ImportedOperation`
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç –∞–≤—Ç–æ—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ (—Å–º. —Ä–∞–∑–¥–µ–ª "–ê–≤—Ç–æ—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ")
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç ID —Å–µ—Å—Å–∏–∏ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π

#### 2. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤ –æ–ø–µ—Ä–∞—Ü–∏–∏

```
GET /api/imports/sessions/:sessionId/operations
Query params:
  limit?: number (default: 20)
  offset?: number (default: 0)
  confirmed?: boolean
  matched?: boolean (true = —Ç–æ–ª—å–∫–æ —Å –∞–≤—Ç–æ—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ–º, false = —Ç–æ–ª—å–∫–æ –±–µ–∑)

Response:
{
  operations: ImportedOperation[]
  total: number
  confirmed: number
  unmatched: number
}
```

#### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏

```
PATCH /api/imports/operations/:id

Request:
{
  matchedArticleId?: string | null
  matchedCounterpartyId?: string | null
  matchedAccountId?: string | null
  confirmed?: boolean
  direction?: "income" | "expense" | "transfer"
}

Response: ImportedOperation
```

#### 4. –ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤

```
PATCH /api/imports/sessions/:sessionId/operations/bulk

Request:
{
  operationIds: string[]
  matchedArticleId?: string | null
  matchedCounterpartyId?: string | null
  matchedAccountId?: string | null
  confirmed?: boolean
}

Response:
{
  updated: number
}
```

#### 5. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª –º–∞–ø–ø–∏–Ω–≥–∞

```
POST /api/imports/sessions/:sessionId/apply-rules

Response:
{
  applied: number
  updated: number
}
```

#### 6. –ò–º–ø–æ—Ä—Ç –æ–ø–µ—Ä–∞—Ü–∏–π (—Å–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π)

```
POST /api/imports/sessions/:sessionId/import

Request:
{
  operationIds?: string[] // –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ, –∏–º–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –≤—Å–µ confirmed=true
}

Response:
{
  imported: number
  created: number
  sessionId: string
}
```

**–õ–æ–≥–∏–∫–∞:**

- –ë–µ—Ä–µ—Ç –≤—Å–µ `ImportedOperation` —Å `confirmed=true` –∏–∑ —Å–µ—Å—Å–∏–∏
- –î–ª—è –∫–∞–∂–¥–æ–π —Å–æ–∑–¥–∞–µ—Ç `Operation` –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ
- –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–µ `Article` –∏–ª–∏ `Counterparty` (–µ—Å–ª–∏ `targetId` –±—ã–ª null, –Ω–æ `targetName` —É–∫–∞–∑–∞–Ω)
- –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—á–µ—Ç—á–∏–∫–∏ –≤ `ImportSession`
- –ü–æ–º–µ—á–∞–µ—Ç `ImportedOperation` –∫–∞–∫ `processed=true`
- –û–±–Ω–æ–≤–ª—è–µ—Ç `ImportSession.status` –Ω–∞ `processed`

#### 7. –û—Ç–º–µ–Ω–∞ –∏–º–ø–æ—Ä—Ç–∞

```
DELETE /api/imports/sessions/:sessionId

Response:
{
  deleted: number
}
```

**–õ–æ–≥–∏–∫–∞:**

- –£–¥–∞–ª—è–µ—Ç –≤—Å–µ `ImportedOperation` —Å–µ—Å—Å–∏–∏
- –£–¥–∞–ª—è–µ—Ç `ImportSession`
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π

#### 8. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞–º–∏ –º–∞–ø–ø–∏–Ω–≥–∞

```
GET /api/imports/rules
Query params:
  targetType?: string
  sourceField?: string

Response: MappingRule[]

POST /api/imports/rules
Request:
{
  ruleType: "contains" | "equals" | "regex" | "alias"
  pattern: string
  targetType: "article" | "counterparty" | "account" | "operationType"
  targetId?: string
  targetName?: string
  sourceField?: "description" | "receiver" | "payer" | "inn"
}

Response: MappingRule

PATCH /api/imports/rules/:id
Request: Partial<MappingRule>

DELETE /api/imports/rules/:id
```

#### 9. –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –∏–º–ø–æ—Ä—Ç–æ–≤

```
GET /api/imports/sessions
Query params:
  status?: string
  limit?: number
  offset?: number

Response:
{
  sessions: ImportSession[]
  total: number
}
```

---

## üîç –õ–æ–≥–∏–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ñ–∞–π–ª–∞ 1–° ClientBankExchange

### –§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞

–§–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–µ–∫—Ü–∏–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –∫–ª—é—á=–∑–Ω–∞—á–µ–Ω–∏–µ:

```
1CClientBankExchange
–í–µ—Ä—Å–∏—è–§–æ—Ä–º–∞—Ç–∞=1.03
–ö–æ–¥–∏—Ä–æ–≤–∫–∞=Windows
–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å=–ë–∞–Ω–∫
–î–∞—Ç–∞–°–æ–∑–¥–∞–Ω–∏—è=24.10.2025
–í—Ä–µ–º—è–°–æ–∑–¥–∞–Ω–∏—è=10:30:00

–°–µ–∫—Ü–∏—è–î–æ–∫—É–º–µ–Ω—Ç=–ü–ª–∞—Ç–µ–∂–Ω–æ–µ –ø–æ—Ä—É—á–µ–Ω–∏–µ
–ù–æ–º–µ—Ä=115
–î–∞—Ç–∞=24.10.2025
–°—É–º–º–∞=8263.00
–ü–ª–∞—Ç–µ–ª—å—â–∏–∫–°—á–µ—Ç=40702810068000001468
–ü–ª–∞—Ç–µ–ª—å—â–∏–∫=–û–û–û –ê–ö–°–û–ù
–ü–ª–∞—Ç–µ–ª—å—â–∏–∫–ò–ù–ù=5262382878
–ü–ª–∞—Ç–µ–ª—å—â–∏–∫–ö–ü–ü=526201001
–ü–æ–ª—É—á–∞—Ç–µ–ª—å–°—á–µ—Ç=03100643000000018500
–ü–æ–ª—É—á–∞—Ç–µ–ª—å=–§–ù–° –†–æ—Å—Å–∏–∏
–ü–æ–ª—É—á–∞—Ç–µ–ª—å–ò–ù–ù=7727406020
–ü–æ–ª—É—á–∞—Ç–µ–ª—å–ö–ü–ü=0
–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ–ü–ª–∞—Ç–µ–∂–∞=–ï–¥–∏–Ω—ã–π –Ω–∞–ª–æ–≥–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂
–ö–æ–Ω–µ—Ü–î–æ–∫—É–º–µ–Ω—Ç–∞

–°–µ–∫—Ü–∏—è–î–æ–∫—É–º–µ–Ω—Ç=–ü–ª–∞—Ç–µ–∂–Ω–æ–µ –ø–æ—Ä—É—á–µ–Ω–∏–µ
...
–ö–æ–Ω–µ—Ü–î–æ–∫—É–º–µ–Ω—Ç–∞
```

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞—Ä—Å–µ—Ä–∞

**–§–∞–π–ª:** `apps/api/src/modules/imports/parsers/clientBankExchange.parser.ts`

```typescript
interface ParsedDocument {
  date: Date;
  number?: string;
  amount: number;
  payer?: string;
  payerInn?: string;
  payerAccount?: string;
  receiver?: string;
  receiverInn?: string;
  receiverAccount?: string;
  purpose?: string;
}

export function parseClientBankExchange(content: string): ParsedDocument[] {
  // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞
  // 1. –†–∞–∑–±–∏—Ç—å –Ω–∞ —Å–µ–∫—Ü–∏–∏
  // 2. –î–ª—è –∫–∞–∂–¥–æ–π "–°–µ–∫—Ü–∏—è–î–æ–∫—É–º–µ–Ω—Ç=–ü–ª–∞—Ç–µ–∂–Ω–æ–µ –ø–æ—Ä—É—á–µ–Ω–∏–µ" –∏–∑–≤–ª–µ—á—å –ø–æ–ª—è
  // 3. –í–µ—Ä–Ω—É—Ç—å –º–∞—Å—Å–∏–≤ ParsedDocument
}
```

---

## üéØ –õ–æ–≥–∏–∫–∞ –∞–≤—Ç–æ—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è

### –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏

**–§–∞–π–ª:** `apps/api/src/modules/imports/services/matching.service.ts`

```typescript
async function determineDirection(
  payerInn: string | null,
  receiverInn: string | null,
  companyInn: string | null
): Promise<'income' | 'expense' | 'transfer'> {
  if (!companyInn) {
    // –ï—Å–ª–∏ –ò–ù–ù –∫–æ–º–ø–∞–Ω–∏–∏ –Ω–µ —É–∫–∞–∑–∞–Ω, —Ç—Ä–µ–±—É–µ–º —Ä—É—á–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞
    throw new AppError('Company INN not configured', 400);
  }

  if (payerInn === companyInn && receiverInn === companyInn) {
    return 'transfer';
  }
  if (payerInn === companyInn) {
    return 'expense';
  }
  if (receiverInn === companyInn) {
    return 'income';
  }

  // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é - —Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞
  throw new AppError('Cannot determine direction', 400);
}
```

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è

1. **–ü–æ –ò–ù–ù –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞** (100% —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ)
   - –ï—Å–ª–∏ `payerInn` –∏–ª–∏ `receiverInn` –Ω–∞–π–¥–µ–Ω–æ –≤ `Counterparty.inn` ‚Üí `matchedCounterpartyId`
2. **–ü–æ –ø—Ä–∞–≤–∏–ª–∞–º –º–∞–ø–ø–∏–Ω–≥–∞** (`MappingRule`)
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∏–ª –ø–æ —Ç–∏–ø—É `alias` (–¥–ª—è –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤)
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∏–ª –ø–æ —Ç–∏–ø—É `contains`/`equals`/`regex` (–¥–ª—è —Å—Ç–∞—Ç–µ–π –ø–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—é)
3. **–ü–æ fuzzy match –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞** (–µ—Å–ª–∏ –Ω–µ—Ç –ò–ù–ù)
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É —Ç–∏–ø–∞ `fuse.js` –∏–ª–∏ `string-similarity`
   - –ü–æ—Ä–æ–≥ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è: ‚â• 0.8
4. **–ü–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º –≤ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞** (–¥–ª—è —Å—Ç–∞—Ç–µ–π)
   - –ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞:
     - "–Ω–∞–ª–æ–≥", "–§–ù–°", "–ü–§–†", "–§–°–°" ‚Üí —Å—Ç–∞—Ç—å—è "–ù–∞–ª–æ–≥–∏"
     - "–∑–∞—Ä–ø–ª–∞—Ç–∞", "–æ—Ç–ø—É—Å–∫–Ω—ã–µ", "–∞–≤–∞–Ω—Å" ‚Üí —Å—Ç–∞—Ç—å—è "–ó–∞—Ä–ø–ª–∞—Ç–∞"
     - "–æ–ø–ª–∞—Ç–∞ –ø–æ —Å—á–µ—Ç—É", "–≤—ã—Ä—É—á–∫–∞" ‚Üí —Å—Ç–∞—Ç—å—è "–í—ã—Ä—É—á–∫–∞ –æ—Ç –ø—Ä–æ–¥–∞–∂"
5. **–ü–æ –Ω–æ–º–µ—Ä—É —Å—á–µ—Ç–∞** (–¥–ª—è —Å—á–µ—Ç–æ–≤)
   - –ï—Å–ª–∏ `payerAccount` –∏–ª–∏ `receiverAccount` –Ω–∞–π–¥–µ–Ω–æ –≤ `Account.number` ‚Üí `matchedAccountId`

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∞–≤—Ç–æ—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è

```typescript
async function autoMatch(
  companyId: string,
  operation: ParsedDocument,
  companyInn: string | null
): Promise<{
  matchedArticleId?: string;
  matchedCounterpartyId?: string;
  matchedAccountId?: string;
  matchedBy?: string;
  matchedRuleId?: string;
  direction: 'income' | 'expense' | 'transfer';
}> {
  // 1. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
  const direction = await determineDirection(
    operation.payerInn,
    operation.receiverInn,
    companyInn
  );

  // 2. –°–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞
  const counterparty = await matchCounterparty(companyId, operation);

  // 3. –°–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—å—é
  const article = await matchArticle(companyId, operation, direction);

  // 4. –°–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å —Å—á–µ—Ç
  const account = await matchAccount(companyId, operation, direction);

  return {
    matchedArticleId: article?.id,
    matchedCounterpartyId: counterparty?.id,
    matchedAccountId: account?.id,
    matchedBy:
      counterparty?.matchedBy || article?.matchedBy || account?.matchedBy,
    matchedRuleId: counterparty?.ruleId || article?.ruleId || account?.ruleId,
    direction,
  };
}
```

---

## üé® Frontend: UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

```
apps/web/src/features/bank-import/
‚îú‚îÄ‚îÄ BankImportModal.tsx          # –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–º–ø–æ—Ä—Ç–∞
‚îú‚îÄ‚îÄ ImportMappingTable.tsx       # –¢–∞–±–ª–∏—Ü–∞ –º–∞–ø–ø–∏–Ω–≥–∞
‚îú‚îÄ‚îÄ ImportMappingRow.tsx         # –°—Ç—Ä–æ–∫–∞ —Ç–∞–±–ª–∏—Ü—ã (—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–∞—è)
‚îú‚îÄ‚îÄ MappingRuleDialog.tsx        # –î–∏–∞–ª–æ–≥ —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª–∞
‚îú‚îÄ‚îÄ ImportHistory.tsx            # –ò—Å—Ç–æ—Ä–∏—è –∏–º–ø–æ—Ä—Ç–æ–≤
‚îî‚îÄ‚îÄ hooks/
    ‚îú‚îÄ‚îÄ useBankImport.ts         # –•—É–∫ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–º–ø–æ—Ä—Ç–æ–º
    ‚îî‚îÄ‚îÄ useMappingRules.ts       # –•—É–∫ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏
```

### 1. –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–º–ø–æ—Ä—Ç–∞

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:** `BankImportModal.tsx`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**

- Drag-and-drop –∑–æ–Ω–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
- –ö–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
- –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ ‚Üí –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —ç–∫—Ä–∞–Ω –º–∞–ø–ø–∏–Ω–≥–∞

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**

- –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–ò–º–ø–æ—Ä—Ç –≤—ã–ø–∏—Å–∫–∏" –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ `OperationsPage.tsx`

### 2. –¢–∞–±–ª–∏—Ü–∞ –º–∞–ø–ø–∏–Ω–≥–∞

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:** `ImportMappingTable.tsx`

**–ö–æ–ª–æ–Ω–∫–∏:**

- ‚òëÔ∏è –ß–µ–∫–±–æ–∫—Å (–¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π)
- ‚Ññ (–Ω–æ–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞)
- –î–∞—Ç–∞
- –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
- –°—É–º–º–∞ (—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è)
- –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (badge: –î–æ—Ö–æ–¥/–†–∞—Å—Ö–æ–¥/–ü–µ—Ä–µ–≤–æ–¥)
- –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç (—Å–µ–ª–µ–∫—Ç —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Å–æ–∑–¥–∞–Ω–∏—è)
- –°—Ç–∞—Ç—å—è (—Å–µ–ª–µ–∫—Ç —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Å–æ–∑–¥–∞–Ω–∏—è)
- –°—á—ë—Ç (—Å–µ–ª–µ–∫—Ç, –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ)
- –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ (–∏–∫–æ–Ω–∫–∞: —à–∞–±–ª–æ–Ω –Ω–∞–π–¥–µ–Ω ‚úÖ, —Ç—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è ‚ö†Ô∏è)

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**

- –ü–∞–≥–∏–Ω–∞—Ü–∏—è (20 —Å—Ç—Ä–æ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É)
- –§–∏–ª—å—Ç—Ä—ã:
  - "–¢–æ–ª—å–∫–æ –Ω–µ—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ"
  - "–ü–æ–∫–∞–∑–∞—Ç—å –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ"
  - "–¢–æ–ª—å–∫–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ"
- –ú–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:
  - –í—ã–¥–µ–ª–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å—Ç—Ä–æ–∫
  - –ö–Ω–æ–ø–∫–∞ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫ –≤—ã–±—Ä–∞–Ω–Ω—ã–º" (–∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç/—Å—Ç–∞—Ç—å—è/—Å—á–µ—Ç)
- –ö–Ω–æ–ø–∫–∏:
  - "–ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–∏—Ç—å –ø–æ —à–∞–±–ª–æ–Ω–∞–º"
  - "–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏" (—Ç–æ–ª—å–∫–æ confirmed=true)
  - "–û—Ç–º–µ–Ω–∏—Ç—å"
  - "–≠–∫—Å–ø–æ—Ä—Ç —à–∞–±–ª–æ–Ω–æ–≤" (JSON)

### 3. –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–∞—è —Å—Ç—Ä–æ–∫–∞

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:** `ImportMappingRow.tsx`

**–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**

- –ö–ª–∏–∫ –ø–æ —è—á–µ–π–∫–µ ‚Üí –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è inline-—Ä–µ–¥–∞–∫—Ç–æ—Ä –∏–ª–∏ dropdown
- –°–µ–ª–µ–∫—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏:
  - `useGetCounterpartiesQuery()`
  - `useGetArticlesQuery()`
  - `useGetAccountsQuery()`
- –ö–Ω–æ–ø–∫–∞ "+ —Å–æ–∑–¥–∞—Ç—å" –≤ —Å–µ–ª–µ–∫—Ç–∞—Ö
- –ß–µ–∫–±–æ–∫—Å "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ" –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏

### 4. –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –º–∞–ø–ø–∏–Ω–≥–∞

**–î–∏–∞–ª–æ–≥:** `MappingRuleDialog.tsx`

**–ü–æ–ª—è:**

- –ì–¥–µ –∏—Å–∫–∞—Ç—å: —Å–µ–ª–µ–∫—Ç (–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ / –ò–º—è –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ / –ò–ù–ù)
- –¢–∏–ø –ø–æ–∏—Å–∫–∞: —Å–µ–ª–µ–∫—Ç (–°–æ–¥–µ—Ä–∂–∏—Ç / –°–æ–≤–ø–∞–¥–∞–µ—Ç / –†–µ–≥—É–ª—è—Ä–∫–∞ / –ü—Å–µ–≤–¥–æ–Ω–∏–º)
- –¢–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞: input (–∞–≤—Ç–æ–ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–∑ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–æ–∫–∏)
- –°–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å —Å: —Å–µ–ª–µ–∫—Ç (–°—Ç–∞—Ç—å—è / –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç / –°—á–µ—Ç)
- –í—ã–±–æ—Ä –∑–Ω–∞—á–µ–Ω–∏—è: —Å–µ–ª–µ–∫—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∏–ª–∏ input –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ

### 5. RTK Query endpoints

**–§–∞–π–ª:** `apps/web/src/store/api/importsApi.ts`

```typescript
export const importsApi = apiSlice.injectEndpoints({
  endpoints: (builder) => ({
    uploadStatement: builder.mutation<
      { sessionId: string; importedCount: number },
      FormData
    >({
      query: (formData) => ({
        url: '/imports/upload',
        method: 'POST',
        body: formData,
      }),
    }),
    getImportedOperations: builder.query<
      { operations: ImportedOperation[]; total: number },
      { sessionId: string; params?: any }
    >({
      query: ({ sessionId, params }) => ({
        url: `/imports/sessions/${sessionId}/operations`,
        params,
      }),
    }),
    updateImportedOperation: builder.mutation<
      ImportedOperation,
      { id: string; data: Partial<ImportedOperation> }
    >({
      query: ({ id, data }) => ({
        url: `/imports/operations/${id}`,
        method: 'PATCH',
        body: data,
      }),
    }),
    bulkUpdateImportedOperations: builder.mutation<
      { updated: number },
      { sessionId: string; data: any }
    >({
      query: ({ sessionId, data }) => ({
        url: `/imports/sessions/${sessionId}/operations/bulk`,
        method: 'PATCH',
        body: data,
      }),
    }),
    importOperations: builder.mutation<
      { imported: number },
      { sessionId: string; operationIds?: string[] }
    >({
      query: ({ sessionId, operationIds }) => ({
        url: `/imports/sessions/${sessionId}/import`,
        method: 'POST',
        body: { operationIds },
      }),
      invalidatesTags: ['Operation', 'Dashboard', 'Report'],
    }),
    getMappingRules: builder.query<MappingRule[], any>({
      query: (params) => ({
        url: '/imports/rules',
        params,
      }),
    }),
    createMappingRule: builder.mutation<MappingRule, Partial<MappingRule>>({
      query: (data) => ({
        url: '/imports/rules',
        method: 'POST',
        body: data,
      }),
    }),
    // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ endpoints
  }),
});
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è

### –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∞–π–ª–∞

- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ —Ñ–∞–π–ª–∞ (–¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å `1CClientBankExchange`)
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: 10MB
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —Ñ–∞–π–ª–µ: 1000
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∏—Ä–æ–≤–∫–∏ (Windows-1251, UTF-8)

### –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

- –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π (–¥–∞—Ç–∞, —Å—É–º–º–∞)
- –í–∞–ª–∏–¥–∞—Ü–∏—è –ò–ù–ù (10 –∏–ª–∏ 12 —Ü–∏—Ñ—Ä)
- –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–æ–º–µ—Ä–æ–≤ —Å—á–µ—Ç–æ–≤ (20 —Ü–∏—Ñ—Ä)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É–º–º—ã (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º)

### –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞

- –¢–æ–ª—å–∫–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
- –î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –∫ –¥–∞–Ω–Ω—ã–º —Å–≤–æ–µ–π –∫–æ–º–ø–∞–Ω–∏–∏ (`companyId` –∏–∑ middleware)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π –∏–º–ø–æ—Ä—Ç–∞

---

## üìù –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Unit —Ç–µ—Å—Ç—ã

- –ü–∞—Ä—Å–µ—Ä —Ñ–∞–π–ª–∞ 1–° ClientBankExchange
- –õ–æ–≥–∏–∫–∞ –∞–≤—Ç–æ—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏

### Integration —Ç–µ—Å—Ç—ã

- Endpoints API
- –°–æ–∑–¥–∞–Ω–∏–µ –∏ –∏–º–ø–æ—Ä—Ç –æ–ø–µ—Ä–∞—Ü–∏–π
- –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª –º–∞–ø–ø–∏–Ω–≥–∞

### E2E —Ç–µ—Å—Ç—ã (Playwright)

- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞–ø–ø–∏–Ω–≥–∞
- –ò–º–ø–æ—Ä—Ç –æ–ø–µ—Ä–∞—Ü–∏–π

---

## üöÄ –≠—Ç–∞–ø—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –≠—Ç–∞–ø 1: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –ø–∞—Ä—Å–∏–Ω–≥

- [ ] –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –Ω–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü (`ImportSession`, `ImportedOperation`, `MappingRule`)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `inn` –≤ –º–æ–¥–µ–ª—å `Company`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–∞—Ä—Å–µ—Ä —Ñ–∞–π–ª–∞ 1–° ClientBankExchange
- [ ] –ù–∞–ø–∏—Å–∞—Ç—å unit-—Ç–µ—Å—Ç—ã –¥–ª—è –ø–∞—Ä—Å–µ—Ä–∞

### –≠—Ç–∞–ø 2: Backend API

- [ ] –°–æ–∑–¥–∞—Ç—å –º–æ–¥—É–ª—å `apps/api/src/modules/imports/`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å –∞–≤—Ç–æ—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å endpoints –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–º–ø–æ—Ä—Ç–æ–º
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å endpoints –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª–∞–º–∏
- [ ] –ù–∞–ø–∏—Å–∞—Ç—å integration-—Ç–µ—Å—Ç—ã

### –≠—Ç–∞–ø 3: Frontend UI

- [ ] –°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç `BankImportModal`
- [ ] –°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç `ImportMappingTable`
- [ ] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ `OperationsPage`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª –º–∞–ø–ø–∏–Ω–≥–∞
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∏–º–ø–æ—Ä—Ç–æ–≤

### –≠—Ç–∞–ø 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–æ—Ä–∞–±–æ—Ç–∫–∞

- [ ] –ù–∞–ø–∏—Å–∞—Ç—å E2E —Ç–µ—Å—Ç—ã
- [ ] –ü—Ä–æ–≤–µ—Å—Ç–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- [ ] –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤)
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API (Swagger)

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

### –ü—Ä–∏–º–µ—Ä—ã —Ñ–∞–π–ª–æ–≤

–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã –≤ `apps/api/src/modules/imports/__tests__/fixtures/`:

- `sample-statement.txt` - –ø—Ä–∏–º–µ—Ä –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –≤—ã–ø–∏—Å–∫–∏
- `sample-statement-large.txt` - –±–æ–ª—å—à–æ–π —Ñ–∞–π–ª (100+ –æ–ø–µ—Ä–∞—Ü–∏–π)
- `sample-statement-invalid.txt` - —Ñ–∞–π–ª —Å –æ—à–∏–±–∫–∞–º–∏

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ 1–°

–°—Å—ã–ª–∫–∞ –Ω–∞ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é —Ñ–æ—Ä–º–∞—Ç–∞ 1–° ClientBankExchange (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞)

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ú—É–ª—å—Ç–∏—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç—å:** –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –¥–æ–ª–∂–Ω—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å—Å—è –ø–æ `companyId`. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å middleware `extractTenant` –ø–µ—Ä–µ–¥ –≤—Å–µ–º–∏ —Ä–æ—É—Ç–∞–º–∏.

2. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
   - –î–ª—è —Ñ–∞–π–ª–æ–≤ —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –æ–ø–µ—Ä–∞—Ü–∏–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞–≥–∏–Ω–∞—Ü–∏—é
   - –ú–∞—Å—Å–æ–≤—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω—è—Ç—å —á–µ—Ä–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
   - –ò–Ω–¥–µ–∫—Å—ã –Ω–∞ `companyId` –∏ `importSessionId` –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã

3. **–û—Ç–∫–∞—Ç:** –ü—Ä–∏ –æ—Ç–º–µ–Ω–µ –∏–º–ø–æ—Ä—Ç–∞ –≤—Å–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∏ –¥–æ–ª–∂–Ω—ã —É–¥–∞–ª—è—Ç—å—Å—è –±–µ–∑ —Å–æ–∑–¥–∞–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π.

4. **–ò–ù–ù –∫–æ–º–ø–∞–Ω–∏–∏:** –ï—Å–ª–∏ –ò–ù–ù –∫–æ–º–ø–∞–Ω–∏–∏ –Ω–µ —É–∫–∞–∑–∞–Ω, —Å–∏—Å—Ç–µ–º–∞ –¥–æ–ª–∂–Ω–∞ —Ç—Ä–µ–±–æ–≤–∞—Ç—å —Ä—É—á–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏.

5. **–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π:** –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤—ã—Ö —Å—Ç–∞—Ç–µ–π/–∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ –∏–∑ –ø—Ä–∞–≤–∏–ª –º–∞–ø–ø–∏–Ω–≥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ DTO –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—é.

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏–µ–º–∫–∏

- [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª –≤—ã–ø–∏—Å–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∞ 1–° ClientBankExchange
- [ ] –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–∞—Ä—Å–∏—Ç —Ñ–∞–π–ª –∏ —Å–æ–∑–¥–∞–µ—Ç —á–µ—Ä–Ω–æ–≤–∏–∫–∏ –æ–ø–µ—Ä–∞—Ü–∏–π
- [ ] –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ –ø–æ –ò–ù–ù
- [ ] –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—å–∏ –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º –∏ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
- [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∞–ø–ø–∏–Ω–≥ –≤ —Ç–∞–±–ª–∏—Ü–µ
- [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã –∏ —Å—Ç–∞—Ç—å–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –º–∞–ø–ø–∏–Ω–≥–∞
- [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –º–∞–ø–ø–∏–Ω–≥–∞
- [ ] –ü—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∏–º–ø–æ—Ä—Ç–µ
- [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- [ ] –ü–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞ —Å–æ–∑–¥–∞—é—Ç—Å—è —Ä–µ–∞–ª—å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ `operations`
- [ ] –í—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã –ø–æ `companyId`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è –∏–º–ø–æ—Ä—Ç–æ–≤

---

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `inn` –≤ –º–æ–¥–µ–ª—å `Company`
