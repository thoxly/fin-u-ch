# Решение проблем с WORKER_API_KEY и ENCRYPTION_KEY

## Проблема 1: API возвращает 401 "Invalid or expired token"

### Симптомы:

```
API error 401: {"status":"error","message":"Invalid or expired token"}
```

### Причина:

API не загрузил `WORKER_API_KEY` из `.env` или ключи не совпадают между worker и API.

### Решение:

1. **Проверьте, что ключи загружены в API:**
   - Перезапустите API сервер
   - Проверьте логи при запуске - должны увидеть:
     ```
     ✅ API: .env файл загружен из: ...
     ✅ API: WORKER_API_KEY загружен (длина: 64)
     ```

2. **Проверьте, что ключи совпадают:**
   - Убедитесь, что `WORKER_API_KEY` в `.env` одинаковый для API и Worker
   - Проверьте, что нет лишних пробелов или переносов строк

3. **Проверьте логи API при запросе:**
   - В dev режиме API покажет диагностику:
     ```
     [Auth] WORKER_API_KEY mismatch: { receivedLength: ..., expectedLength: ... }
     ```

## Проблема 2: Ошибка расшифровки "Unsupported state or unable to authenticate data"

### Симптомы:

```
Ошибка при расшифровке: Unsupported state or unable to authenticate data
❌ Не удалось расшифровать apiKey - возвращено исходное значение
```

### Причина:

`apiKey` в базе данных был зашифрован другим `ENCRYPTION_KEY`, чем тот, который сейчас используется.

### Решение:

**Вариант 1: Пересоздать интеграцию (рекомендуется)**

1. Откройте страницу компании → вкладка "Интеграции"
2. Отключите текущую интеграцию Ozon (кнопка "Отключить")
3. Включите заново и введите:
   - `Client-Key` (если нужно)
   - `Api-Key` (обязательно - введите заново)
   - Остальные настройки (статья, счет, график выплат)

После этого `apiKey` будет зашифрован текущим `ENCRYPTION_KEY`, и расшифровка будет работать.

**Вариант 2: Использовать скрипт перешифровки**

Если у вас есть старый `ENCRYPTION_KEY`:

1. Временно замените `ENCRYPTION_KEY` в `.env` на старый ключ
2. Перезапустите API и Worker
3. Запустите скрипт: `pnpm tsx scripts/re-encrypt-ozon-api-keys.ts`
4. Верните новый `ENCRYPTION_KEY` в `.env`
5. Снова перезапустите серверы

## Проверка работоспособности

После исправления проверьте:

1. ✅ **API загружает ключи:**

   ```
   ✅ API: WORKER_API_KEY загружен (длина: 64)
   ✅ API: ENCRYPTION_KEY загружен (длина: 64)
   ```

2. ✅ **Worker загружает ключи:**

   ```
   ✅ WORKER_API_KEY загружен вручную (длина: 64)
   ✅ ENCRYPTION_KEY загружен вручную (длина: 64)
   ```

3. ✅ **API принимает запросы от Worker:**

   ```
   ✅ API доступен, используем API режим
   ```

   (вместо `⚠️ API недоступен, переключаемся на прямой режим`)

4. ✅ **Worker может расшифровать apiKey:**
   ```
   ✅ apiKey успешно расшифрован (длина: XX)
   ```
   (вместо `❌ Ошибка при расшифровке`)

## Быстрая диагностика

Запустите worker вручную и проверьте логи:

```bash
cd apps/worker
pnpm ozon-now
```

Должны увидеть:

- ✅ WORKER_API_KEY загружен
- ✅ ENCRYPTION_KEY загружен
- ✅ API доступен (или ⚠️ переключение на прямой режим)
- ✅ apiKey успешно расшифрован
- ✅ Операция создана

Если видите ошибки - следуйте инструкциям выше для их решения.
