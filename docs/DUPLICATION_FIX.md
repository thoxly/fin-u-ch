# Исправление дублирования операций в интерфейсе

## Проблема

При добавлении операции в интерфейсе появлялась дублирующая запись, хотя в базе данных сохранялась только одна операция.

## Причина

Проблема возникала из-за конфликта между:

1. Автоматической инвалидацией кеша RTK Query при создании/обновлении операций
2. Ручным управлением состоянием с бесконечной прокруткой на странице `OperationsPage`

Когда создавалась операция:

- Мутация `createOperation` инвалидировала тег `'Operation'`
- RTK Query автоматически запускал refetch для ВСЕХ запросов с этим тегом
- Это включало пагинированные запросы на `OperationsPage`
- Автоматическое обновление кеша конфликтовало с ручным управлением стейтом `items`

## Решение

### 1. Изменена логика тегов в `operationsApi.ts`

Пагинированные запросы (с параметрами `limit`/`offset`) теперь используют специальный тег `{ type: 'Operation', id: 'PAGINATED' }`, который НЕ инвалидируется автоматически:

```typescript
providesTags: (result, error, params) => {
  // Если есть параметры limit/offset, это пагинация - не инвалидируем автоматически
  if (params && (params.limit !== undefined || params.offset !== undefined)) {
    return [{ type: 'Operation', id: 'PAGINATED' }];
  }
  // Для обычных запросов используем стандартный тег
  return ['Operation'];
},
```

Это предотвращает автоматический refetch пагинированных запросов при создании/обновлении операций.

### 2. Добавлено ручное обновление данных в `OperationsPage.tsx`

После выполнения операций, которые изменяют данные, добавлена явная перезагрузка:

- **После создания/редактирования** (в `handleCloseForm`): перезагружаем данные после закрытия формы
- **После удаления** (в `handleDelete`): перезагружаем данные после успешного удаления
- **После подтверждения** (в `handleConfirm`): перезагружаем данные после подтверждения операции

Это обеспечивает актуальность данных без дублирования.

## Файлы изменены

1. `apps/web/src/store/api/operationsApi.ts` - изменена логика тегов для пагинированных запросов
2. `apps/web/src/pages/OperationsPage.tsx` - добавлена ручная перезагрузка данных после операций

## Тестирование

Для проверки исправления:

1. Откройте страницу "Операции"
2. Создайте новую операцию
3. Убедитесь, что операция появляется в списке только один раз
4. Проверьте, что после редактирования, удаления и подтверждения операций данные корректно обновляются

## Дополнительные преимущества

- Пагинированные запросы больше не перезагружаются автоматически при каждом изменении операций
- Улучшена производительность страницы с бесконечной прокруткой
- Сохранена автоматическая инвалидация для непагинированных запросов (Dashboard, Reports)
