# –ü—Ä–æ–≥—Ä–µ—Å—Å –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã—Ö —É–ª—É—á—à–µ–Ω–∏–π

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ

### 1. –î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è `matching.service.ts` (1151 —Å—Ç—Ä–æ–∫–∞) - –ó–ê–í–ï–†–®–ï–ù–û

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–æ:**

```
matching.service.ts (1151 —Å—Ç—Ä–æ–∫–∞)
‚îú‚îÄ‚îÄ determineDirection()
‚îú‚îÄ‚îÄ matchCounterparty()
‚îú‚îÄ‚îÄ matchArticle() (—Å —Ö–∞—Ä–¥–∫–æ–¥–æ–º –ø—Ä–∞–≤–∏–ª)
‚îú‚îÄ‚îÄ matchAccount()
‚îî‚îÄ‚îÄ autoMatch()
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ—Å–ª–µ:**

```
matching/
‚îú‚îÄ‚îÄ matching.types.ts                    # –û–±—â–∏–µ —Ç–∏–ø—ã
‚îú‚îÄ‚îÄ auto-match.service.ts                # –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä)
‚îú‚îÄ‚îÄ direction/
‚îÇ   ‚îî‚îÄ‚îÄ direction-matcher.service.ts     # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
‚îú‚îÄ‚îÄ counterparty/
‚îÇ   ‚îú‚îÄ‚îÄ counterparty-matcher.service.ts      # –ì–ª–∞–≤–Ω—ã–π —Å–µ—Ä–≤–∏—Å
‚îÇ   ‚îú‚îÄ‚îÄ counterparty-rules-matcher.service.ts # –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º
‚îÇ   ‚îî‚îÄ‚îÄ counterparty-fuzzy-matcher.service.ts # Fuzzy match
‚îú‚îÄ‚îÄ article/
‚îÇ   ‚îú‚îÄ‚îÄ article-matcher.service.ts            # –ì–ª–∞–≤–Ω—ã–π —Å–µ—Ä–≤–∏—Å
‚îÇ   ‚îú‚îÄ‚îÄ article-rules-matcher.service.ts      # –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º
‚îÇ   ‚îú‚îÄ‚îÄ article-keyword-matcher.service.ts    # –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
‚îÇ   ‚îî‚îÄ‚îÄ keyword-rules.config.ts               # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∞–≤–∏–ª (–≤—ã–Ω–µ—Å–µ–Ω —Ö–∞—Ä–¥–∫–æ–¥)
‚îî‚îÄ‚îÄ account/
    ‚îî‚îÄ‚îÄ account-matcher.service.ts       # –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç–æ–≤
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**

- ‚úÖ –§–∞–π–ª —Ä–∞–∑–±–∏—Ç –Ω–∞ 11 –º–æ–¥—É–ª–µ–π
- ‚úÖ –•–∞—Ä–¥–∫–æ–¥ –ø—Ä–∞–≤–∏–ª –≤—ã–Ω–µ—Å–µ–Ω –≤ –∫–æ–Ω—Ñ–∏–≥ (`keyword-rules.config.ts`)
- ‚úÖ –ö–∞–∂–¥—ã–π –º–æ–¥—É–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ–¥–Ω—É –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —á–µ—Ä–µ–∑ —Ä–µ—ç–∫—Å–ø–æ—Ä—Ç –≤ —Å—Ç–∞—Ä–æ–º —Ñ–∞–π–ª–µ
- ‚úÖ –£–ª—É—á—à–µ–Ω–∞ —á–∏—Ç–∞–µ–º–æ—Å—Ç—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å –∫–æ–¥–∞

**–§–∞–π–ª—ã —Å–æ–∑–¥–∞–Ω—ã:**

1. `apps/api/src/modules/imports/services/matching/matching.types.ts`
2. `apps/api/src/modules/imports/services/matching/auto-match.service.ts`
3. `apps/api/src/modules/imports/services/matching/direction/direction-matcher.service.ts`
4. `apps/api/src/modules/imports/services/matching/counterparty/counterparty-matcher.service.ts`
5. `apps/api/src/modules/imports/services/matching/counterparty/counterparty-rules-matcher.service.ts`
6. `apps/api/src/modules/imports/services/matching/counterparty/counterparty-fuzzy-matcher.service.ts`
7. `apps/api/src/modules/imports/services/matching/article/article-matcher.service.ts`
8. `apps/api/src/modules/imports/services/matching/article/article-rules-matcher.service.ts`
9. `apps/api/src/modules/imports/services/matching/article/article-keyword-matcher.service.ts`
10. `apps/api/src/modules/imports/services/matching/article/keyword-rules.config.ts`
11. `apps/api/src/modules/imports/services/matching/account/account-matcher.service.ts`

**–û–±–Ω–æ–≤–ª–µ–Ω–æ:**

- `apps/api/src/modules/imports/services/matching.service.ts` - —Ç–µ–ø–µ—Ä—å —Ä–µ—ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –∏–∑ –Ω–æ–≤—ã—Ö –º–æ–¥—É–ª–µ–π –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

---

## üîÑ –í –ø—Ä–æ—Ü–µ—Å—Å–µ

### 2. –î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è `clientBankExchange.parser.ts` (~1357 —Å—Ç—Ä–æ–∫)

**–ü–ª–∞–Ω –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏–∏:**

```
parsers/clientBankExchange/
‚îú‚îÄ‚îÄ parser.types.ts                      # ParsedDocument, ParsedFile ‚úÖ
‚îú‚îÄ‚îÄ parser.service.ts                    # –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è parseClientBankExchange
‚îú‚îÄ‚îÄ file-decoder.service.ts              # –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ (iconv)
‚îú‚îÄ‚îÄ header-parser.service.ts             # –ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Ñ–∞–π–ª–∞
‚îú‚îÄ‚îÄ document-parser.service.ts           # –ü–∞—Ä—Å–∏–Ω–≥ –æ–¥–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
‚îú‚îÄ‚îÄ document-validator.service.ts        # –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞
‚îî‚îÄ‚îÄ document-types.config.ts             # SUPPORTED_DOC_TYPES, KEY_MAPPING ‚úÖ
```

**–°—Ç–∞—Ç—É—Å:** –ß–∞—Å—Ç–∏—á–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ

- ‚úÖ –°–æ–∑–¥–∞–Ω—ã —Ç–∏–ø—ã (`parser.types.ts`)
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (`document-types.config.ts`)
- ‚è≥ –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ `parseClientBankExchange`
- ‚è≥ –¢—Ä–µ–±—É–µ—Ç—Å—è –≤—ã–Ω–µ—Å–µ–Ω–∏–µ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ü–æ–ª–Ω–∞—è –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è parser —Ç—Ä–µ–±—É–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±—ä–µ–º–∞ —Ä–∞–±–æ—Ç—ã –∏–∑-–∑–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∏ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω—è—Ç—å –ø–æ—ç—Ç–∞–ø–Ω–æ.

---

### 3. –î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è `imports.service.ts` (~1490 —Å—Ç—Ä–æ–∫)

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –º–µ—Ç–æ–¥—ã:**

- `uploadStatement()` - ~366 —Å—Ç—Ä–æ–∫ (–ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç 200 —Å—Ç—Ä–æ–∫)
- `importOperations()` - ~342 —Å—Ç—Ä–æ–∫–∏ (–ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç 150 —Å—Ç—Ä–æ–∫)

**–ü–ª–∞–Ω –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏–∏:**

```
imports/
‚îú‚îÄ‚îÄ imports.service.ts                   # –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä)
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ file-upload.service.ts           # uploadStatement —Ä–∞–∑–±–∏—Ç—å –Ω–∞:
‚îÇ   ‚îÇ                                     # - validateFile()
‚îÇ   ‚îÇ                                     # - parseFile()
‚îÇ   ‚îÇ                                     # - checkDuplicates()
‚îÇ   ‚îÇ                                     # - createImportSession()
‚îÇ   ‚îÇ                                     # - processBatches()
‚îÇ   ‚îî‚îÄ‚îÄ operation-import.service.ts      # importOperations —Ä–∞–∑–±–∏—Ç—å –Ω–∞:
‚îÇ                                         # - validateOperations()
‚îÇ                                         # - createOperationsBatch()
‚îÇ                                         # - saveMappingRules()
‚îÇ                                         # - handleTransferOperations()
```

**–°—Ç–∞—Ç—É—Å:** –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

---

## üìã –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è

### 4. –°–æ–∑–¥–∞—Ç—å –æ–±—â–∏–π –º–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞—Ç—á–∞–º–∏ - –ó–ê–í–ï–†–®–ï–ù–û

**–°–æ–∑–¥–∞–Ω–æ:**

```
apps/api/src/utils/batch/
‚îú‚îÄ‚îÄ batch-processor.ts                   # –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –±–∞—Ç—á–µ–π
‚îî‚îÄ‚îÄ batch.types.ts                       # –¢–∏–ø—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞—Ç—á–∞–º–∏
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**

- ‚úÖ –°–æ–∑–¥–∞–Ω —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π `BatchProcessor` –∫–ª–∞—Å—Å
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π Prisma
- ‚úÖ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –æ–ø—Ü–∏–∏ (batchSize, timeout, –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—à–∏–±–æ–∫)
- ‚úÖ –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞—Ç—á–∞–º–∏

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ

---

### 5. –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ - –ó–ê–í–ï–†–®–ï–ù–û

**–°–æ–∑–¥–∞–Ω–æ:**

```
apps/api/src/utils/error-handler/
‚îú‚îÄ‚îÄ error-handler.ts                     # handleBatchErrors, formatError, logError
‚îî‚îÄ‚îÄ error-handler.types.ts               # –¢–∏–ø—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**

- ‚úÖ –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
- ‚úÖ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ –±–∞—Ç—á–∞—Ö

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏

### –î–æ –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏–∏:

- `matching.service.ts`: **1151 —Å—Ç—Ä–æ–∫–∞** (1 —Ñ–∞–π–ª)
- –•–∞—Ä–¥–∫–æ–¥ –ø—Ä–∞–≤–∏–ª: **~186 —Å—Ç—Ä–æ–∫** –≤ –∫–æ–¥–µ

### –ü–æ—Å–ª–µ –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏–∏:

- `matching/`: **11 —Ñ–∞–π–ª–æ–≤**, —Å—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä ~100-200 —Å—Ç—Ä–æ–∫
- –•–∞—Ä–¥–∫–æ–¥ –ø—Ä–∞–≤–∏–ª: **–≤—ã–Ω–µ—Å–µ–Ω –≤ –∫–æ–Ω—Ñ–∏–≥** (`keyword-rules.config.ts`)

### –£–ª—É—á—à–µ–Ω–∏—è:

- ‚úÖ –£–º–µ–Ω—å—à–µ–Ω–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç—å —Ñ–∞–π–ª–æ–≤
- ‚úÖ –£–ª—É—á—à–µ–Ω–∞ —á–∏—Ç–∞–µ–º–æ—Å—Ç—å
- ‚úÖ –£–ø—Ä–æ—â–µ–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –£–ª—É—á—à–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å

---

## üîç –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ó–∞–≤–µ—Ä—à–∏—Ç—å –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—é parser** (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –≤—ã—Å–æ–∫–∏–π)
2. **–ó–∞–≤–µ—Ä—à–∏—Ç—å –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—é imports.service.ts** (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –≤—ã—Å–æ–∫–∏–π)
3. **–°–æ–∑–¥–∞—Ç—å –æ–±—â–∏–π –º–æ–¥—É–ª—å –¥–ª—è –±–∞—Ç—á–µ–π** (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: —Å—Ä–µ–¥–Ω–∏–π)
4. **–£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫** (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: —Å—Ä–µ–¥–Ω–∏–π)

---

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- –°—Ç–∞—Ä—ã–µ –∏–º–ø–æ—Ä—Ç—ã –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —á–µ—Ä–µ–∑ —Ä–µ—ç–∫—Å–ø–æ—Ä—Ç
- –ù–æ–≤—ã–π –∫–æ–¥ —Å–ª–µ–¥—É–µ—Ç –ø—Ä–∏–Ω—Ü–∏–ø–∞–º SOLID
- –ö–∞–∂–¥—ã–π –º–æ–¥—É–ª—å –∏–º–µ–µ—Ç –æ–¥–Ω—É –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å
