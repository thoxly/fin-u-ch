# Docker Cleanup Strategy

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –¥–∏—Å–∫–æ–≤—ã–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ–º Docker –Ω–∞ VPS.

## üéØ –ü—Ä–æ–±–ª–µ–º–∞

Docker –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ä–µ—Å—É—Ä—Å—ã –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –¥–µ–ø–ª–æ—è:

- **–°—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã** (–ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏)
- **–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã** (–µ—Å–ª–∏ –¥–µ–ø–ª–æ–π failed)
- **–ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ volumes**
- **Build cache**
- **Networks**

–ë–µ–∑ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ –¥–∏—Å–∫ –º–æ–∂–µ—Ç –∑–∞–ø–æ–ª–Ω–∏—Ç—å—Å—è.

## ‚úÖ –†–µ—à–µ–Ω–∏–µ: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π cleanup –≤ CI/CD

**–°—Ç—Ä–∞—Ç–µ–≥–∏—è**: Cleanup –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –¥–µ–ø–ª–æ—è –≤ production.

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

–ü—Ä–∏ –∫–∞–∂–¥–æ–º push –≤ `main`:

1. ‚úÖ –°–æ–±–∏—Ä–∞—é—Ç—Å—è –Ω–æ–≤—ã–µ Docker –æ–±—Ä–∞–∑—ã
2. ‚úÖ –û–±—Ä–∞–∑—ã –ø—É–±–ª–∏–∫—É—é—Ç—Å—è –≤ GHCR
3. ‚úÖ –î–µ–ø–ª–æ–π –Ω–∞ VPS:
   - Pull –Ω–æ–≤—ã—Ö –æ–±—Ä–∞–∑–æ–≤
   - –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
   - –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
   - –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
   - –ó–∞–ø—É—Å–∫ –Ω–æ–≤—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
   - **üßπ Cleanup –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤**

### –ß—Ç–æ —É–¥–∞–ª—è–µ—Ç—Å—è

```bash
# –í .github/workflows/ci-cd.yml (deploy job)

# 1. –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker container prune -f

# 2. –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –æ–±—Ä–∞–∑—ã —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π
docker image prune -af --filter "until=168h"

# 3. –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ volumes
docker volume prune -f

# 4. –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ networks
docker network prune -f
```

### –ß—Ç–æ –ù–ï —É–¥–∞–ª—è–µ—Ç—Å—è

- ‚úÖ **–ó–∞–ø—É—â–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã** - —Ä–∞–±–æ—Ç–∞—é—Ç –¥–∞–ª—å—à–µ
- ‚úÖ **–û–±—Ä–∞–∑—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏** - –æ—Å—Ç–∞—é—Ç—Å—è
- ‚úÖ **Volumes —Å –¥–∞–Ω–Ω—ã–º–∏** - —Ç–æ–ª—å–∫–æ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —É–¥–∞–ª—è—é—Ç—Å—è
- ‚úÖ **–°–≤–µ–∂–∏–µ –æ–±—Ä–∞–∑—ã** (< 7 –¥–Ω–µ–π) - –æ—Å—Ç–∞—é—Ç—Å—è –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ rollback

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–∏—Å–∫–∞

```bash
# –ù–∞ VPS - –æ–±—â–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
ssh root@vps "df -h /"

# Docker –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
ssh root@vps "docker system df"
```

**–ü—Ä–∏–º–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:**

```
TYPE            TOTAL     ACTIVE    SIZE      RECLAIMABLE
Images          12        6         2.757GB   1.673GB (60%)
Containers      6         6         1.044kB   0B (0%)
Local Volumes   12        3         48.86MB   792B (0%)
Build Cache     0         0         0B        0B
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ cleanup —Ä–∞–±–æ—Ç–∞–µ—Ç

```bash
# 1. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–µ–ø–ª–æ—è
gh run list --branch main --limit 1

# 2. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ—Ç–∞–ª–∏ cleanup –≤ –ª–æ–≥–∞—Ö
gh run view <run-id> --log | grep -A 10 "cleanup\|prune"

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∫–æ–ª—å–∫–æ –º–µ—Å—Ç–∞ –æ—Å–≤–æ–±–æ–¥–∏–ª–æ—Å—å
ssh root@vps "docker system df"
```

---

## üß™ –†—É—á–Ω–æ–π cleanup (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –º–µ—Å—Ç–æ **–º–µ–∂–¥—É –¥–µ–ø–ª–æ—è–º–∏**:

### –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π cleanup (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
ssh root@vps

# –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker container prune -f

# –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –æ–±—Ä–∞–∑—ã —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π
docker image prune -af --filter "until=168h"

# –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ volumes
docker volume prune -f

# –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ networks
docker network prune -f
```

### –ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π cleanup (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ!)

```bash
ssh root@vps

# –£–¥–∞–ª–∏—Ç—å –í–°–Å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–µ (–≤–∫–ª—é—á–∞—è —Å–≤–µ–∂–∏–µ –æ–±—Ä–∞–∑—ã)
docker system prune -af --volumes

# ‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: —É–¥–∞–ª–∏—Ç –≤—Å–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –æ–±—Ä–∞–∑—ã,
# –≤–∫–ª—é—á–∞—è —Ç–µ —á—Ç–æ –Ω—É–∂–Ω—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ rollback
```

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤)

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è

–í `.github/workflows/ci-cd.yml` –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã:

```yaml
# –•—Ä–∞–Ω–∏—Ç—å –æ–±—Ä–∞–∑—ã 3 –¥–Ω—è –≤–º–µ—Å—Ç–æ 7
docker image prune -af --filter "until=72h"

# –•—Ä–∞–Ω–∏—Ç—å –æ–±—Ä–∞–∑—ã 14 –¥–Ω–µ–π (–¥–ª—è —Ä–µ–¥–∫–∏—Ö –¥–µ–ø–ª–æ–µ–≤)
docker image prune -af --filter "until=336h"

# –£–¥–∞–ª—è—Ç—å –≤—Å–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –æ–±—Ä–∞–∑—ã (–∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ)
docker image prune -af
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ cleanup:

```yaml
- name: Cleanup and log results
  run: |
    ssh ... << 'EOF'
      echo "Before cleanup:"
      docker system df
      
      docker image prune -af --filter "until=168h"
      
      echo "After cleanup:"
      docker system df
    EOF
```

---

## üö® Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –î–∏—Å–∫ –∑–∞–ø–æ–ª–Ω–µ–Ω

**–°–∏–º–ø—Ç–æ–º—ã:**

```
Error: no space left on device
```

**–†–µ—à–µ–Ω–∏–µ:**

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∑–∞–Ω–∏–º–∞–µ—Ç –º–µ—Å—Ç–æ:**

```bash
ssh root@vps
df -h /
du -sh /var/lib/docker/*
```

2. **–≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π cleanup:**

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–µ–Ω—É–∂–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
docker compose -f docker-compose.prod.yml stop pgadmin

# –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
docker system prune -af --volumes

# –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤
truncate -s 0 /var/lib/docker/containers/*/*-json.log
```

3. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:**

```bash
docker compose -f docker-compose.prod.yml up -d
```

### –ü—Ä–æ–±–ª–µ–º–∞: Cleanup —É–¥–∞–ª–∏–ª –Ω—É–∂–Ω—ã–µ –æ–±—Ä–∞–∑—ã

**–†–µ—à–µ–Ω–∏–µ:**
–û–±—Ä–∞–∑—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫–∞—á–∞—é—Ç—Å—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –¥–µ–ø–ª–æ–µ –∏–ª–∏ –º–æ–∂–Ω–æ –≤—Ä—É—á–Ω—É—é:

```bash
ssh root@vps
cd /opt/fin-u-ch
docker compose -f docker-compose.prod.yml pull
docker compose -f docker-compose.prod.yml up -d
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ü–æ—Å–ª–µ cleanup –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω–∞:** –í–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª–∏–ª–∏—Å—å volumes —Å –¥–∞–Ω–Ω—ã–º–∏

**–†–µ—à–µ–Ω–∏–µ:**

```bash
# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å volumes –∏–∑ backup
ssh root@vps
cd /opt/fin-u-ch

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ volumes —Å—É—â–µ—Å—Ç–≤—É—é—Ç
docker volume ls

# –ï—Å–ª–∏ –Ω—É–∂–Ω–æ - –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ë–î –∏–∑ backup
# (—Å–º. docs/BACKUP_STRATEGY.md)
```

---

## üìà –ú–µ—Ç—Ä–∏–∫–∏ –∏ –∞–ª–µ—Ä—Ç—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –ü—Ä–æ—Å—Ç–æ–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —á–µ—Ä–µ–∑ GitHub Actions

–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–∏—Å–∫–∞ –≤ deploy job:

```yaml
- name: Check disk usage
  run: |
    ssh ... << 'EOF'
      DISK_USAGE=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
      echo "Disk usage: ${DISK_USAGE}%"
      
      if [ $DISK_USAGE -gt 80 ]; then
        echo "‚ö†Ô∏è  WARNING: Disk usage is high (${DISK_USAGE}%)"
        exit 1
      fi
    EOF
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º

–ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Prometheus/Grafana:

- **Node Exporter** - –º–µ—Ç—Ä–∏–∫–∏ –¥–∏—Å–∫–∞
- **cAdvisor** - –º–µ—Ç—Ä–∏–∫–∏ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
- –ê–ª–µ—Ä—Ç –ø—Ä–∏ disk usage > 80%

---

## üí° Best Practices

### ‚úÖ DO (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

- –ü—Ä–æ–≤–µ—Ä—è—Ç—å `docker system df` –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä `until=168h` –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã cleanup –≤ CI/CD
- –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞

### ‚ùå DON'T (–ù–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

- –ù–µ —É–¥–∞–ª—è—Ç—å volumes –±–µ–∑ backup
- –ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `docker system prune -af --volumes` –≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º —Ä–µ–∂–∏–º–µ
- –ù–µ —Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–≥–∏ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (–æ–Ω–∏ —Ä–∞—Å—Ç—É—Ç)
- –ù–µ –∑–∞–±—ã–≤–∞—Ç—å –ø—Ä–æ monitoring

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [CI_CD.md](./CI_CD.md) - CI/CD Pipeline (–≥–¥–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω cleanup)
- [SETUP_EXTERNAL.md](./SETUP_EXTERNAL.md) - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ VPS
- [BACKUP_STRATEGY.md](./BACKUP_STRATEGY.md) - –°—Ç—Ä–∞—Ç–µ–≥–∏—è –±—ç–∫–∞–ø–æ–≤

---

## üìä –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# === –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ ===

# Docker –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
ssh root@vps "docker system df"

# –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
ssh root@vps "docker system df -v"

# –û–±—â–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞
ssh root@vps "df -h /"

# –†–∞–∑–º–µ—Ä –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ Docker
ssh root@vps "du -sh /var/lib/docker"

# === Cleanup ===

# –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π cleanup
ssh root@vps "docker image prune -af --filter 'until=168h'"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å (dry-run)
ssh root@vps "docker image prune -a --filter 'until=168h'"

# –ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π cleanup (–≤—Å—ë –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–µ)
ssh root@vps "docker system prune -af"

# === –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è ===

# –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –æ–±—Ä–∞–∑–æ–≤
ssh root@vps "docker images"

# –°–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (–≤–∫–ª—é—á–∞—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ)
ssh root@vps "docker ps -a"

# –°–ø–∏—Å–æ–∫ volumes
ssh root@vps "docker volume ls"
```

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: 2024-10-11  
**–ê–≤—Ç–æ—Ä**: DevOps Team  
**–°—Ç—Ä–∞—Ç–µ–≥–∏—è**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π cleanup –≤ CI/CD –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –¥–µ–ø–ª–æ—è
