# Инструкция по пересозданию интеграции Ozon

## Проблема

Если вы видите ошибку:

```
Ошибка при расшифровке: Unsupported state or unable to authenticate data
❌ Не удалось расшифровать apiKey - возвращено исходное значение
```

Это означает, что `apiKey` в базе данных был зашифрован другим `ENCRYPTION_KEY`, чем тот, который сейчас используется.

## Решение: Пересоздать интеграцию через форму

### Шаг 1: Откройте страницу интеграций

1. Войдите в систему
2. Откройте страницу **"Компания"** (Company)
3. Перейдите на вкладку **"Интеграции"**

### Шаг 2: Отключите текущую интеграцию

1. Найдите блок **"Интеграция с Ozon"**
2. Если интеграция подключена, нажмите кнопку **"Отключить"**
3. Дождитесь подтверждения об отключении

### Шаг 3: Включите интеграцию заново

1. Нажмите на заголовок **"Интеграция с Ozon"** (если блок свернут)
2. Заполните форму:
   - **Client-Key** — введите ваш Client-Key из Ozon Seller
   - **Api-Key** — введите ваш Api-Key из Ozon Seller (обязательно!)
   - **Ваш график выплат** — выберите `next_week` или `week_after`
   - **Статья** — выберите или создайте статью для операций Ozon
   - **Счет** — выберите или создайте счет для операций Ozon
3. Нажмите кнопку **"Подключить"** или **"Сохранить"**

### Шаг 4: Проверьте работу

После сохранения интеграции:

1. **Проверьте логи API** (при запуске должны увидеть):

   ```
   ✅ API: WORKER_API_KEY загружен (длина: 64)
   ✅ API: ENCRYPTION_KEY загружен (длина: 64)
   ```

2. **Запустите worker вручную для проверки**:

   ```bash
   cd apps/worker
   pnpm ozon-now
   ```

3. **Проверьте логи worker** — должны увидеть:
   ```
   ✅ WORKER_API_KEY загружен
   ✅ ENCRYPTION_KEY загружен
   ✅ apiKey успешно расшифрован (длина: XX)
   ✅ Операция создана
   ```

## Важные моменты

- ⚠️ **Api-Key обязателен** — без него интеграция не будет работать
- ✅ При сохранении `apiKey` автоматически шифруется текущим `ENCRYPTION_KEY`
- ✅ После пересоздания интеграция должна работать корректно
- ✅ Worker будет автоматически создавать операции по расписанию (каждую среду в 00:01)

## Где взять Client-Key и Api-Key?

1. Войдите в [Ozon Seller](https://seller.ozon.ru/)
2. Перейдите в **Настройки** → **API-ключи**
3. Скопируйте:
   - **Client ID** → это ваш `Client-Key`
   - **API Key** → это ваш `Api-Key`

## Если проблема осталась

1. Проверьте, что `ENCRYPTION_KEY` одинаковый в `.env` для API и Worker
2. Убедитесь, что API и Worker перезапущены после изменения `.env`
3. Проверьте логи API и Worker на наличие ошибок
4. Убедитесь, что `apiKey` введен правильно (без лишних пробелов)
