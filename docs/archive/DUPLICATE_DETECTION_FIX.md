# Исправление обнаружения дубликатов при импорте выписок

## Проблема

При импорте одной и той же выписки дважды система находила только 9 дубликатов вместо всех операций.

**Причины:**

1. Механизм обнаружения дубликатов проверял только **уже импортированные операции** (таблица `operation`), но **не проверял** операции в таблице `imported_operations` (загруженные, но еще не импортированные операции).

2. При проверке в таблице `operation` система пыталась сравнивать **сопоставленные данные** (контрагенты, которые мог вручную изменить пользователь), а не **исходные данные из выписки** (плательщик, получатель, их ИНН).

**Главная проблема:** В таблице `operation` не хранятся исходные данные из банковской выписки (payer, receiver, payerInn, receiverInn), поэтому невозможно было точно сравнить операции.

### Сценарий проблемы:

1. Пользователь загружает выписку с 50 операциями → операции попадают в `imported_operations`
2. Пользователь загружает ту же выписку снова → система не находит дубликаты, потому что:
   - Первые операции еще не стали реальными операциями (не в таблице `operation`)
   - Проверка дубликатов работала только с таблицей `operation`

## Решение

Обновлена функция `detectDuplicate` в файле `/apps/api/src/modules/imports/imports.service.ts`:

### Что изменилось:

1. **Двухэтапная проверка дубликатов с учетом структуры данных:**

   **Этап 1:** Проверка в таблице `operation` (уже импортированные операции)
   - Сравнение **только по назначению платежа** (первые 50 символов)
   - Ограничение: в `operation` не хранятся исходные данные из выписки (payer, receiver, payerInn, receiverInn)
   - Это позволяет обнаружить дубликаты среди уже импортированных операций

   **Этап 2:** Проверка в таблице `imported_operations` (загруженные операции)
   - Полное сравнение по **исходным данным из выписки**
   - Проверка только необработанных операций (`processed: false`)
   - Сравнение: номер документа, ИНН, имена плательщика/получателя, назначение

2. **Фокус на исходных данных из выписки:**
   - ✅ Сравниваем: дату, сумму, назначение платежа, плательщика, получателя, ИНН
   - ❌ НЕ сравниваем: статью, счет, контрагента (они могли быть изменены пользователем вручную)

3. **Вынесена логика сравнения:**
   - Создана функция `checkOperationMatch()` для унификации проверки совпадения
   - Улучшено сравнение: проверяются совпадения в обе стороны (A содержит B и B содержит A)
   - Более точное определение дубликатов по исходным данным

## Измененные файлы

### 1. `/apps/api/src/modules/imports/imports.service.ts`

- Обновлена функция `detectDuplicate()` - добавлена проверка в `imported_operations`
- Добавлена функция `checkOperationMatch()` - унифицированная логика сравнения

### 2. `/docs/features/duplicate-detection.md`

- Обновлена документация с описанием двухэтапной проверки
- Добавлено описание алгоритма обнаружения
- Обновлены ограничения

## Результат

Теперь при загрузке одной и той же выписки дважды система корректно обнаружит **все дубликаты**, независимо от того, были ли первые операции уже импортированы или только загружены.

### Пример работы:

```
Сценарий 1: Загрузили выписку → Загрузили ту же выписку снова
Результат: ✅ Все операции из второй загрузки помечены как дубликаты

Сценарий 2: Загрузили выписку → Импортировали → Загрузили ту же выписку снова
Результат: ✅ Все операции из второй загрузки помечены как дубликаты

Сценарий 3: Загрузили выписку 1 → Загрузили выписку 2 с перекрывающимися операциями
Результат: ✅ Перекрывающиеся операции помечены как дубликаты
```

## Тестирование

Рекомендуется протестировать следующие сценарии:

1. ✅ Загрузка одной и той же выписки дважды подряд
2. ✅ Загрузка выписки → Импорт → Загрузка той же выписки снова
3. ✅ Загрузка двух выписок с частично перекрывающимися периодами
4. ✅ Загрузка выписки с повторяющимися операциями (например, ежемесячная аренда)

## Критерии обнаружения дубликатов

**⚠️ Важно:** Сравниваются **только исходные данные из банковской выписки**. Ручное распределение (статьи, счета, контрагенты) не учитывается.

Операция считается дубликатом, если:

1. **Совпадает дата** (в пределах ±2 дня)
2. **Совпадает сумма** (точное совпадение)
3. **Выполняется хотя бы одно из условий:**

### Для уже импортированных операций (таблица `operation`):

- Совпадает назначение платежа (первые 50 символов)

### Для загруженных операций (таблица `imported_operations`):

- Совпадает номер документа
- Совпадает ИНН плательщика или получателя
- Совпадают имена плательщика и получателя (частичное совпадение первых 20 символов)
- Совпадает назначение платежа (частичное совпадение первых 30 символов)

## Примечания

- Проверка ограничена 10 потенциальными совпадениями для каждой операции (для производительности)
- В таблице `imported_operations` проверяются только необработанные операции (`processed: false`)
- При импорте "всех операций" дубликаты автоматически пропускаются
- Пользователь может вручную выбрать и импортировать дубликаты, если это необходимо

---

**Дата исправления:** 15 ноября 2025  
**Приоритет:** Высокий  
**Статус:** Исправлено ✅
