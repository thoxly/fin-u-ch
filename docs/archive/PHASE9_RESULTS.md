# –§–ê–ó–ê 9: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ VPS - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

**–î–∞—Ç–∞:** 7 –æ–∫—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** –ß–∞—Å—Ç–∏—á–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ (–æ–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)

## –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### 9.1 –ë–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ ‚úÖ

**–°–µ—Ä–≤–µ—Ä:** 83.166.244.139  
**–û–°:** Ubuntu 24.04.2 LTS (Noble Numbat)  
**–Ø–¥—Ä–æ:** Linux 6.8.0-62-generic

#### –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –ü–û:

- **Docker:** v28.5.0
- **Docker Compose:** v2.40.0
- –°–∏—Å—Ç–µ–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ (122 –ø–∞–∫–µ—Ç–∞)

### 9.2 Firewall –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å ‚úÖ

#### UFW Firewall:

- **–°—Ç–∞—Ç—É—Å:** –ê–∫—Ç–∏–≤–µ–Ω
- **–†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –ø–æ—Ä—Ç—ã:**
  - 22/tcp (SSH)
  - 80/tcp (HTTP)
  - 443/tcp (HTTPS)

#### SSH –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:

- **PasswordAuthentication:** no (–≤—Ö–æ–¥ —Ç–æ–ª—å–∫–æ –ø–æ –∫–ª—é—á—É)
- **PermitRootLogin:** prohibit-password (root —Ç–æ–ª—å–∫–æ –ø–æ SSH-–∫–ª—é—á—É)
- –°–ª—É–∂–±–∞: –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 9.4 –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞ ‚úÖ

**–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞:** `/opt/fin-u-ch/`

#### –°—Ç—Ä—É–∫—Ç—É—Ä–∞:

```
/opt/fin-u-ch/
‚îú‚îÄ‚îÄ .env                      # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ docker-compose.yml        # Production compose —Ñ–∞–π–ª
‚îî‚îÄ‚îÄ ops/
    ‚îî‚îÄ‚îÄ nginx/
        ‚îî‚îÄ‚îÄ nginx.conf        # Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
```

#### –§–∞–π–ª .env:

```env
# Database
POSTGRES_DB=fin_u_ch
POSTGRES_USER=postgres
POSTGRES_PASSWORD=<—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω 32-—Å–∏–º–≤–æ–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å>
DATABASE_URL=postgresql://postgres:<–ø–∞—Ä–æ–ª—å>@postgres:5432/fin_u_ch

# Redis
REDIS_URL=redis://redis:6379

# Auth
JWT_SECRET=<—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω 64-–±–∞–π—Ç–Ω—ã–π –∫–ª—é—á>
JWT_EXPIRES_IN=7d

# Docker
IMAGE_TAG=latest

# Node
NODE_ENV=production

# Docker Registry
DOCKER_REGISTRY=ghcr.io
DOCKER_IMAGE_PREFIX=<GITHUB_ORG>/fin-u-ch
NGINX_CONFIG=nginx.conf
SSL_CERT_PATH=./ops/nginx/ssl
```

### 9.5 –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx ‚úÖ

- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
- –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã upstream –¥–ª—è API –∏ Web
- –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã proxy headers
- Health check endpoint: `/health`

## –û–∂–∏–¥–∞—é—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### 9.3 SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã ‚è≥

**–¢—Ä–µ–±—É–µ—Ç—Å—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**

- –î–æ–º–µ–Ω–Ω–æ–µ –∏–º—è –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞
- DNS –ê-–∑–∞–ø–∏—Å—å –¥–æ–º–µ–Ω–∞ –Ω–∞ IP: `83.166.244.139`

**–ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è:**

- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å certbot
- –ü–æ–ª—É—á–∏—Ç—å Let's Encrypt —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å auto-renewal
- –û–±–Ω–æ–≤–∏—Ç—å nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è HTTPS

### 9.6 GitHub Container Registry ‚úÖ –ì–æ—Ç–æ–≤–æ (–æ—Å—Ç–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å SSH –∫–ª—é—á)

**–í—ã–ø–æ–ª–Ω–µ–Ω–æ:**

- ‚úÖ GitHub username –æ–ø—Ä–µ–¥–µ–ª–µ–Ω: `thoxly`
- ‚úÖ GHCR_TOKEN —Å–æ–∑–¥–∞–Ω –∏ –¥–æ–±–∞–≤–ª–µ–Ω –≤ GitHub Secrets
- ‚úÖ CI/CD workflow –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `GHCR_TOKEN`
- ‚úÖ `.env` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –æ–±–Ω–æ–≤–ª–µ–Ω: `DOCKER_IMAGE_PREFIX=thoxly/fin-u-ch`
- ‚úÖ –°–æ–∑–¥–∞–Ω job `setup-ghcr` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á–µ—Ä–µ–∑ GitHub Actions

**–°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ GitHub Actions (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**

1. –î–æ–±–∞–≤–∏—Ç—å `VPS_SSH_KEY` –≤ GitHub Secrets:

   ```bash
   cat ~/.ssh/id_rsa_server  # –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—ã–≤–æ–¥
   ```

   - –ü–µ—Ä–µ–π—Ç–∏: https://github.com/thoxly/fin-u-ch/settings/secrets/actions
   - New secret: `VPS_SSH_KEY` = —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–ª—é—á–∞

2. –ó–∞–ø—É—Å—Ç–∏—Ç—å workflow –≤—Ä—É—á–Ω—É—é:
   - https://github.com/thoxly/fin-u-ch/actions
   - Run workflow ‚Üí main
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç `docker login ghcr.io` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

**–°–ø–æ—Å–æ–± 2: –õ–æ–∫–∞–ª—å–Ω–æ (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞)**

```bash
ssh -i ~/.ssh/id_rsa_server root@83.166.244.139 "echo YOUR_GHCR_TOKEN | docker login ghcr.io -u thoxly --password-stdin"
```

**–ü—É—Ç—å –∫ –æ–±—Ä–∞–∑–∞–º:**

- API: `ghcr.io/thoxly/fin-u-ch-api:latest`
- Web: `ghcr.io/thoxly/fin-u-ch-web:latest`
- Worker: `ghcr.io/thoxly/fin-u-ch-worker:latest`

üìù –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: `SETUP_VPS_SSH_KEY.md`

## –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ Docker:

```bash
ssh -i ~/.ssh/id_rsa_server root@83.166.244.139
docker --version
docker compose version
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ Firewall:

```bash
ufw status
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:

```bash
cd /opt/fin-u-ch
ls -la
cat .env
```

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–§–ê–ó–ê 10)

–ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö:

1. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ GHCR
3. –°–æ–±—Ä–∞—Ç—å –∏ push Docker –æ–±—Ä–∞–∑—ã
4. –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ VPS
5. –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å

## –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –¥–µ–ø–ª–æ—é

**–°—Ç–∞—Ç—É—Å:** 95% –≥–æ—Ç–æ–≤–æ (–≤—Å–µ —Å–µ–∫—Ä–µ—Ç—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã: GHCR_TOKEN, VPS_SSH_KEY, VPS_HOST, VPS_USER)

‚úÖ –°–µ—Ä–≤–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–Ω  
‚úÖ Docker —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω  
‚úÖ Firewall –Ω–∞—Å—Ç—Ä–æ–µ–Ω  
‚úÖ SSH –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å  
‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞  
‚úÖ Nginx –Ω–∞—Å—Ç—Ä–æ–µ–Ω  
‚úÖ GHCR —Ç–æ–∫–µ–Ω —Å–æ–∑–¥–∞–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ CI/CD  
‚úÖ Docker –æ–±—Ä–∞–∑—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –¥–ª—è `ghcr.io/thoxly/fin-u-ch`  
‚è≥ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã (—Ç—Ä–µ–±—É–µ—Ç –¥–æ–º–µ–Ω)  
‚è≥ GHCR –ª–æ–≥–∏–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (—Ç—Ä–µ–±—É–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã —Å —Ç–æ–∫–µ–Ω–æ–º)

# CI/CD test
