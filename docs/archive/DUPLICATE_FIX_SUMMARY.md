# Краткая сводка исправления обнаружения дубликатов

## Суть проблемы

Вы правильно заметили: система должна сравнивать **только исходные данные из выписки** (дата, сумма, назначение, плательщик, получатель), а НЕ то, что пользователь вручную распределил (статьи, счета, контрагенты).

## Что было исправлено

### Проблема в старой реализации:

- Пыталась сравнивать `counterparty.inn` и `counterparty.name` из таблицы `operation`
- Но контрагент мог быть изменен пользователем вручную!
- В таблице `operation` вообще нет исходных данных из выписки (payer, receiver, payerInn, receiverInn)

### Новая реализация:

**1. Для таблицы `operation` (уже импортированные):**

- Сравниваем только: дата (±2 дня) + сумма + назначение платежа (50 символов)
- Больше ничего, потому что исходных данных там нет

**2. Для таблицы `imported_operations` (загруженные):**

- Полное сравнение по исходным данным из выписки:
  - Дата (±2 дня)
  - Сумма
  - Номер документа
  - ИНН плательщика/получателя
  - Имена плательщика/получателя
  - Назначение платежа

## Что НЕ сравнивается

❌ Статья (article) - пользователь мог изменить  
❌ Счет (account) - пользователь мог изменить  
❌ Контрагент (counterparty) - пользователь мог изменить  
❌ Подразделение (department) - пользователь мог изменить  
❌ Сделка (deal) - пользователь мог изменить

## Что сравнивается

✅ Дата операции из выписки  
✅ Сумма из выписки  
✅ Назначение платежа (из поля "НазначениеПлатежа")  
✅ Плательщик (из поля "Плательщик")  
✅ Получатель (из поля "Получатель")  
✅ ИНН плательщика (из поля "ПлательщикИНН")  
✅ ИНН получателя (из поля "ПолучательИНН")  
✅ Номер документа (из поля "Номер")

## Результат

Теперь при загрузке одной и той же выписки дважды система найдет **ВСЕ дубликаты**, независимо от того, как пользователь вручную распределил операции.

---

**Дата:** 15 ноября 2025  
**Статус:** ✅ Исправлено
