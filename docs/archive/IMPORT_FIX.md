# Исправление проблемы с количеством импортируемых операций

## Проблема

При импорте банковской выписки с более чем 2000 операциями загружалось только 815 операций.

## Причины

Проблема могла быть вызвана одной или несколькими из следующих причин:

1. **Неподдерживаемые типы документов** - Система обрабатывает только "Платежные поручения". Другие типы документов (например, "Платежное требование", "Инкассовое поручение") пропускаются.

2. **Невалидные документы** - Документы без обязательных полей (Дата или Сумма) пропускаются.

3. **Ограничение в 1000 операций** - Ранее система имела жесткое ограничение в 1000 операций на один импорт.

## Внесенные изменения

### 1. Увеличен лимит операций

- **Было:** 1000 операций
- **Стало:** 5000 операций

Теперь вы можете импортировать до 5000 операций за один раз.

### 2. Добавлена подробная статистика парсинга

После загрузки файла система теперь показывает:

- Общее количество найденных секций документов
- Количество успешно обработанных операций
- Количество пропущенных документов (с указанием типов)
- Количество невалидных документов
- Типы документов, найденные в файле

**Пример сообщения:**

```
Файл загружен. Найдено операций: 815

Внимание: В файле найдено 2000 документов, но обработано только 815:
• Пропущено (неподдерживаемый тип): 1150 (типы: Платежное требование, Инкассовое поручение)
• Невалидных (нет даты или суммы): 35
```

### 3. Улучшено логирование

Парсер теперь записывает подробную информацию о процессе обработки в логи сервера, что помогает диагностировать проблемы.

## Как проверить

1. **Запустите сервер в режиме разработки:**

   ```bash
   pnpm dev
   ```

2. **Загрузите файл с выпиской** через интерфейс импорта

3. **Проверьте сообщение** после загрузки - оно должно содержать статистику, если часть документов не была обработана

4. **Посмотрите логи в консоли** Git Bash, где запущен `pnpm dev`. Найдите строки:
   - `Parser: Parsing complete` - итоговая статистика парсинга
   - `File parsed successfully` - количество распарсенных документов

## Что делать, если проблема сохраняется

Если после обновления проблема сохраняется:

1. **Проверьте логи парсера** в консоли, где запущен `pnpm dev`
2. **Обратите внимание на сообщение** после загрузки файла - оно покажет детали
3. **Проверьте типы документов** в вашем файле:
   - Откройте файл в текстовом редакторе
   - Найдите строки вида `СекцияДокумент=...`
   - Убедитесь, что большинство документов имеют тип "Платежное поручение"

4. **Проверьте обязательные поля:**
   - Каждый документ должен содержать поля `Дата=` и `Сумма=`
   - Дата должна быть в формате `DD.MM.YYYY`
   - Сумма должна быть положительным числом

## Поддерживаемый формат

Система поддерживает формат 1С ClientBankExchange (`.txt` файлы) со следующими типами документов:

- ✅ Платежное поручение (обрабатывается)
- ❌ Платежное требование (пропускается)
- ❌ Инкассовое поручение (пропускается)
- ❌ Другие типы документов (пропускаются)

Каждый документ должен содержать обязательные поля:

- `Дата=` - дата операции (формат: DD.MM.YYYY)
- `Сумма=` - сумма операции (положительное число)

## Дополнительная информация

Подробная документация доступна в файле:

- `docs/features/duplicate-detection.md` - информация об обнаружении дубликатов и ограничениях системы

## Тестирование изменений

Чтобы убедиться, что изменения работают:

1. Загрузите ваш файл с 2000+ операциями
2. Посмотрите на сообщение после загрузки
3. Проверьте, указывает ли оно на пропущенные или невалидные документы
4. Если да - проверьте типы документов и наличие обязательных полей в исходном файле

---

**Примечание:** Если ваш файл содержит только платежные поручения с корректными данными, но все равно загружается неполностью, пожалуйста, предоставьте фрагмент файла (первые 50 строк и пример одного документа) для дальнейшей диагностики.
