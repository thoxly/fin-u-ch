#!/bin/bash

# ================================================
# –£–º–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ –≤ –≥–∏–±—Ä–∏–¥–Ω–æ–º —Ä–µ–∂–∏–º–µ
# ================================================
# –§—Ä–æ–Ω—Ç –∏ –±—ç–∫ –ª–æ–∫–∞–ª—å–Ω–æ, –±–∞–∑–∞ –∏ Redis –≤ Docker
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–æ—Ä—Ç–∞–º–∏, Docker, Prisma

set -e

echo "üöÄ –ó–∞–ø—É—Å–∫ Fin-U-CH –≤ –≥–∏–±—Ä–∏–¥–Ω–æ–º —Ä–µ–∂–∏–º–µ..."
echo "üì¶ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ Redis –≤ Docker"
echo "üíª –§—Ä–æ–Ω—Ç –∏ –±—ç–∫ –ª–æ–∫–∞–ª—å–Ω–æ"
echo ""

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –ø–æ—Ä—Ç–æ–≤
free_ports() {
    echo "üîß –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ—Ä—Ç—ã..."
    
    # –°–ø–∏—Å–æ–∫ –ø–æ—Ä—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    PORTS=(4000 5173 5432 6379)
    
    for port in "${PORTS[@]}"; do
        # –ù–∞—Ö–æ–¥–∏–º –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É
        PIDS=$(lsof -ti:$port 2>/dev/null || true)
        if [ ! -z "$PIDS" ]; then
            echo "‚ö†Ô∏è  –ü–æ—Ä—Ç $port –∑–∞–Ω—è—Ç, –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º..."
            echo "$PIDS" | xargs kill -9 2>/dev/null || true
            sleep 1
        fi
    done
    
    echo "‚úÖ –ü–æ—Ä—Ç—ã –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω—ã"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –∑–∞–ø—É—Å–∫–∞ Docker
ensure_docker() {
    echo "üê≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º Docker..."
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Docker
    if ! command -v docker &> /dev/null; then
        echo "‚ùå Docker –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
        exit 1
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ Docker daemon
    if ! docker info &> /dev/null; then
        echo "‚ö†Ô∏è  Docker –Ω–µ –∑–∞–ø—É—â–µ–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º..."
        open -a Docker
        echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ Docker (30 —Å–µ–∫)..."
        sleep 30
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—â–µ —Ä–∞–∑
        if ! docker info &> /dev/null; then
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å Docker. –ó–∞–ø—É—Å—Ç–∏—Ç–µ Docker Desktop –≤—Ä—É—á–Ω—É—é."
            exit 1
        fi
    fi
    
    echo "‚úÖ Docker –≥–æ—Ç–æ–≤"
}

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ pnpm
if ! command -v pnpm &> /dev/null; then
    echo "‚ùå pnpm –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ pnpm –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
    exit 1
fi

# –í—ã–ø–æ–ª–Ω—è–µ–º –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
free_ports
ensure_docker

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ .env —Ñ–∞–π–ª–∞
if [ ! -f .env ]; then
    echo "‚ùå –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    echo "üìù –°–æ–∑–¥–∞–π—Ç–µ .env —Ñ–∞–π–ª –≤—Ä—É—á–Ω—É—é:"
    echo "   pnpm env:setup"
    echo "   –∏–ª–∏"
    echo "   cp env.example .env"
    exit 1
fi

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
if [ ! -d "node_modules" ]; then
    echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
    pnpm install
fi

# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Prisma –∫–ª–∏–µ–Ω—Ç
echo "üîß –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Prisma –∫–ª–∏–µ–Ω—Ç..."
pnpm prisma:generate

# –ó–∞–ø—É—Å–∫–∞–µ–º Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
echo "üê≥ –ó–∞–ø—É—Å–∫–∞–µ–º Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (PostgreSQL + Redis)..."
pnpm docker:hybrid:up

# –ñ–¥–µ–º –ø–æ–∫–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤–∞
echo "‚è≥ –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
sleep 10

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö..."
for i in {1..10}; do
    if pnpm --filter api prisma db push --accept-data-loss &>/dev/null; then
        echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞"
        break
    else
        echo "‚è≥ –ü–æ–ø—ã—Ç–∫–∞ $i/10 - –∂–¥–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö..."
        sleep 3
    fi
done

# –ó–∞–ø—É—Å–∫–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏
echo "üóÑÔ∏è –ó–∞–ø—É—Å–∫–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
pnpm --filter api prisma:deploy

# –°–æ–∑–¥–∞–µ–º –¥–µ–º–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –µ—Å–ª–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
echo "üë§ –°–æ–∑–¥–∞–µ–º –¥–µ–º–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..."
pnpm demo:create || echo "‚ÑπÔ∏è  –î–µ–º–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"

echo ""
echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –ü—Ä–æ–µ–∫—Ç –∑–∞–ø—É—â–µ–Ω –≤ –≥–∏–±—Ä–∏–¥–Ω–æ–º —Ä–µ–∂–∏–º–µ:"
echo "   üåê Frontend: http://localhost:5173"
echo "   üîß API: http://localhost:4000"
echo "   üóÑÔ∏è PostgreSQL: localhost:5432"
echo "   üì¶ Redis: localhost:6379"
echo ""
echo "–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: pnpm dev:hybrid:stop"
echo ""

# –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ—Ä–æ–Ω—Ç –∏ –±—ç–∫ –ª–æ–∫–∞–ª—å–Ω–æ
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ—Ä–æ–Ω—Ç –∏ –±—ç–∫ –ª–æ–∫–∞–ª—å–Ω–æ..."

# –ó–∞–ø—É—Å–∫–∞–µ–º API –≤ —Ñ–æ–Ω–µ
pnpm --filter api dev &
API_PID=$!

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ API
echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ API..."
sleep 5

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ API –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
if ! kill -0 $API_PID 2>/dev/null; then
    echo "‚ùå API –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è"
    exit 1
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º Web –≤ —Ñ–æ–Ω–µ
pnpm --filter web dev &
WEB_PID=$!

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ Web
echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ Web..."
sleep 3

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ Web –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
if ! kill -0 $WEB_PID 2>/dev/null; then
    echo "‚ùå Web –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è"
    kill $API_PID 2>/dev/null || true
    exit 1
fi

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–µ–º–æ-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
check_demo_auth() {
    echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –¥–µ–º–æ-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..."
    
    # –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ, —á—Ç–æ–±—ã API —Ç–æ—á–Ω–æ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
    sleep 3
    
    # –ü—Ä–æ–±—É–µ–º –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è
    RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:4000/api/auth/login \
        -H "Content-Type: application/json" \
        -d '{"email":"demo@example.com","password":"demo123"}' 2>&1 || echo -e "\n000")
    
    HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
    BODY=$(echo "$RESPONSE" | sed '$d')
    
    # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –∏–∑ HTTP_CODE
    HTTP_CODE=$(echo "$HTTP_CODE" | tr -d '[:space:]')
    
    if [ "$HTTP_CODE" = "500" ]; then
        echo "‚ö†Ô∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –æ—à–∏–±–∫–∞ 500 –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–µ–º–æ-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
        echo "üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
        ORIGINAL_DIR=$(pwd)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ö–µ–º—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        if [ -d "apps/api" ]; then
            cd apps/api
            if npx prisma db push --accept-data-loss 2>/dev/null; then
                echo "‚úÖ –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∞"
            else
                echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ö–µ–º—É —á–µ—Ä–µ–∑ db push, –ø—Ä–æ–±—É–µ–º migrate deploy..."
                npx prisma migrate deploy 2>/dev/null || echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏"
            fi
            cd "$ORIGINAL_DIR"
        else
            echo "‚ö†Ô∏è  –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è apps/api –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
        fi
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Prisma –∫–ª–∏–µ–Ω—Ç –∑–∞–Ω–æ–≤–æ
        echo "üîß –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Prisma –∫–ª–∏–µ–Ω—Ç..."
        pnpm prisma:generate || echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å Prisma –∫–ª–∏–µ–Ω—Ç"
        
        echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã"
        echo "‚è≥ –ñ–¥–µ–º –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ API (nodemon –¥–æ–ª–∂–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å)..."
        sleep 5
        
        # –ü—Ä–æ–±—É–µ–º –µ—â–µ —Ä–∞–∑
        echo "üîç –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏..."
        RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:4000/api/auth/login \
            -H "Content-Type: application/json" \
            -d '{"email":"demo@example.com","password":"demo123"}' 2>&1 || echo -e "\n000")
        
        HTTP_CODE=$(echo "$RESPONSE" | tail -n1 | tr -d '[:space:]')
        
        if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π"
        else
            echo "‚ö†Ô∏è  –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤—Å–µ –µ—â–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (HTTP $HTTP_CODE)"
            echo "   –í–æ–∑–º–æ–∂–Ω–æ, –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å API –≤—Ä—É—á–Ω—É—é"
        fi
    elif [ "$HTTP_CODE" = "200" ]; then
        echo "‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–µ–º–æ-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ä–∞–±–æ—Ç–∞–µ—Ç"
    else
        echo "‚ÑπÔ∏è  –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤–µ—Ä–Ω—É–ª–∞ –∫–æ–¥ $HTTP_CODE (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –¥–µ–º–æ-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–æ–∑–¥–∞–Ω)"
    fi
}

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –¥–µ–º–æ-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
# –û—Ç–∫–ª—é—á–∞–µ–º set -e –¥–ª—è —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏, —á—Ç–æ–±—ã –æ—à–∏–±–∫–∏ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–ª–∏ —Å–∫—Ä–∏–ø—Ç
set +e
check_demo_auth
set -e

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
cleanup() {
    echo ""
    echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã..."
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã
    kill $API_PID $WEB_PID 2>/dev/null || true
    
    # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
    wait $API_PID $WEB_PID 2>/dev/null || true
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
    echo "üê≥ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
    pnpm docker:hybrid:down
    
    echo "‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
    exit 0
}

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
trap cleanup SIGINT SIGTERM

echo ""
echo "üéâ –ü—Ä–æ–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!"
echo "   üåê Frontend: http://localhost:5173"
echo "   üîß API: http://localhost:4000"
echo "   üóÑÔ∏è PostgreSQL: localhost:5432"
echo "   üì¶ Redis: localhost:6379"
echo ""
echo "–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C"
echo ""

# –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
wait
