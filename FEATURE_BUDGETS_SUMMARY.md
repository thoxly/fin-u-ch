# Функционал бюджетов (БДДС) - Сводка изменений

## Описание

Реализован полный функционал работы с бюджетами согласно ТЗ. Добавлена сущность Бюджет, обновлены отчеты, создан раздел для управления бюджетами.

## Изменения в базе данных

### Prisma Schema

- ✅ Добавлена модель `Budget` с полями: id, companyId, name, startDate, endDate, status, timestamps
- ✅ Добавлено поле `budgetId` в модель `PlanItem` (опционально)
- ✅ Добавлены индексы для оптимизации запросов
- ✅ Создана миграция `20251023084823_add_budgets`

## Backend изменения

### API Endpoints

#### Бюджеты (новое)

- `GET /api/budgets?status=active|archived` - список бюджетов
- `POST /api/budgets` - создание бюджета
- `PATCH /api/budgets/:id` - обновление бюджета
- `DELETE /api/budgets/:id` - удаление бюджета
- `GET /api/budgets/:id` - получение бюджета по ID

#### Планы (обновлено)

- `GET /api/plans?budgetId=...` - добавлен фильтр по budgetId
- `POST /api/plans` - добавлена поддержка поля budgetId
- `PATCH /api/plans/:id` - добавлена поддержка поля budgetId

#### Отчеты (обновлено)

- `GET /api/reports/bdds?budgetId=...` - добавлен обязательный параметр budgetId
  - Если budgetId не передан - возвращается пустой массив

### Модули

- ✅ Создан модуль `budgets` (service, controller, routes)
- ✅ Обновлен модуль `plans` для поддержки budgetId
- ✅ Обновлен модуль `reports/bdds` для фильтрации по budgetId

## Frontend изменения

### Shared пакет

- ✅ Добавлен тип `Budget`
- ✅ Добавлены типы `CreateBudgetDTO`, `UpdateBudgetDTO`
- ✅ Добавлен enum `BudgetStatus`
- ✅ Обновлен тип `PlanItem` с полем budgetId
- ✅ Обновлен тип `ReportFilters` с полем budgetId

### RTK Query API

- ✅ Создан `budgetsApi` с методами CRUD
- ✅ Обновлен `plansApi` с поддержкой фильтра budgetId
- ✅ Обновлен `reportsApi` - добавлен параметр budgetId для getBddsReport
- ✅ Добавлен тег 'Budget' в apiSlice

### Новые страницы

- ✅ `BudgetsPage` - список бюджетов с фильтрацией (активные/архивные/все)
  - Создание бюджета через модальное окно
  - Действия: открыть, архивировать/восстановить, удалить
- ✅ `BudgetDetailsPage` - детали бюджета
  - Матрица плана (PlanMatrixTable) с помесячными данными
  - Список плановых записей
  - Добавление/редактирование плановых записей через OffCanvas
  - Действия: архивировать/восстановить бюджет

### Новые виджеты

- ✅ `PlanMatrixTable` - табличный виджет для отображения БДДС
  - Помесячное отображение плановых данных
  - Группировка по типу (доходы/расходы)
  - Автоматический расчет итогов
  - Фиксированная первая колонка и заголовок при прокрутке
  - Адаптивный дизайн с горизонтальной прокруткой

### Обновленные компоненты

#### ReportsPage (существенные изменения)

- ✅ Удалены вкладки, добавлен MenuPopover для выбора типа отчета
- ✅ Оставлены только отчеты: "ДДС" и "ДДС детально"
- ✅ Удалены отчеты: "БДДС (план)" и "План vs Факт"
- ✅ Добавлен поповер для выбора бюджета (только для ДДС)
- ✅ Удален чекбокс "Показать план"
- ✅ Выбранный бюджет сохраняется в localStorage
- ✅ При выборе бюджета отображается наложение плана на факт

#### PlanForm

- ✅ Добавлен опциональный проп `budgetId`
- ✅ При передаче budgetId - автоматически присваивается плану

#### Layout

- ✅ Добавлена ссылка "Бюджеты" в навигацию (между Планы и Отчеты)

#### App.tsx

- ✅ Добавлены маршруты `/budgets` и `/budgets/:budgetId`

## Тестирование

### Юнит тесты

- ✅ `budgets.service.test.ts` - 11 тестов для BudgetsService (все проходят)
  - Тесты на CRUD операции
  - Валидация данных
  - Обработка ошибок
- ✅ `PlanMatrixTable.test.tsx` - 6 тестов для виджета (все проходят)
  - Рендеринг таблицы
  - Отображение месяцев
  - Расчет итогов
  - Группировка по типам
  - Пустое состояние

### E2E тесты

- ✅ `budgets.spec.ts` - тесты для функционала бюджетов
  - Отображение страницы бюджетов
  - Создание бюджета
  - Фильтрация по статусу
  - Навигация в детали бюджета
  - Добавление плановых позиций
  - Выбор бюджета в отчетах
  - Переключение типов отчетов

## Сборка

- ✅ API собирается без ошибок (`npm run build`)
- ✅ Frontend собирается без ошибок (`npm run build`)
- ✅ Все юнит тесты проходят

## Критерии приемки (из ТЗ)

- ✅ В отчетах остались только «ДДС» и «ДДС детально», переключение через поповер
- ✅ В «ДДС» доступен выбор бюджета; при выборе отображается план поверх факта
- ✅ Отдельного раздела «План vs Факт» нет
- ✅ БДДС выводится в «Бюджеты > Детали бюджета» через PlanMatrixTable
- ✅ Можно создать несколько активных бюджетов
- ✅ Планы создаются и редактируются в контексте бюджета через OffCanvas
- ✅ PlanItem сохраняется с budgetId
- ✅ Существующие PlanItem без budgetId не ломают систему

## Архитектурные решения

1. **Опциональность budgetId**: PlanItem.budgetId опционален, что обеспечивает обратную совместимость
2. **Фильтрация в БДДС**: Если budgetId не передан, возвращается пустой массив (MVP подход)
3. **Переиспользуемость**: PlanMatrixTable - универсальный виджет для любого БДДS отчета
4. **Кеширование**: Выбранный бюджет сохраняется в localStorage для удобства
5. **Инвалидация кеша**: При изменении планов инвалидируются теги Plan, Budget, Dashboard, Report

## Следующие шаги (опционально)

- Добавить возможность копирования бюджета
- Добавить экспорт БДДС в Excel
- Добавить сравнение нескольких бюджетов
- Добавить версионирование бюджетов

## Технический стек

- Backend: Node.js, Express, Prisma, PostgreSQL
- Frontend: React, TypeScript, Redux Toolkit, RTK Query
- Testing: Jest, Playwright
- Styling: TailwindCSS

---

Ветка: `feature/budgets-bdds`
Дата: 23 октября 2024
