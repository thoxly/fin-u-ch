# Recurring Operations Generation

Система автоматической генерации периодических операций на основе шаблонов (операции с `isTemplate: true` и `repeat != 'none'`). Запускается ежедневно в 00:01 через cron и проверяет все активные шаблоны, создавая операции на текущую дату если они еще не существуют. Поддерживает периодичности: daily, weekly, monthly, quarterly, semiannual, annual.

Процесс генерации начинается с загрузки всех активных шаблонов из базы данных с фильтрацией: `isTemplate: true`, `repeat != 'none'`, и дата окончания (`recurrenceEndDate`) либо null, либо >= текущей даты. Для каждого шаблона вызывается функция `shouldCreateRecurrence`, которая определяет, нужно ли создавать операцию на целевую дату на основе периодичности и даты начала шаблона. Если операция нужна, проверяется отсутствие уже существующей операции на эту дату с тем же шаблоном (через проверку по дате, сумме и статье) - это предотвращает дублирование при повторных запусках job.

Алгоритм определения даты для разных периодичностей работает следующим образом. Для `daily` операция создается каждый день без дополнительных проверок. Для `weekly` проверяется совпадение дня недели (0-6, где 0 - воскресенье) между датой шаблона и целевой датой. Для `monthly` проверяется совпадение числа месяца (1-31) - если в целевом месяце такого числа нет (например, 31 февраля), операция не создается. Для `quarterly` проверяется число месяца и кратность 3 месяцам от месяца шаблона. Для `semiannual` аналогично, но кратность 6 месяцам. Для `annual` проверяется точное совпадение даты (число и месяц).

Система учитывает границы действия шаблона. Дата начала (`operationDate`) определяет первую возможную дату генерации - операции не создаются до этой даты. Дата окончания (`recurrenceEndDate`) определяет последнюю возможную дату - операции не создаются после этой даты. Если `recurrenceEndDate` равна null, шаблон действует бессрочно. При создании операции все поля копируются из шаблона (сумма, статья, контрагент, счет и т.д.), но дата устанавливается как целевая дата, а флаги `isTemplate: false` и `isConfirmed: true` для обозначения реальной операции.

Обработка ошибок выполняется на уровне отдельных шаблонов - если генерация для одного шаблона падает с ошибкой (например, невалидные данные или проблема с БД), ошибка логируется, но обработка продолжается для остальных шаблонов. Это гарантирует, что проблемы с одним шаблоном не блокируют генерацию для других. Система собирает статистику: количество созданных операций, пропущенных (уже существуют или не подходят по дате), и ошибок. Метрики записываются в Prometheus для мониторинга.

**Ключевые файлы:** `operations.generate.recurring.ts` (главная функция `generateRecurringOperations`, вспомогательная `shouldCreateRecurrence`). Расписание настраивается в `worker/src/index.ts` через cron выражение `1 0 * * *` (ежедневно в 00:01). Для добавления новой периодичности расширьте switch в `shouldCreateRecurrence` с логикой определения даты. Job можно запустить вручную через функцию `runRecurringOperationsManually` с опциональной целевой датой для тестирования. Для отладки проверяйте логи с префиксом "Recurring operations generation".
