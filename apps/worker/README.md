# Worker - –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏

Worker –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞—á –≤ —Å–∏—Å—Ç–µ–º–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ —É—á–µ—Ç–∞.

## –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞—Ä–ø–ª–∞—Ç–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ –¥–ª—è –∑–∞—Ä–ø–ª–∞—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:

- **–§–û–¢** (–§–æ–Ω–¥ –æ–ø–ª–∞—Ç—ã —Ç—Ä—É–¥–∞) - –æ—Å–Ω–æ–≤–Ω–∞—è –∑–∞—Ä–ø–ª–∞—Ç–∞
- **–°—Ç—Ä–∞—Ö–æ–≤—ã–µ –≤–∑–Ω–æ—Å—ã** - 30% –æ—Ç –±–∞–∑–æ–≤–æ–π –∑–∞—Ä–ø–ª–∞—Ç—ã
- **–ù–î–§–õ** - 13% –æ—Ç –±–∞–∑–æ–≤–æ–π –∑–∞—Ä–ø–ª–∞—Ç—ã

**–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ**: –ö–∞–∂–¥–æ–µ 1-–µ —á–∏—Å–ª–æ –º–µ—Å—è—Ü–∞ –≤ 00:00 (Europe/Moscow)

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
pnpm install
```

### 2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Prisma Client

```bash
npx prisma generate
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env`:

```env
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/fin_u_ch_dev
NODE_ENV=development
```

### 4. –ó–∞–ø—É—Å–∫

```bash
# –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ (—Å hot-reload)
pnpm dev

# Production
pnpm build
pnpm start
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
src/
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îú‚îÄ‚îÄ env.ts        # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ logger.ts     # Winston –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îÇ   ‚îî‚îÄ‚îÄ prisma.ts     # Prisma Client
‚îú‚îÄ‚îÄ jobs/
‚îÇ   ‚îî‚îÄ‚îÄ salary.generate.monthly.ts  # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞—Ä–ø–ª–∞—Ç
‚îî‚îÄ‚îÄ index.ts          # Entry point —Å cron scheduler
```

## –ó–∞–¥–∞—á–∏

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞—Ä–ø–ª–∞—Ç

**–§–∞–π–ª**: `src/jobs/salary.generate.monthly.ts`

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç**:

1. –ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø–∏—Å–∏ Salary
2. –î–ª—è –∫–∞–∂–¥–æ–π —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—É–º–º—ã
3. –°–æ–∑–¥–∞–µ—Ç 3 –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ä–∞—Å—Ö–æ–¥–∞ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
4. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç —Å—Ç–∞—Ç—å–∏ –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç

**Cron**: `0 0 1 * *` (–∫–∞–∂–¥–æ–µ 1-–µ —á–∏—Å–ª–æ –≤ 00:00)

## –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)

–†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –≤ `src/index.ts`:

```typescript
// –ü–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
runSalaryGenerationManually('2025-10');
```

## –õ–æ–≥–∏

Worker –≤—ã–≤–æ–¥–∏—Ç –ø–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª—å:

```
2025-10-07 10:00:00 [INFO]: üöÄ Worker starting...
2025-10-07 10:00:00 [INFO]: ‚úÖ Database connection established
2025-10-07 10:00:00 [INFO]: üë∑ Worker is running...
```

–ü—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏:

```
2025-11-01 00:00:00 [INFO]: üîÑ Running scheduled salary generation task...
2025-11-01 00:00:00 [INFO]: Found 5 active salary record(s)
2025-11-01 00:00:00 [INFO]: Generated salary operations for –ò–≤–∞–Ω–æ–≤ –ò.–ò.: wage=100000, contributions=30000.00, tax=13000.00
2025-11-01 00:00:00 [INFO]: ‚úÖ Salary generation task completed successfully
```

## Graceful Shutdown

Worker –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ä–∞–±–æ—Ç—É –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤:

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∫–∞
Ctrl+C  # –∏–ª–∏ kill <PID>
```

## Production

–î–ª—è production —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å process manager:

```bash
# PM2
pm2 start dist/index.js --name worker

# Docker
docker build -f ops/docker/worker.Dockerfile .
```

## Troubleshooting

### Worker –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `DATABASE_URL` –≤ `.env`
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ PostgreSQL –∑–∞–ø—É—â–µ–Ω
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ Prisma Client —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω: `npx prisma generate`

### –û–ø–µ—Ä–∞—Ü–∏–∏ –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è

1. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø–∏—Å–∏ Salary
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ effectiveFrom <= —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü <= effectiveTo (–∏–ª–∏ effectiveTo = null)
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π Account –≤ –∫–æ–º–ø–∞–Ω–∏–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

```bash
# –í —Ä–µ–∂–∏–º–µ dev
pnpm dev  # –ª–æ–≥–∏ –≤—ã–≤–æ–¥—è—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å

# –í production (PM2)
pm2 logs worker
```

## –°–ª–µ–¥—É—é—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

- [ ] API endpoint –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
- [ ] –ü–æ–¥–¥–µ—Ä–∂–∫–∞ weekly/biweekly –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç–∏
- [ ] Email/Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- [ ] –ò—Å—Ç–æ—Ä–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á
- [ ] Dry-run —Ä–µ–∂–∏–º

## –õ–∏—Ü–µ–Ω–∑–∏—è

MIT
