generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                      String              @id @default(uuid())
  companyId               String
  name                    String
  number                  String?
  currency                String              @default("RUB")
  openingBalance          Float               @default(0)
  excludeFromTotals       Boolean             @default(false)
  isActive                Boolean             @default(true)
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt
  company                 Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  importedOperations      ImportedOperation[]
  accountOperations       Operation[]         @relation("operations_accountIdToaccounts")
  sourceAccountOperations Operation[]         @relation("operations_sourceAccountIdToaccounts")
  targetAccountOperations Operation[]         @relation("operations_targetAccountIdToaccounts")
  planItems               PlanItem[]
  integrations            Integration[]

  @@index([companyId])
  @@map("accounts")
}

model Article {
  id                 String              @id @default(uuid())
  companyId          String
  name               String
  parentId           String?
  type               String
  activity           String?
  indicator          String?
  isActive           Boolean             @default(true)
  description        String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  counterpartyId     String?
  company            Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  counterparty       Counterparty?       @relation(fields: [counterpartyId], references: [id])
  parent             Article?            @relation("articlesToarticles", fields: [parentId], references: [id])
  children           Article[]           @relation("articlesToarticles")
  importedOperations ImportedOperation[]
  operations         Operation[]
  planItems          PlanItem[]
  integrations       Integration[]

  @@index([companyId])
  @@index([companyId, parentId])
  @@map("articles")
}

model AuditLog {
  id        String   @id @default(uuid())
  companyId String
  userId    String
  action    String
  entity    String
  entityId  String
  changes   Json?
  metadata  Json?
  createdAt DateTime @default(now())
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@index([companyId, createdAt])
  @@index([companyId, entity, entityId])
  @@index([companyId])
  @@index([companyId, userId])
  @@map("audit_logs")
}

model Budget {
  id         String     @id @default(uuid())
  companyId  String
  name       String
  startDate  DateTime
  endDate    DateTime?
  status     String     @default("active")
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  company    Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  plan_items PlanItem[]

  @@index([companyId, status])
  @@map("budgets")
}

model Company {
  id                  String              @id @default(uuid())
  name                String
  currencyBase        String              @default("RUB")
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  deletedAt           DateTime?
  uiSettings          Json?
  inn                 String?
  accounts            Account[]
  articles            Article[]
  audit_logs          AuditLog[]
  budgets             Budget[]
  counterparties      Counterparty[]
  deals               Deal[]
  departments         Department[]
  import_sessions     ImportSession[]
  imported_operations ImportedOperation[]
  integrations        Integration[]
  mapping_rules       MappingRule[]
  operations          Operation[]
  plan_items          PlanItem[]
  roles               Role[]
  salaries            Salary[]
  users               User[]

  @@map("companies")
}

model Counterparty {
  id                  String              @id @default(uuid())
  companyId           String
  name                String
  inn                 String?
  category            String
  description         String?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  articles            Article[]
  company             Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  deals               Deal[]
  imported_operations ImportedOperation[]
  operations          Operation[]
  salaries            Salary[]

  @@index([companyId])
  @@map("counterparties")
}

model Deal {
  id                  String              @id @default(uuid())
  companyId           String
  name                String
  amount              Float?
  departmentId        String?
  counterpartyId      String?
  description         String?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  company             Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  counterparty        Counterparty?       @relation(fields: [counterpartyId], references: [id])
  department          Department?         @relation(fields: [departmentId], references: [id])
  imported_operations ImportedOperation[]
  operations          Operation[]
  plan_items          PlanItem[]

  @@index([companyId])
  @@map("deals")
}

model Department {
  id                  String              @id @default(uuid())
  companyId           String
  name                String
  description         String?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  deals               Deal[]
  company             Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  imported_operations ImportedOperation[]
  operations          Operation[]
  salaries            Salary[]

  @@index([companyId])
  @@map("departments")
}

model EmailToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  type      String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  metadata  Json?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([type, used, expiresAt])
  @@map("email_tokens")
}

model ImportSession {
  id             String   @id @default(uuid())
  companyId      String
  userId         String? // кто загрузил (опционально для автоматических синхронизаций)
  fileName       String? // опционально для Ozon синхронизаций
  type           String   @default("bank") // bank|ozon|yandex
  integrationId  String? // ID интеграции для автоматических синхронизаций
  status         String   @default("draft") // draft|confirmed|processed|canceled|error|success
  importedCount  Int      @default(0) // всего строк из файла / получено записей
  confirmedCount Int      @default(0) // подтверждено пользователем
  processedCount Int      @default(0) // создано операций
  skippedCount   Int      @default(0) // пропущено (дубликаты)
  dataHash       String? // SHA256 хэш данных для идемпотентности
  lastError      String? // последняя ошибка
  retryCount     Int      @default(0) // количество попыток ретрая
  duration       Int? // длительность в миллисекундах
  periodFrom     DateTime? // период данных (для Ozon)
  periodTo       DateTime? // период данных (для Ozon)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  company            Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  integration        Integration?        @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  importedOperations ImportedOperation[]

  @@index([companyId, status])
  @@index([companyId, createdAt])
  @@index([companyId, type])
  @@index([integrationId])
  @@index([dataHash])
  @@map("import_sessions")
}

model ImportedOperation {
  id                    String   @id @default(uuid())
  importSessionId       String
  companyId             String
  // Данные из выписки
  date                  DateTime
  number                String? // номер документа
  amount                Float
  description           String // НазначениеПлатежа
  direction             String? // income|expense|transfer
  // Плательщик
  payer                 String?
  payerInn              String?
  payerAccount          String? // ПлательщикСчет
  // Получатель
  receiver              String?
  receiverInn           String?
  receiverAccount       String? // ПолучательСчет
  // Результаты автосопоставления
  matchedCounterpartyId String?
  matchedAccountId      String?
  matchedArticleId      String?
  matchedDealId         String?
  matchedDepartmentId   String?
  currency              String   @default("RUB")
  repeat                String   @default("none") // none|daily|weekly|monthly|quarterly|semiannual|annual
  matchedBy             String? // template|fuzzy|manual|null
  matchedRuleId         String? // ссылка на примененное правило
  // Статусы
  confirmed             Boolean  @default(false)
  processed             Boolean  @default(false)
  draft                 Boolean  @default(true)
  // Метаданные
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  importSession       ImportSession @relation(fields: [importSessionId], references: [id], onDelete: Cascade)
  company             Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  matchedArticle      Article?      @relation(fields: [matchedArticleId], references: [id], onDelete: SetNull)
  matchedCounterparty Counterparty? @relation(fields: [matchedCounterpartyId], references: [id], onDelete: SetNull)
  matchedAccount      Account?      @relation(fields: [matchedAccountId], references: [id], onDelete: SetNull)
  matchedDeal         Deal?         @relation(fields: [matchedDealId], references: [id], onDelete: SetNull)
  matchedDepartment   Department?   @relation(fields: [matchedDepartmentId], references: [id], onDelete: SetNull)
  matchedRule         MappingRule?  @relation(fields: [matchedRuleId], references: [id], onDelete: SetNull)

  @@index([companyId, importSessionId])
  @@index([companyId, confirmed, processed])
  @@index([importSessionId])
  @@map("imported_operations")
}

model MappingRule {
  id          String    @id @default(uuid())
  companyId   String
  userId      String // кто создал правило
  ruleType    String // contains|equals|regex|alias
  pattern     String // текст для поиска
  targetType  String // article|counterparty|account|operationType
  targetId    String? // ID сущности (если null, то targetName используется для создания)
  targetName  String? // читаемое имя для удобства
  sourceField String    @default("description") // description|receiver|payer|inn
  usageCount  Int       @default(0)
  lastUsedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  company            Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  importedOperations ImportedOperation[]

  @@index([companyId, ruleType, sourceField])
  @@index([companyId, targetType])
  @@map("mapping_rules")
}

model Operation {
  id                 String        @id @default(uuid())
  companyId          String
  type               String
  operationDate      DateTime
  amount             Float
  currency           String        @default("RUB")
  accountId          String?
  sourceAccountId    String?
  targetAccountId    String?
  articleId          String?
  counterpartyId     String?
  dealId             String?
  departmentId       String?
  description        String?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  isConfirmed        Boolean       @default(true)
  recurrenceEndDate  DateTime?
  recurrenceParentId String?
  repeat             String        @default("none")
  isTemplate         Boolean       @default(false)
  sourceHash         String?
  account            Account?      @relation("operations_accountIdToaccounts", fields: [accountId], references: [id])
  article            Article?      @relation(fields: [articleId], references: [id])
  company            Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  counterparty       Counterparty? @relation(fields: [counterpartyId], references: [id])
  deal               Deal?         @relation(fields: [dealId], references: [id])
  department         Department?   @relation(fields: [departmentId], references: [id])
  recurrenceParent   Operation?    @relation("operationsTooperations", fields: [recurrenceParentId], references: [id], onDelete: Cascade)
  childOperations    Operation[]   @relation("operationsTooperations")
  sourceAccount      Account?      @relation("operations_sourceAccountIdToaccounts", fields: [sourceAccountId], references: [id])
  targetAccount      Account?      @relation("operations_targetAccountIdToaccounts", fields: [targetAccountId], references: [id])

  @@index([companyId, accountId, operationDate])
  @@index([companyId, articleId, operationDate])
  @@index([companyId, operationDate])
  @@index([companyId, repeat, isConfirmed])
  @@index([companyId, repeat, isTemplate])
  @@index([recurrenceParentId, operationDate])
  @@map("operations")
}

model PlanItem {
  id          String    @id @default(uuid())
  companyId   String
  type        String
  startDate   DateTime
  endDate     DateTime?
  amount      Float
  currency    String    @default("RUB")
  articleId   String?
  accountId   String?
  dealId      String?
  repeat      String    @default("none")
  status      String    @default("active")
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  budgetId    String?
  account     Account?  @relation(fields: [accountId], references: [id])
  article     Article?  @relation(fields: [articleId], references: [id])
  budget      Budget?   @relation(fields: [budgetId], references: [id])
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  deal        Deal?     @relation(fields: [dealId], references: [id])

  @@index([companyId, budgetId, startDate])
  @@index([companyId, startDate, repeat])
  @@map("plan_items")
}

model RolePermission {
  id        String   @id @default(uuid())
  roleId    String
  entity    String
  action    String
  allowed   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, entity, action])
  @@index([roleId])
  @@map("role_permissions")
}

model Role {
  id               String           @id @default(uuid())
  companyId        String
  name             String
  description      String?
  category         String?
  isSystem         Boolean          @default(false)
  isActive         Boolean          @default(true)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  deletedAt        DateTime?
  role_permissions RolePermission[]
  company          Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user_roles       UserRole[]

  @@index([companyId])
  @@index([companyId, isActive])
  @@map("roles")
}

model Salary {
  id                     String       @id @default(uuid())
  companyId              String
  employeeCounterpartyId String
  departmentId           String?
  baseWage               Float
  contributionsPct       Float        @default(30.0)
  incomeTaxPct           Float        @default(13.0)
  periodicity            String       @default("monthly")
  effectiveFrom          DateTime
  effectiveTo            DateTime?
  createdAt              DateTime     @default(now())
  updatedAt              DateTime     @updatedAt
  company                Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  department             Department?  @relation(fields: [departmentId], references: [id])
  counterparty           Counterparty @relation(fields: [employeeCounterpartyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("salaries")
}

model UserRole {
  id         String   @id @default(uuid())
  userId     String
  roleId     String
  assignedAt DateTime @default(now())
  assignedBy String?
  role       Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([roleId])
  @@index([userId])
  @@map("user_roles")
}

model User {
  id              String       @id @default(uuid())
  companyId       String
  email           String       @unique
  passwordHash    String
  isActive        Boolean      @default(true)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  firstName       String?
  lastName        String?
  isEmailVerified Boolean      @default(false)
  isSuperAdmin    Boolean      @default(false)
  preferences     Json?
  audit_logs      AuditLog[]
  email_tokens    EmailToken[]
  user_roles      UserRole[]
  company         Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("users")
}

model Integration {
  id              String   @id @default(cuid())
  companyId       String
  type            String // 'ozon', 'yandex', etc.
  clientKey       String
  apiKey          String
  paymentSchedule String // 'next_week', 'week_after'
  articleId       String
  accountId       String
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations с обратными связями
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  article Article @relation(fields: [articleId], references: [id])
  account Account @relation(fields: [accountId], references: [id])
  importSessions ImportSession[]

  @@unique([companyId, type])
  @@index([companyId])
  @@index([articleId])
  @@index([accountId])
  @@map("integrations")
}