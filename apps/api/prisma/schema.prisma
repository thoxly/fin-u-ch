generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                      String              @id @default(uuid())
  companyId               String
  name                    String
  number                  String?
  currency                String              @default("RUB")
  openingBalance          Float               @default(0)
  excludeFromTotals       Boolean             @default(false)
  isActive                Boolean             @default(true)
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt
  company                 Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  importedOperations      ImportedOperation[]
  accountOperations       Operation[]         @relation("operations_accountIdToaccounts")
  sourceAccountOperations Operation[]         @relation("operations_sourceAccountIdToaccounts")
  targetAccountOperations Operation[]         @relation("operations_targetAccountIdToaccounts")
  planItems               PlanItem[]

  @@index([companyId])
  @@map("accounts")
}

model Article {
  id                 String              @id @default(uuid())
  companyId          String
  name               String
  parentId           String?
  type               String
  activity           String?
  indicator          String?
  isActive           Boolean             @default(true)
  description        String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  counterpartyId     String?
  company            Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  counterparty       Counterparty?       @relation(fields: [counterpartyId], references: [id])
  parent             Article?            @relation("articlesToarticles", fields: [parentId], references: [id])
  children           Article[]           @relation("articlesToarticles")
  importedOperations ImportedOperation[]
  operations         Operation[]
  planItems          PlanItem[]

  @@index([companyId])
  @@index([companyId, parentId])
  @@map("articles")
}

model AuditLog {
  id        String   @id @default(uuid())
  companyId String
  userId    String
  action    String
  entity    String
  entityId  String
  changes   Json?
  metadata  Json?
  createdAt DateTime @default(now())
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@index([companyId, createdAt])
  @@index([companyId, entity, entityId])
  @@index([companyId])
  @@index([companyId, userId])
  @@map("audit_logs")
}

model Budget {
  id         String     @id @default(uuid())
  companyId  String
  name       String
  startDate  DateTime
  endDate    DateTime?
  status     String     @default("active")
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  company    Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  plan_items PlanItem[]

  @@index([companyId, status])
  @@map("budgets")
}

model Company {
  id                  String              @id @default(uuid())
  name                String
  currencyBase        String              @default("RUB")
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  deletedAt           DateTime?
  uiSettings          Json?
  inn                 String?
  accounts            Account[]
  articles            Article[]
  audit_logs          AuditLog[]
  budgets             Budget[]
  counterparties      Counterparty[]
  deals               Deal[]
  departments         Department[]
  import_sessions     ImportSession[]
  imported_operations ImportedOperation[]
  mapping_rules       MappingRule[]
  operations          Operation[]
  plan_items          PlanItem[]
  roles               Role[]
<<<<<<< HEAD
  subscription        Subscription?
=======
  salaries            Salary[]
>>>>>>> 1af8208
  users               User[]

  @@map("companies")
}

model Counterparty {
  id                  String              @id @default(uuid())
  companyId           String
  name                String
  inn                 String?
  category            String
  description         String?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  articles            Article[]
  company             Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  deals               Deal[]
  imported_operations ImportedOperation[]
  operations          Operation[]

  @@index([companyId])
  @@map("counterparties")
}

model Deal {
  id                  String              @id @default(uuid())
  companyId           String
  name                String
  amount              Float?
  departmentId        String?
  counterpartyId      String?
  description         String?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  company             Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  counterparty        Counterparty?       @relation(fields: [counterpartyId], references: [id])
  department          Department?         @relation(fields: [departmentId], references: [id])
  imported_operations ImportedOperation[]
  operations          Operation[]
  plan_items          PlanItem[]

  @@index([companyId])
  @@map("deals")
}

model Department {
  id                  String              @id @default(uuid())
  companyId           String
  name                String
  description         String?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  deals               Deal[]
  company             Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  imported_operations ImportedOperation[]
  operations          Operation[]

  @@index([companyId])
  @@map("departments")
}

model EmailToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  type      String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  metadata  Json?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([type, used, expiresAt])
  @@index([userId])
  @@map("email_tokens")
}

model ImportSession {
  id                   String              @id @default(uuid())
  companyId            String
  userId               String
  fileName             String
  status               String              @default("draft")
  importedCount        Int                 @default(0)
  confirmedCount       Int                 @default(0)
  processedCount       Int                 @default(0)
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  companyAccountNumber String?             @map("company_account_number")
  company              Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  importedOperations   ImportedOperation[]

  @@index([companyId, createdAt])
  @@index([companyId, status])
  @@map("import_sessions")
}

model ImportedOperation {
  id                    String        @id @default(uuid())
  importSessionId       String
  companyId             String
  date                  DateTime
  number                String?
  amount                Float
  description           String
  direction             String?
  payer                 String?
  payerInn              String?
  payerAccount          String?
  receiver              String?
  receiverInn           String?
  receiverAccount       String?
  matchedArticleId      String?
  matchedCounterpartyId String?
  matchedAccountId      String?
  matchedBy             String?
  matchedRuleId         String?
  confirmed             Boolean       @default(false)
  processed             Boolean       @default(false)
  draft                 Boolean       @default(true)
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  currency              String        @default("RUB")
  matchedDealId         String?
  matchedDepartmentId   String?
  repeat                String        @default("none")
  lockedFields          String?       @default("[]")
  duplicateOfId         String?
  isDuplicate           Boolean       @default(false)
  company               Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  importSession         ImportSession @relation(fields: [importSessionId], references: [id], onDelete: Cascade)
  account               Account?      @relation(fields: [matchedAccountId], references: [id])
  article               Article?      @relation(fields: [matchedArticleId], references: [id])
  counterparty          Counterparty? @relation(fields: [matchedCounterpartyId], references: [id])
  deal                  Deal?         @relation(fields: [matchedDealId], references: [id])
  department            Department?   @relation(fields: [matchedDepartmentId], references: [id])
  mapping_rule          MappingRule?  @relation(fields: [matchedRuleId], references: [id])

  @@index([companyId, confirmed, processed])
  @@index([companyId, importSessionId])
  @@index([importSessionId])
  @@map("imported_operations")
}

model MappingRule {
  id                  String              @id @default(uuid())
  companyId           String
  userId              String
  ruleType            String
  pattern             String
  targetType          String
  targetId            String?
  targetName          String?
  sourceField         String              @default("description")
  usageCount          Int                 @default(0)
  lastUsedAt          DateTime?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  imported_operations ImportedOperation[]
  company             Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, ruleType, sourceField])
  @@index([companyId, targetType])
  @@map("mapping_rules")
}

model Operation {
  id                 String        @id @default(uuid())
  companyId          String
  type               String
  operationDate      DateTime
  amount             Float
  currency           String        @default("RUB")
  accountId          String?
  sourceAccountId    String?
  targetAccountId    String?
  articleId          String?
  counterpartyId     String?
  dealId             String?
  departmentId       String?
  description        String?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  isConfirmed        Boolean       @default(true)
  recurrenceEndDate  DateTime?
  recurrenceParentId String?
  repeat             String        @default("none")
  isTemplate         Boolean       @default(false)
  sourceHash         String?
  account            Account?      @relation("operations_accountIdToaccounts", fields: [accountId], references: [id])
  article            Article?      @relation(fields: [articleId], references: [id])
  company            Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  counterparty       Counterparty? @relation(fields: [counterpartyId], references: [id])
  deal               Deal?         @relation(fields: [dealId], references: [id])
  department         Department?   @relation(fields: [departmentId], references: [id])
  recurrenceParent   Operation?    @relation("operationsTooperations", fields: [recurrenceParentId], references: [id], onDelete: Cascade)
  childOperations    Operation[]   @relation("operationsTooperations")
  sourceAccount      Account?      @relation("operations_sourceAccountIdToaccounts", fields: [sourceAccountId], references: [id])
  targetAccount      Account?      @relation("operations_targetAccountIdToaccounts", fields: [targetAccountId], references: [id])

  @@index([companyId, accountId, operationDate])
  @@index([companyId, articleId, operationDate])
  @@index([companyId, operationDate])
  @@index([companyId, repeat, isConfirmed])
  @@index([companyId, repeat, isTemplate])
  @@index([recurrenceParentId, operationDate])
  @@map("operations")
}

model PlanItem {
  id          String    @id @default(uuid())
  companyId   String
  type        String
  startDate   DateTime
  endDate     DateTime?
  amount      Float
  currency    String    @default("RUB")
  articleId   String?
  accountId   String?
  dealId      String?
  repeat      String    @default("none")
  status      String    @default("active")
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  budgetId    String?
  account     Account?  @relation(fields: [accountId], references: [id])
  article     Article?  @relation(fields: [articleId], references: [id])
  budget      Budget?   @relation(fields: [budgetId], references: [id])
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  deal        Deal?     @relation(fields: [dealId], references: [id])

  @@index([companyId, budgetId, startDate])
  @@index([companyId, startDate, repeat])
  @@map("plan_items")
}

model RolePermission {
  id        String   @id @default(uuid())
  roleId    String
  entity    String
  action    String
  allowed   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, entity, action])
  @@index([roleId])
  @@map("role_permissions")
}

model Role {
  id               String           @id @default(uuid())
  companyId        String
  name             String
  description      String?
  category         String?
  isSystem         Boolean          @default(false)
  isActive         Boolean          @default(true)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  deletedAt        DateTime?
  role_permissions RolePermission[]
  company          Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user_roles       UserRole[]

  @@index([companyId])
  @@index([companyId, isActive])
  @@map("roles")
}

model UserRole {
  id         String   @id @default(uuid())
  userId     String
  roleId     String
  assignedAt DateTime @default(now())
  assignedBy String?
  role       Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([roleId])
  @@index([userId])
  @@map("user_roles")
}

model User {
  id              String       @id @default(uuid())
  companyId       String
  email           String       @unique
  passwordHash    String
  isActive        Boolean      @default(true)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  firstName       String?
  lastName        String?
  isEmailVerified Boolean      @default(false)
  isSuperAdmin    Boolean      @default(false)
  preferences     Json?
  audit_logs      AuditLog[]
  email_tokens    EmailToken[]
  user_roles      UserRole[]
  company         Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("users")
}
