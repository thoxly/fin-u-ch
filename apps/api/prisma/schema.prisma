generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id                 String              @id @default(uuid())
  name               String
  currencyBase       String              @default("RUB")
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  deletedAt          DateTime?
  uiSettings         Json?
  inn                String?
  accounts           Account[]
  articles           Article[]
  budgets            Budget[]
  counterparties     Counterparty[]
  deals              Deal[]
  departments        Department[]
  importSessions     ImportSession[]
  importedOperations ImportedOperation[]
  mappingRules       MappingRule[]
  operations         Operation[]
  planItems          PlanItem[]
  salaries           Salary[]
  users              User[]

  @@map("companies")
}

model User {
  id                  String       @id @default(uuid())
  companyId           String
  email               String       @unique
  passwordHash        String
  isActive            Boolean      @default(true)
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  firstName           String?
  lastName            String?
  onboardingCompleted Boolean      @default(false)
  isEmailVerified     Boolean      @default(false)
  emailTokens         EmailToken[]
  company             Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("users")
}

model Account {
  id                 String              @id @default(uuid())
  companyId          String
  name               String
  number             String?
  currency           String              @default("RUB")
  openingBalance     Float               @default(0)
  excludeFromTotals  Boolean             @default(false)
  isActive           Boolean             @default(true)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  company            Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  importedOperations ImportedOperation[]
  operations         Operation[]         @relation("AccountOperations")
  sourceOperations   Operation[]         @relation("SourceAccountOperations")
  targetOperations   Operation[]         @relation("TargetAccountOperations")
  planItems          PlanItem[]

  @@index([companyId])
  @@map("accounts")
}

model Department {
  id                 String              @id @default(uuid())
  companyId          String
  name               String
  description        String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  deals              Deal[]
  company            Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  importedOperations ImportedOperation[]
  operations         Operation[]
  salaries           Salary[]

  @@index([companyId])
  @@map("departments")
}

model Counterparty {
  id                 String              @id @default(uuid())
  companyId          String
  name               String
  inn                String?
  category           String
  description        String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  articles           Article[]
  company            Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  deals              Deal[]
  importedOperations ImportedOperation[]
  operations         Operation[]
  salaries           Salary[]

  @@index([companyId])
  @@map("counterparties")
}

model Deal {
  id                 String              @id @default(uuid())
  companyId          String
  name               String
  amount             Float?
  departmentId       String?
  counterpartyId     String?
  description        String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  company            Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  counterparty       Counterparty?       @relation(fields: [counterpartyId], references: [id])
  department         Department?         @relation(fields: [departmentId], references: [id])
  importedOperations ImportedOperation[]
  operations         Operation[]
  planItems          PlanItem[]

  @@index([companyId])
  @@map("deals")
}

model Article {
  id                 String              @id @default(uuid())
  companyId          String
  name               String
  parentId           String?
  type               String
  activity           String?
  indicator          String?
  isActive           Boolean             @default(true)
  description        String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  counterpartyId     String?
  company            Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  counterparty       Counterparty?       @relation(fields: [counterpartyId], references: [id])
  parent             Article?            @relation("ArticleHierarchy", fields: [parentId], references: [id])
  children           Article[]           @relation("ArticleHierarchy")
  importedOperations ImportedOperation[]
  operations         Operation[]
  planItems          PlanItem[]

  @@index([companyId])
  @@index([companyId, parentId])
  @@map("articles")
}

model Operation {
  id                 String        @id @default(uuid())
  companyId          String
  type               String
  operationDate      DateTime
  amount             Float
  currency           String        @default("RUB")
  accountId          String?
  sourceAccountId    String?
  targetAccountId    String?
  articleId          String?
  counterpartyId     String?
  dealId             String?
  departmentId       String?
  description        String?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  isConfirmed        Boolean       @default(true)
  recurrenceEndDate  DateTime?
  recurrenceParentId String?
  repeat             String        @default("none")
  isTemplate         Boolean       @default(false)
  sourceHash         String?
  account            Account?      @relation("AccountOperations", fields: [accountId], references: [id])
  article            Article?      @relation(fields: [articleId], references: [id])
  company            Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  counterparty       Counterparty? @relation(fields: [counterpartyId], references: [id])
  deal               Deal?         @relation(fields: [dealId], references: [id])
  department         Department?   @relation(fields: [departmentId], references: [id])
  recurrenceParent   Operation?    @relation("RecurringOperations", fields: [recurrenceParentId], references: [id], onDelete: Cascade)
  recurrenceChildren Operation[]   @relation("RecurringOperations")
  sourceAccount      Account?      @relation("SourceAccountOperations", fields: [sourceAccountId], references: [id])
  targetAccount      Account?      @relation("TargetAccountOperations", fields: [targetAccountId], references: [id])

  @@index([companyId, operationDate])
  @@index([companyId, articleId, operationDate])
  @@index([companyId, accountId, operationDate])
  @@index([companyId, repeat, isConfirmed])
  @@index([companyId, repeat, isTemplate])
  @@index([recurrenceParentId, operationDate])
  @@index([companyId, sourceHash])
  @@map("operations")
}

model PlanItem {
  id          String    @id @default(uuid())
  companyId   String
  type        String
  startDate   DateTime
  endDate     DateTime?
  amount      Float
  currency    String    @default("RUB")
  articleId   String?
  accountId   String?
  dealId      String?
  repeat      String    @default("none")
  status      String    @default("active")
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  budgetId    String?
  account     Account?  @relation(fields: [accountId], references: [id])
  article     Article?  @relation(fields: [articleId], references: [id])
  budget      Budget?   @relation(fields: [budgetId], references: [id])
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  deal        Deal?     @relation(fields: [dealId], references: [id])

  @@index([companyId, startDate, repeat])
  @@index([companyId, budgetId, startDate])
  @@map("plan_items")
}

model Salary {
  id                     String       @id @default(uuid())
  companyId              String
  employeeCounterpartyId String
  departmentId           String?
  baseWage               Float
  contributionsPct       Float        @default(30.0)
  incomeTaxPct           Float        @default(13.0)
  periodicity            String       @default("monthly")
  effectiveFrom          DateTime
  effectiveTo            DateTime?
  createdAt              DateTime     @default(now())
  updatedAt              DateTime     @updatedAt
  company                Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  department             Department?  @relation(fields: [departmentId], references: [id])
  employeeCounterparty   Counterparty @relation(fields: [employeeCounterpartyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("salaries")
}

model Budget {
  id        String     @id @default(uuid())
  companyId String
  name      String
  startDate DateTime
  endDate   DateTime?
  status    String     @default("active")
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  company   Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  planItems PlanItem[]

  @@index([companyId, status])
  @@map("budgets")
}

model ImportSession {
  id                   String              @id @default(uuid())
  companyId            String
  userId               String // кто загрузил
  fileName             String
  companyAccountNumber String?             @map("company_account_number") // номер расчетного счета из файла (РасчСчет)
  status               String              @default("draft") // draft|confirmed|processed|canceled
  importedCount        Int                 @default(0) // всего строк из файла
  confirmedCount       Int                 @default(0) // подтверждено пользователем
  processedCount       Int                 @default(0) // создано операций
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  company              Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  importedOperations   ImportedOperation[]

  @@index([companyId, status])
  @@index([companyId, createdAt])
  @@map("import_sessions")
}

model ImportedOperation {
  id                    String        @id @default(uuid())
  importSessionId       String
  companyId             String
  date                  DateTime
  number                String?
  amount                Float
  description           String
  direction             String?
  payer                 String?
  payerInn              String?
  payerAccount          String?
  receiver              String?
  receiverInn           String?
  receiverAccount       String?
  matchedArticleId      String?
  matchedCounterpartyId String?
  matchedAccountId      String?
  matchedBy             String?
  matchedRuleId         String?
  confirmed             Boolean       @default(false)
  processed             Boolean       @default(false)
  draft                 Boolean       @default(true)
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  currency              String        @default("RUB")
  matchedDealId         String?
  matchedDepartmentId   String?
  repeat                String        @default("none")
  isDuplicate           Boolean       @default(false)
  duplicateOfId         String?
  lockedFields          String?       @default("[]")
  company               Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  importSession         ImportSession @relation(fields: [importSessionId], references: [id], onDelete: Cascade)
  matchedAccount        Account?      @relation(fields: [matchedAccountId], references: [id])
  matchedArticle        Article?      @relation(fields: [matchedArticleId], references: [id])
  matchedCounterparty   Counterparty? @relation(fields: [matchedCounterpartyId], references: [id])
  matchedDeal           Deal?         @relation(fields: [matchedDealId], references: [id])
  matchedDepartment     Department?   @relation(fields: [matchedDepartmentId], references: [id])
  matchedRule           MappingRule?  @relation(fields: [matchedRuleId], references: [id])

  @@index([companyId, importSessionId])
  @@index([companyId, confirmed, processed])
  @@index([companyId, isDuplicate])
  @@index([importSessionId])
  @@map("imported_operations")
}

model MappingRule {
  id                 String              @id @default(uuid())
  companyId          String
  userId             String
  ruleType           String
  pattern            String
  targetType         String
  targetId           String?
  targetName         String?
  sourceField        String              @default("description")
  usageCount         Int                 @default(0)
  lastUsedAt         DateTime?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  importedOperations ImportedOperation[]
  company            Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, ruleType, sourceField])
  @@index([companyId, targetType])
  @@map("mapping_rules")
}

model EmailToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  type      String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  metadata  Json?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([type, used, expiresAt])
  @@map("email_tokens")
}
