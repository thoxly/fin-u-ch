# Error Handling Utilities

Унифицированная система обработки и логирования ошибок для консистентного поведения во всем приложении. Предоставляет функции для форматирования ошибок, логирования с контекстом и обработки ошибок в батчах. Используется во всех сервисах для единообразного логирования и обработки исключений.

Функция `formatError` преобразует любую ошибку в читаемую строку, обрабатывая разные типы ошибок. Если ошибка является экземпляром `Error`, извлекается `message`. Если это строка, возвращается как есть. Для других типов выполняется преобразование через `String()`. Это гарантирует, что любая ошибка может быть безопасно преобразована в строку для логирования или отображения пользователю без риска падения приложения.

Функция `logError` обеспечивает консистентное логирование ошибок через Winston с автоматическим добавлением контекста. Помимо сообщения об ошибке и stack trace, функция принимает объект `context` с дополнительной информацией (userId, companyId, operationId и т.д.), которая помогает в отладке. Все данные логируются в структурированном формате JSON, что позволяет легко фильтровать и анализировать логи. Функция автоматически извлекает stack trace из Error объектов, что критично для отладки проблем в production.

Обработка ошибок в батчах выполняется через функции `handleBatchErrors` и `createBatchErrorInfo`. `createBatchErrorInfo` создает структурированный объект ошибки с полями: `index` (позиция элемента в батче), `message` (сообщение об ошибке), `error` (оригинальный Error объект), `context` (дополнительный контекст). `handleBatchErrors` принимает массив таких объектов и операцию, формирует массив читаемых сообщений об ошибках в формате `[operationName] Item {index}: {message}`, и логирует каждую ошибку через `logError`. Это позволяет обработать множество ошибок из батча и представить их в удобном формате для пользователя или логов.

Использование утилит обеспечивает единообразие формата логов во всем приложении, что критично для мониторинга и отладки. Все ошибки логируются с одинаковой структурой, что упрощает поиск и анализ проблем через системы логирования (Loki, ELK и т.д.). Контекстная информация позволяет быстро найти связанные ошибки и понять последовательность событий, приведших к проблеме. Рекомендуется использовать эти утилиты вместо прямого вызова `logger.error` для обеспечения консистентности.

**Ключевые файлы:** `error-handler.ts` (функции `formatError`, `logError`, `handleBatchErrors`, `createBatchErrorInfo`), `error-handler.types.ts` (типы `ErrorContext`, `BatchErrorInfo`). Для использования импортируйте нужные функции и вызывайте при обработке ошибок. В try-catch блоках используйте `logError` для логирования, `formatError` для преобразования в строку. В батчах используйте `createBatchErrorInfo` для создания структурированных ошибок и `handleBatchErrors` для их обработки. Для отладки проверяйте логи с контекстной информацией - она поможет быстро найти причину проблемы.
