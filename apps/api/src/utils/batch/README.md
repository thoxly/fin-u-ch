# Batch Processing Utilities

Универсальная система обработки больших массивов данных батчами в транзакциях Prisma. Используется для импорта операций, обработки файлов выписок и других операций, требующих обработки больших объемов данных. Поддерживает настраиваемые размеры батчей, таймауты транзакций и обработчики ошибок на уровне элементов и батчей.

Разбиение на батчи выполняется простым делением массива на части указанного размера (по умолчанию 50 элементов). Размер батча выбирается исходя из сложности обработки одного элемента и ограничений транзакций БД. Для операций с автосопоставлением рекомендуется 50, так как каждая операция требует нескольких запросов к БД (поиск контрагента, статьи, счета, применение правил). Для простых операций можно увеличить размер до 100-200. Для очень сложных операций (с множественными зависимостями) размер можно уменьшить до 20-30.

Каждый батч обрабатывается в отдельной транзакции Prisma для обеспечения атомарности и возможности отката при ошибках. Транзакция имеет два таймаута: `maxWait` (30 секунд по умолчанию) - максимальное время ожидания начала транзакции при блокировках БД, и `timeout` (5 минут по умолчанию) - максимальное время выполнения транзакции. Для больших батчей с сложной обработкой таймауты можно увеличить, но это может привести к долгим блокировкам БД. Функция-обработчик получает элемент и транзакционный клиент Prisma (`tx`), что позволяет выполнять все операции в рамках одной транзакции.

Обработка ошибок выполняется на двух уровнях. На уровне элемента: если обработка одного элемента падает с ошибкой, ошибка перехватывается, логируется через callback `onItemError` (если указан), элемент помечается как ошибочный в результатах, но обработка остальных элементов батча продолжается. Это позволяет обработать максимальное количество элементов даже при частичных ошибках. На уровне батча: если вся транзакция падает с ошибкой (например, таймаут или ошибка БД), все элементы батча помечаются как ошибочные, ошибка логируется через callback `onBatchError`, но обработка следующих батчей продолжается. Это гарантирует, что проблемы с одним батчем не блокируют обработку остальных данных.

Результаты обработки собираются в объект `BatchResult` с полями: `success` (количество успешно обработанных элементов), `errors` (количество ошибочных элементов), `results` (массив результатов обработки для каждого элемента), `errorMessages` (массив сообщений об ошибках, опционально). Это позволяет вызывающему коду получить полную информацию о результатах обработки и принять решение о дальнейших действиях (например, повторить обработку ошибочных элементов или уведомить пользователя). Результаты можно использовать для формирования ответа пользователю с информацией о количестве успешно импортированных операций и ошибках.

**Ключевые файлы:** `batch-processor.ts` (класс `BatchProcessor` с методом `processBatches`), `batch.types.ts` (типы `BatchProcessorOptions`, `BatchResult`). Для использования создайте экземпляр `BatchProcessor` с нужным размером батча, вызовите `processBatches` с массивом элементов и функцией-обработчиком, при необходимости передайте опции (таймауты, обработчики ошибок). Пример использования можно найти в `imports.service.ts` (метод `createImportedOperations`) и `operation-import.service.ts` (метод `importOperations`). Для отладки используйте обработчики `onItemError` и `onBatchError` для детального логирования проблем.
