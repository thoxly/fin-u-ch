# Currency Conversion System

Система конвертации валют для мультивалютных операций. Все конвертации выполняются через базовую валюту компании (обычно RUB) по формуле: `amount * fromRate / toRate`, где курсы берутся из внешнего API с кэшированием. Для transfer операций используется особая логика: sourceAccount всегда в своей валюте, targetAccount всегда в базовой валюте компании.

Получение курсов валют выполняется через внешний API (настраивается через переменные окружения) с кэшированием результатов в памяти на время жизни запроса. Курсы всегда получаются относительно базовой валюты (RUB) - если нужен курс между двумя другими валютами, конвертация идет через RUB. Система поддерживает исторические курсы - при указании даты запрашивается курс на эту дату, что критично для корректного отображения старых операций. Если курс на указанную дату недоступен, используется курс на текущую дату с предупреждением в логах. Курсы кэшируются для оптимизации - повторные запросы на ту же дату используют кэш.

Конвертация сумм выполняется через базовую валюту компании. Формула: сначала исходная сумма умножается на курс исходной валюты к RUB (получаем сумму в рублях), затем делится на курс целевой валюты к RUB (получаем сумму в целевой валюте). Результат округляется до 2 знаков после запятой. Если валюты одинаковые, конвертация не выполняется. При отсутствии курса для валюты выбрасывается ошибка - система не выполняет конвертацию с несуществующими курсами.

Определение валюты операции зависит от типа операции. Для income/expense операций валюта берется из валюты счета (`account.currency`), если счет указан. Если счет не найден, используется валюта из поля `operation.currency`. Для transfer операций используется особая логика: sourceAccount всегда в своей валюте (для отображения списания), targetAccount всегда в базовой валюте компании (для отображения поступления). Это позволяет корректно отображать переводы между счетами в разных валютах - списание показывается в валюте исходного счета, поступление в базовой валюте.

При создании операций система автоматически пересчитывает сумму в базовую валюту компании и сохраняет оригинальные значения в полях `originalAmount` и `originalCurrency`. Это позволяет сохранить точность данных - если курс изменится, оригинальная сумма останется неизменной. В отчетах все суммы автоматически конвертируются в базовую валюту для единообразия, но при необходимости можно отобразить оригинальные значения. Пересчет выполняется с использованием курса на дату операции для исторической точности.

**Ключевые файлы:** `currency.service.ts` (методы `getRates`, `convert`, `convertToBase`), `utils/currency-converter.ts` (функции `convertOperationAmountToBase`, `convertOperationsToBase`, `getOperationCurrency`). Курсы кэшируются в памяти на время запроса. Для изменения источника курсов редактируйте метод `getRates` в `currency.service.ts`. Базовая валюта компании хранится в `company.currencyBase` и по умолчанию равна 'RUB'. Для отладки конвертации проверяйте логи с информацией о курсах и результатах конвертации.
