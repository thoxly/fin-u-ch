# Subscription & Limits System

Система управления подписками и проверки лимитов для тарифных планов (START, PRO, ENTERPRISE). Автоматически создает подписку START при регистрации компании, проверяет лимиты на пользователей через middleware `user-limit.guard.ts`, и поддерживает промокоды для активации планов с ограниченным сроком действия или количеством использований.

Тарифные планы определяют лимиты и доступные функции через конфигурацию в `utils/subscription.ts`. План START имеет базовые лимиты (например, 3 пользователя), PRO - расширенные (10 пользователей, дополнительные функции), ENTERPRISE - без лимитов (unlimited). Каждый план имеет список доступных функций (`features`), которые проверяются в коде для включения/отключения функциональности. При создании компании автоматически создается подписка START с дефолтными настройками, если подписка не была создана явно.

Проверка лимитов выполняется в нескольких местах. Middleware `user-limit.guard.ts` проверяет лимит пользователей перед созданием нового пользователя - если текущее количество активных пользователей достигло максимума для плана, запрос блокируется с ошибкой 403. Метод `checkAndEnforceLimits` в `subscription.service.ts` выполняет полную проверку всех лимитов и может быть вызван вручную для валидации состояния подписки. Лимиты рассчитываются динамически через `getUserLimitInfo`, который учитывает текущее количество пользователей, максимальное для плана, и флаг `isUnlimited` для планов без ограничений.

Промокоды позволяют активировать планы с ограничениями. Промокод имеет поля: `code` (уникальный код), `plan` (план для активации), `durationDays` (длительность действия в днях), `maxUsages` (максимальное количество использований, null = безлимит), `usedCount` (текущее количество использований), `expiresAt` (дата истечения, null = бессрочно), `isActive` (флаг активности). Валидация промокода проверяет все эти условия - если промокод неактивен, истек, или достигнут лимит использований, активация отклоняется. При успешной активации обновляется счетчик `usedCount` и создается/обновляется подписка компании с указанным планом и сроком действия.

Триальные периоды обрабатываются автоматически через поле `trialEndsAt` в подписке. При создании подписки с триалом устанавливается дата окончания триала, после которой подписка должна перейти в платный режим или быть отменена. Система проверяет статус подписки и дату окончания триала при каждом обращении к подписке. При окончании триала подписка может автоматически перейти в статус `cancelled` или остаться активной в зависимости от настроек бизнес-логики. Подписки также имеют поля `startDate` и `endDate` для отслеживания периода действия.

**Ключевые файлы:** `subscription.service.ts` (методы `getCurrentSubscription`, `createSubscription`, `activatePromoCode`, `checkAndEnforceLimits`), `promo-code.service.ts` (методы `validatePromoCode`, `applyPromoCode`), `utils/subscription.ts` (функции `getPlanLimitsUtil`, `getUserLimitInfo`, `getCompanyPlan`). Лимиты планов определяются в `getPlanLimitsUtil` - для добавления нового плана расширьте enum `SubscriptionPlan` в схеме Prisma, добавьте конфигурацию лимитов в утилиту, и обновите бизнес-логику проверки лимитов. Middleware `user-limit.guard.ts` и `subscription.guard.ts` используются для автоматической проверки лимитов на уровне API endpoints.
