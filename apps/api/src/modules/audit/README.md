# Audit Logging System

Система логирования всех действий пользователей для аудита и отладки. Автоматически записывает в таблицу `audit_log` все CRUD операции над основными сущностями (операции, справочники, пользователи и т.д.) с информацией о пользователе, действии, сущности и изменениях.

Логирование выполняется через метод `logAction` в `audit.service.ts`, который принимает параметры: `userId`, `companyId`, `action` (create/update/delete), `entity` (тип сущности: operation/article/counterparty/account/user и т.д.), `entityId` (ID измененной сущности), `changes` (объект с изменениями в формате JSON), и опционально `ipAddress`, `userAgent`, `metadata` (дополнительные данные). Метод создает запись в таблице `audit_log` с полной информацией о действии для последующего анализа.

Логируются все критичные операции в системе. Создание, обновление и удаление операций - для отслеживания изменений финансовых данных. Изменения в справочниках (статьи, контрагенты, счета) - для отслеживания изменений структуры данных. Изменения в системе прав и пользователях - для безопасности и аудита доступа. Импорт операций - для отслеживания массовых изменений данных. Действия с подписками и промокодами - для отслеживания изменений тарифов. Каждая запись содержит полный контекст действия для возможности восстановления истории изменений.

Поле `changes` хранит JSON объект с детальной информацией об изменениях. Для операций `create` это все поля созданной сущности. Для операций `update` это объект с полями `before` (старые значения) и `after` (новые значения) для измененных полей. Для операций `delete` это все поля удаленной сущности. Это позволяет восстановить состояние данных на любой момент времени и отследить, кто и когда внес изменения. JSON формат обеспечивает гибкость для разных типов сущностей.

Просмотр логов выполняется через API endpoint `/api/audit/logs` с поддержкой фильтрации. Можно фильтровать по `userId` (действия конкретного пользователя), `companyId` (действия в компании), `entity` (действия с конкретным типом сущности), `entityId` (действия с конкретной сущностью), `action` (тип действия), и диапазону дат (`from`, `to`). Это позволяет быстро найти нужные записи для анализа или отладки. Логи можно экспортировать для внешнего анализа или архивирования.

**Ключевые файлы:** `audit.service.ts` (метод `logAction(userId, companyId, action, entity, entityId, changes, options?)`), вызывается автоматически через middleware (если настроено) или вручную в сервисах после операций. Для добавления логирования новой сущности вызовите `auditService.logAction` после операции с соответствующими параметрами. Записи можно просматривать через API endpoint `/api/audit/logs` с фильтрацией. Для оптимизации при больших объемах логов можно добавить партиционирование таблицы по датам или автоматическую очистку старых записей через worker job. Для безопасности доступ к логам должен быть ограничен администраторами компании.
