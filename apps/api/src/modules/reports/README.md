# Reports Generation System

Система генерации финансовых отчетов (ОДДС, БДДС, План-факт, Dashboard) с агрегацией данных и кэшированием результатов. Все отчеты используют единую стратегию кэширования в Redis с TTL 5 минут и автоматической инвалидацией при изменении операций или планов. Ключ кэша формируется как `report:{companyId}:{reportType}:{hash(params)}`, что гарантирует уникальность для разных параметров запроса.

Кэширование отчетов критично для производительности, так как генерация требует сложных агрегаций и может занимать несколько секунд для больших периодов. Перед генерацией всегда проверяется кэш через `getCachedReport` - если данные найдены, они возвращаются немедленно. После генерации результат сохраняется в кэш через `cacheReport` с TTL 300 секунд (5 минут). Ключ кэша включает все параметры запроса (период, фильтры, breakdown и т.д.) через хэш, что гарантирует корректность кэша для разных запросов. Инвалидация кэша выполняется автоматически при создании/обновлении операций или планов через `invalidateReportCache(companyId)`, которая удаляет все ключи кэша для компании.

ОДДС (Cashflow) отчет группирует операции по иерархии: сначала по activity (operating/investing/financing), затем по type (income/expense), затем по article, и наконец по месяцам. Transfer операции специально исключаются из денежного потока - они не попадают в income/expense группы, но учитываются при расчете остатков на счетах. Это соответствует стандартам финансовой отчетности, где переводы между счетами не являются денежным потоком. Отчет поддерживает фильтрацию по родительской статье (через `parentArticleId`) - при указании автоматически включаются все дочерние статьи через рекурсивный алгоритм. Все суммы конвертируются в базовую валюту компании с использованием курсов на дату операции.

БДДС (BDDS) отчет работает с плановыми данными из PlanItem, которые разворачиваются в помесячные суммы через функцию `expandPlan`. Планы с периодичностью daily разворачиваются в операции на каждый день периода, monthly - в одну операцию на месяц, и т.д. Отчет группирует планы по activity и type, создавая структуру с income и expense группами для каждой activity. Каждая группа содержит статьи с помесячными суммами. Отчет работает только с активными планами (`status: 'active'`) и учитывает даты начала и окончания планов. При указании `budgetId` отображаются только планы из этого бюджета, что позволяет анализировать выполнение конкретного бюджета.

План-факт анализ объединяет плановые данные (из PlanItem через `expandPlan`) и фактические данные (из Operation) по ключам сопоставления. Ключ формируется как комбинация месяца (формат YYYY-MM) и идентификатора (articleId, dealId или departmentId в зависимости от уровня детализации). Планы разворачиваются в помесячные суммы, факты агрегируются по месяцам и идентификаторам, затем объединяются по ключам. Для каждой комбинации рассчитывается дельта как `fact - plan`, что показывает отклонение фактических данных от плановых. Отчет поддерживает три уровня детализации: по статьям (article), по сделкам (deal) и по подразделениям (department). Все данные конвертируются в базовую валюту для корректного сравнения.

**Ключевые файлы:** `cashflow/cashflow.service.ts` (метод `getCashflow`), `bdds/bdds.service.ts` (метод `getBDDS`), `planfact/planfact.service.ts` (метод `getPlanFact`), `dashboard/dashboard.service.ts` (метод `getDashboard`), `utils/cache.ts` (функции `cacheReport`, `getCachedReport`, `invalidateReportCache`, `generateCacheKey`). Для добавления нового типа отчета создайте сервис по аналогии, используйте `generateCacheKey` для создания ключа, `getCachedReport` перед генерацией, `cacheReport` после генерации. Не забудьте вызывать `invalidateReportCache` при изменении данных. Для отладки проверяйте логи с информацией о кэшировании и времени генерации.
