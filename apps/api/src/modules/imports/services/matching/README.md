# Auto-Matching System

Система автоматического сопоставления операций из банковских выписок со справочниками (статьи, контрагенты, счета). Работает в несколько этапов: сначала определяется направление операции (income/expense/transfer) на основе ИНН компании и номеров счетов, затем последовательно сопоставляются контрагент (по ИНН → правилам → fuzzy match), статья (по правилам → ключевым словам) и счет (по номеру). Приоритет сопоставления: правила маппинга > ключевые слова > ИНН > fuzzy match > номер счета.

Определение направления операции использует алгоритм из shared пакета `determineOperationDirection`, который анализирует ИНН плательщика и получателя относительно ИНН компании, номера счетов и текст назначения платежа. Если payerInn совпадает с companyInn - это expense (расход), если receiverInn совпадает - income (доход), если оба совпадают - transfer (перевод). При отсутствии ИНН система анализирует номера счетов: если payerAccount или receiverAccount совпадает со счетами компании, направление определяется соответственно. Если направление не удалось определить, система пробует сопоставить и для income, и для expense типов статей.

Сопоставление контрагентов выполняется в строгом порядке приоритетов. Сначала проверяется точное совпадение по ИНН (100% надежность) - если payerInn или receiverInn найдено в справочнике контрагентов, сопоставление завершается. Затем применяются правила маппинга в порядке точности: equals (точное совпадение названия), alias (специальный тип для контрагентов с частичным совпадением), contains (широкий поиск по подстроке). Если правила не сработали и направление известно, выполняется fuzzy match по названию контрагента с использованием библиотеки string-similarity и порогом ≥0.8. Для оптимизации при большом количестве контрагентов (>1000) fuzzy match пропускается.

Сопоставление статей также использует многоуровневую логику. Сначала проверяются правила маппинга по назначению платежа в порядке: equals (точное совпадение текста), regex (гибкое совпадение через регулярные выражения), contains (поиск подстроки). Правила проверяются для каждого типа статьи (income/expense) в зависимости от определенного направления. Если правила не сработали, применяются предустановленные правила по ключевым словам из `keyword-rules.config.ts` - система проверяет наличие ключевых слов в назначении платежа и ищет соответствующую статью по названию. Специальная логика исключает НДС в составе оплаты (например, "оплата за услуги, в том числе НДС 20%") от попадания в статью "Налоги" - для этого используются паттерны типа "в том числе НДС", "т.ч. НДС", "с НДС" и проверка контекста оплаты.

Результат сопоставления сохраняется в поле `matchedBy`, которое указывает источник: 'rule' (правило маппинга), 'keyword' (ключевое слово), 'inn' (ИНН контрагента), 'fuzzy' (нечеткое совпадение), 'account_number' (номер счета). Операция считается полностью сопоставленной только если найдены статья и счет (контрагент не обязателен). При полном сопоставлении автоматически обновляется статистика использования правил (usageCount, lastUsedAt), что позволяет отслеживать эффективность правил маппинга.

**Ключевые файлы:** `auto-match.service.ts` (координатор), `direction/direction-matcher.service.ts`, `counterparty/counterparty-matcher.service.ts` (с подмодулями rules и fuzzy), `article/article-matcher.service.ts` (с подмодулями rules и keyword), `account/account-matcher.service.ts`. Для расширения логики редактируйте соответствующие matcher-сервисы. Правила ключевых слов находятся в `article/keyword-rules.config.ts` и могут быть вынесены в БД в будущем. Для отладки используйте логи с префиксами `[АВТОСОПОСТАВЛЕНИЕ]`, `[ПРАВИЛО ПРИМЕНЕНО]`, `[ПОИСК ПРАВИЛ]`.
