# Mapping Rules System

Система правил маппинга для автоматического сопоставления полей из банковских выписок со справочниками. Поддерживает 4 типа правил: `equals` (точное совпадение), `contains` (содержит подстроку), `regex` (регулярное выражение), `alias` (специальный тип для контрагентов). Правила применяются с приоритетом: для контрагентов equals → alias → contains, для статей equals → regex → contains.

Правила хранятся в таблице `mapping_rule` и связывают паттерн из банковской выписки (например, название контрагента или текст назначения платежа) с целевым объектом в справочнике (контрагент, статья, счет). Каждое правило имеет поля: `pattern` (текст для поиска), `targetType` (тип целевого объекта), `targetId` (ID объекта), `sourceField` (поле источника: description, payer, receiver), `ruleType` (тип правила). Правила привязаны к компании через `companyId` и создаются пользователем через `userId`.

Применение правил выполняется в строгом порядке приоритетов для обеспечения точности. Для контрагентов: сначала проверяются правила типа `equals` (точное совпадение названия), затем `alias` (специальный тип с частичным совпадением через includes), затем `contains` (широкий поиск подстроки). Для статей: `equals` (точное совпадение назначения платежа), затем `regex` (гибкое совпадение через регулярные выражения с обработкой ошибок), затем `contains` (поиск подстроки). Как только правило срабатывает, поиск прекращается - это гарантирует применение наиболее точного правила.

Система автоматически обновляет статистику использования правил при каждом успешном применении. Поля `usageCount` инкрементируется, `lastUsedAt` обновляется текущей датой. Это позволяет отслеживать эффективность правил - часто используемые правила можно считать надежными, неиспользуемые можно удалить. Статистика используется для сортировки правил в интерфейсе (по умолчанию по usageCount desc) и помогает пользователям управлять правилами. При обновлении статистики обязательно проверяется `companyId` для безопасности.

Правила можно создавать несколькими способами. Вручную через API endpoints (`POST /api/imports/mapping-rules`) с указанием всех параметров. Автоматически при импорте операций - если пользователь выбрал опцию "сохранить правило" для конкретной операции, система создает правило типа `contains` на основе сопоставленных полей. Правила применяются к сессии импорта через метод `applyRules`, который загружает все правила компании заранее (оптимизация без N+1), затем применяет их к каждой необработанной операции в сессии батчами для производительности.

**Ключевые файлы:** `mapping-rules.service.ts` (CRUD операции: `getMappingRules`, `createMappingRule`, `updateMappingRule`, `deleteMappingRule`), используется в `matching/counterparty/counterparty-rules-matcher.service.ts` и `matching/article/article-rules-matcher.service.ts` для сопоставления. Для добавления нового типа правила расширьте enum `RuleType` в схеме Prisma, добавьте логику проверки в соответствующий rules-matcher сервис, и обновите API для создания правил нового типа. Правила валидируются на уровне БД через constraints и на уровне приложения через проверку существования targetId.
