# Import Session Management

Система управления сессиями импорта банковских выписок. Каждая загруженная выписка создает сессию импорта, которая проходит через жизненный цикл: `draft` (черновики созданы) → `confirmed` (операции подтверждены пользователем) → `processed` (операции импортированы в основную таблицу). Сессия связывает файл выписки с импортированными операциями и хранит метаданные (имя файла, количество операций, статус).

Создание сессии выполняется при загрузке файла выписки через метод `createSession`, который принимает параметры: `companyId`, `userId`, `fileName`, `importedCount` (количество операций в файле), и опционально `companyAccountNumber` (номер счета из заголовка файла). Сессия создается со статусом `draft` и начальными счетчиками: `importedCount` (общее количество операций), `confirmedCount: 0`, `processedCount: 0`. Сессия хранит имя файла для отображения в интерфейсе и позволяет пользователю отслеживать историю импортов.

Жизненный цикл сессии управляется автоматически при выполнении операций импорта. При загрузке файла создаются черновики операций в таблице `imported_operations` со ссылкой на сессию через `importSessionId`. Пользователь может редактировать сопоставления операций в интерфейсе, что обновляет счетчик `confirmedCount`. При финальном импорте операций (создание реальных операций в таблице `operations`) обновляется счетчик `processedCount`. Когда `processedCount` достигает `importedCount`, сессия автоматически переходит в статус `processed`, что означает завершение импорта.

Получение сессии через `getSession` всегда проверяет принадлежность к компании через `companyId` для безопасности - пользователь не может получить доступ к сессиям других компаний. Метод возвращает сессию с актуальными счетчиками, которые пересчитываются из связанных операций для точности. Обновление сессии через `updateSession` позволяет вручную изменить статус или счетчики, но обычно это выполняется автоматически системой.

Удаление сессии через `deleteSession` выполняет каскадное удаление всех связанных импортированных операций через CASCADE в схеме БД. Это позволяет полностью очистить данные импорта, если пользователь решил отменить импорт или загрузить файл заново. Перед удалением проверяется принадлежность к компании. Метод возвращает количество удаленных записей (сессия + все операции) для информации пользователю.

**Ключевые файлы:** `session.service.ts` (класс `SessionService` с методами `createSession`, `getSession`, `updateSession`, `deleteSession`), используется в `imports.service.ts` для управления жизненным циклом импорта. Статусы определены в константе `IMPORT_SESSION_STATUS` и соответствуют enum в схеме Prisma. Для добавления нового статуса расширьте enum `ImportSessionStatus` в схеме БД, добавьте значение в константу, и обновите логику переходов в сервисе и в местах автоматического обновления статусов (например, в `operation-import.service.ts`).
