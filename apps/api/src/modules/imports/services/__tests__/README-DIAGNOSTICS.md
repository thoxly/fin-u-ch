# Диагностические тесты для правил импорта операций

Эти тесты собирают информацию о текущей работе правил маппинга и импорта операций, чтобы помочь диагностировать проблемы.

## Что проверяют тесты

1. **Определение направления операции** (income/expense/transfer)
   - По ИНН компании
   - По номерам счетов компании
   - Без данных (должно вернуть null)

2. **Работа правил маппинга для контрагентов**
   - При известном направлении (expense/income)
   - При неизвестном направлении (direction = null) - проверяет оба поля

3. **Работа правил маппинга для статей**
   - При известном направлении
   - При неизвестном направлении - проверяет оба типа статей

4. **Полное автосопоставление**
   - С направлением
   - Без направления

5. **Приоритеты правил**
   - Проверяет, что правило с более высоким приоритетом применяется первым

6. **Сводная диагностика**
   - Собирает всю информацию о системе
   - Выводит выводы и рекомендации

## Как запустить

### Запуск всех диагностических тестов

```bash
cd apps/api
pnpm test matching-rules-diagnostics.test.ts
```

### Запуск конкретного теста

```bash
cd apps/api
pnpm test matching-rules-diagnostics.test.ts -t "должен определить направление по ИНН компании"
```

### Запуск с подробным выводом

```bash
cd apps/api
pnpm test matching-rules-diagnostics.test.ts --verbose
```

### Запуск только сводной диагностики

```bash
cd apps/api
pnpm test matching-rules-diagnostics.test.ts -t "Сводная диагностика"
```

## Что выводится в консоль

Тесты выводят в консоль:

1. **Детальная информация о каждой операции:**
   - Данные операции (payer, receiver, purpose, ИНН, счета)
   - Результат определения направления
   - Результат сопоставления
   - Все логи процесса

2. **Сводная диагностика:**
   - Данные компании (ИНН, счета)
   - Количество и типы правил
   - Количество статей и контрагентов
   - Результаты тестовой операции
   - Выводы и рекомендации

## Интерпретация результатов

### ✅ Все работает

- Направление определяется корректно
- Правила применяются
- Контрагенты и статьи сопоставляются

### ⚠️ Проблемы

**ИНН компании НЕ указан**

- Решение: Указать ИНН компании в настройках

**Счета компании НЕ созданы**

- Решение: Создать счета с номерами в справочнике счетов

**Правила маппинга НЕ созданы**

- Решение: Создать правила через интерфейс "Правила автоматизации"

**Направление НЕ определяется**

- Причины:
  - Нет ИНН компании
  - Нет номеров счетов
  - ИНН/счета в файле не совпадают с данными компании
- Решение: Проверить данные компании и данные в файле выписки

**Автосопоставление НЕ работает**

- Причины:
  - Нет правил
  - Правила не соответствуют данным в операциях
  - Направление не определяется (но это не должно блокировать после исправлений)
- Решение: Проверить правила и их соответствие данным

## Пример вывода

```
=== ДИАГНОСТИКА: Определение направления (expense) ===
Операция: {
  "date": "2025-01-15T00:00:00.000Z",
  "amount": 1000,
  "purpose": "Тестовый платеж",
  "payerInn": "1234567890",
  "receiverInn": "9876543210"
}
ИНН компании: 1234567890
Результат: expense
Логи: [...]
```

## Важные замечания

1. **Тесты используют реальную базу данных** - они создают тестовые данные и удаляют их после завершения
2. **Тесты требуют подключения к БД** - убедитесь, что DATABASE_URL настроен правильно
3. **Тесты создают тестовую компанию** - она будет удалена после завершения всех тестов
4. **Логи собираются в массив** - все логи доступны в консоли для анализа

## Следующие шаги после диагностики

1. Если направление не определяется:
   - Проверьте ИНН компании
   - Проверьте номера счетов
   - Проверьте данные в файле выписки

2. Если правила не применяются:
   - Проверьте, что правила созданы
   - Проверьте соответствие паттернов правил данным в операциях
   - Проверьте sourceField правил (payer/receiver/description)

3. Если сопоставление работает частично:
   - Проверьте приоритеты правил
   - Проверьте типы правил (equals > regex > contains)
   - Проверьте, что targetId правил указывают на существующие записи
