# ClientBank Exchange Parser

Парсер банковских выписок в формате 1C:ClientBank Exchange. Поддерживает автоматическое определение кодировки (UTF-8, Windows-1251, с BOM и без), парсинг заголовка файла для извлечения номера счета компании, и обработку секций документов с нормализацией ключей через универсальный словарь KEY_MAPPING. Система обрабатывает множественные форматы документов (платежные поручения, банковские ордера, инкассовые поручения и др.) и продолжает работу даже при ошибках в отдельных документах.

Определение кодировки выполняется в несколько этапов. Сначала проверяется наличие UTF-8 BOM (первые 3 байта: 0xEF 0xBB 0xBF) - если найден, файл декодируется как UTF-8. Затем анализируются первые 500 байт на наличие символов замены () при декодировании как UTF-8 - если их нет и найдены кириллица и заголовок "1CClientBankExchange", используется UTF-8. Если UTF-8 не подходит, пробуется Windows-1251 (стандарт для 1С) - проверяется наличие кириллицы и заголовка. В крайнем случае используется UTF-8 как fallback. Все невидимые символы (BOM, zero-width spaces) удаляются после декодирования.

Парсинг файла начинается с проверки заголовка "1CClientBankExchange" в первых 5 строках - без него файл считается невалидным. Затем файл разделяется на секции: заголовок (до первой "СекцияДокумент") и секции документов (между "СекцияДокумент" и "КонецДокумента"). Система обрабатывает незакрытые секции (если "КонецДокумента" отсутствует, но есть данные) и игнорирует секции счетов ("СекцияРасчСчет"). Из заголовка извлекается номер расчетного счета компании через поиск ключей "РасчСчет" или "РасчетныйСчет" с валидацией формата номера счета.

Парсинг каждого документа использует универсальный словарь KEY_MAPPING для нормализации ключей - система поддерживает множественные варианты названий полей (русские, английские, с опечатками) и приводит их к единому формату. Например, "Дата", "date", "ДатаПроводки", "datePosted" все маппятся в поле "date". Парсинг поддерживает многострочные значения - если строка не содержит "=", она считается продолжением предыдущего значения. Значения в кавычках автоматически очищаются. Неопознанные ключи сохраняются в rawFields для отладки, но не используются в основном парсинге.

Валидация документов выполняется после парсинга. Обязательные поля: дата (извлекается по приоритету: dateWrittenOff → dateReceived → date) и сумма (поле amount). Дата парсится в различных форматах (DD.MM.YYYY, YYYY-MM-DD и др.), сумма очищается от пробелов и форматируется как число. Если дата или сумма невалидны, документ помечается как invalid, но не останавливает обработку остальных. Система собирает статистику: количество обработанных документов, пропущенных (неподдерживаемые типы), невалидных, и список найденных типов документов. Каждый документ получает хэш для последующего обнаружения дубликатов.

**Ключевые файлы:** `clientBankExchange.parser.ts` (главная функция `parseClientBankExchange`), `document-types.config.ts` (SUPPORTED_DOC_TYPES, KEY_MAPPING). Для добавления новых типов документов добавьте нормализованное название в SUPPORTED_DOC_TYPES. Для добавления новых полей расширьте KEY_MAPPING с вариантами названий. Алгоритм определения кодировки находится в функции `decodeFile`, парсинг секций - в `splitIntoSections`, парсинг документа - в `parseDocumentSection`. Для отладки используйте логи с префиксом `[ПАРСЕР]`.
