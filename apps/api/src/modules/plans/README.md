# Plans & Budget Expansion System

Система управления планами (PlanItem) и их разворачивания в календарную сетку для отчетов БДДС и План-факт. Планы связаны с бюджетами через `budgetId` и поддерживают периодичность (daily, weekly, monthly, quarterly, semiannual, annual) для автоматического разворачивания сумм по месяцам.

План (PlanItem) представляет собой шаблон плановой операции с полями: `amount` (сумма), `articleId` (статья), `startDate` (дата начала), `endDate` (дата окончания, опционально), `repeat` (периодичность), `budgetId` (привязка к бюджету, опционально), `status` (active/archived). Планы создаются пользователем через API и могут быть привязаны к бюджетам для группировки в отчетах. Планы с `status: 'archived'` не участвуют в разворачивании и отчетах, что позволяет скрывать устаревшие планы без удаления.

Алгоритм разворачивания (`expandPlan`) преобразует план в массив помесячных записей для заданного периода. Для каждой периодичности используется своя логика. `daily` создает запись на каждый день периода между startDate и endDate (или концом периода запроса). `weekly` создает запись на каждый день недели, соответствующий дню недели startDate. `monthly` создает запись на то же число каждого месяца. `quarterly` и `semiannual` создают записи с интервалом 3 и 6 месяцев соответственно, проверяя кратность. `annual` создает запись на ту же дату каждый год. Сумма распределяется равномерно - если план на 12000₽ с monthly периодичностью, каждая запись будет 1000₽.

Система учитывает границы плана и периода запроса. План разворачивается только для дат между `startDate` и `endDate` (если указана), и только для дат в пределах периода запроса (`periodFrom` - `periodTo`). Если план начинается в середине периода, разворачивание начинается с `startDate`. Если план заканчивается до конца периода, разворачивание заканчивается на `endDate`. Это гарантирует, что плановые данные соответствуют реальному периоду действия плана и не создаются лишние записи.

Результат разворачивания используется в двух типах отчетов. В БДДС (BDDS) планы группируются по activity статьи, затем по type (income/expense), затем по статьям, и наконец по месяцам. Это позволяет видеть плановый денежный поток по категориям с помесячной детализацией. В План-факт планы объединяются с фактическими операциями по ключам (месяц + article/deal/department) для расчета дельты. Разворачивание выполняется на лету при каждом запросе отчета, что позволяет видеть актуальные данные при изменении планов без пересчета.

**Ключевые файлы:** `plans.service.ts` (метод `expandPlan(planItem, periodFrom, periodTo)`), используется в `bdds.service.ts` (метод `getBDDS`) и `planfact.service.ts` (метод `getPlanFact`). Для добавления новой периодичности расширьте switch в методе `expandPlan` с логикой расчета дат. Планы создаются и управляются через API endpoints в `plans.controller.ts`. Для оптимизации при больших объемах планов можно добавить кэширование результатов разворачивания или использовать materialized views в БД. Для отладки проверяйте логи с информацией о разворачивании планов.
