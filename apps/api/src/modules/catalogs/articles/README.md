# Article Hierarchy System

Система иерархической организации статей доходов и расходов через поле `parentId`. Поддерживает неограниченную вложенность и используется для группировки статей в отчетах. При фильтрации по родительской статье автоматически включаются все дочерние статьи через рекурсивный алгоритм получения потомков.

Иерархия статей позволяет создавать группы и подгруппы для удобной организации финансовых категорий. Например, статья "Маркетинг" может иметь дочерние статьи "Реклама", "Контент", "Аналитика", каждая из которых может иметь свои подстатьи. Это упрощает управление большим количеством статей и позволяет анализировать данные на разных уровнях детализации. Статьи могут быть только одного типа (income или expense) независимо от уровня вложенности - дочерние статьи наследуют тип от родительской.

Метод `getDescendantIds` реализует рекурсивный алгоритм получения всех потомков статьи. Алгоритм работает следующим образом: сначала загружаются все прямые дочерние статьи (где `parentId` равен ID родителя), затем для каждой дочерней статьи рекурсивно вызывается та же функция для получения их потомков. Результаты собираются в массив уникальных ID, который включает все уровни вложенности. Для оптимизации можно использовать один запрос с рекурсивным CTE в SQL, но текущая реализация через Prisma использует итеративный подход с кэшированием результатов.

Система предотвращает создание циклов в иерархии при изменении родителя статьи. При попытке установить `parentId` равным ID самой статьи или ID любого из потомков, операция должна быть отклонена (проверка выполняется на уровне приложения или БД). Это гарантирует, что иерархия всегда остается деревом без циклов. В интерфейсе frontend компонент `ArticleTree` отображает иерархию в виде дерева с возможностью drag-and-drop для изменения родителя, но проверка циклов выполняется на backend.

В отчетах иерархия используется для фильтрации и группировки данных. При указании `parentArticleId` в параметрах отчета (например, Cashflow), система автоматически включает все дочерние статьи через вызов `getDescendantIds`. Это позволяет получить агрегированные данные по всей группе статей одним запросом. Например, фильтрация по "Маркетинг" вернет данные по "Маркетинг", "Реклама", "Контент", "Аналитика" и всем их подстатьям. Группировка в отчетах также учитывает иерархию - данные могут быть сгруппированы по уровням вложенности для детального анализа.

**Ключевые файлы:** `articles.service.ts` (метод `getDescendantIds(articleId, companyId)`), используется в `cashflow.service.ts` и других отчетах при фильтрации по `parentArticleId`. Для изменения логики иерархии редактируйте метод получения потомков - можно оптимизировать через рекурсивный SQL запрос или добавить кэширование результатов. Frontend компонент `ArticleTree` в `apps/web/src/features/articles/` отображает иерархию в виде дерева с поддержкой drag-and-drop для изменения родителя. Для добавления новых операций с иерархией (например, перемещение поддерева) расширьте сервис соответствующими методами.
