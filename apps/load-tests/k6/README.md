# k6 load tests

Файлы сценариев находятся в этой папке. Перед запуском убедитесь, что в системе установлен `k6`.

Переменные окружения, используемые в скриптах:

- `K6_HOST` — базовый URL тестируемого сервера (по умолчанию `http://localhost:3000`)
- `K6_TEST_USER` / `K6_TEST_EMAIL` / `K6_TEST_PASS` — учётные данные тестового пользователя (email + password)
- `K6_VUS` — количество виртуальных пользователей (если не задано, берётся из скрипта)
- `K6_DURATION` — длительность (например, `1m`, `5m`)

Примеры запуска:

```bash
# Быстрый smoke-тест аутентификации
k6 run -e K6_HOST=http://localhost:3000 authentication.js

# CRUD тест, 50 VUs 3 минуты
k6 run -e K6_HOST=http://localhost:3000 -e K6_VUS=50 -e K6_DURATION=3m crud.js

# Spike тест
k6 run -e K6_HOST=http://localhost:3000 spike.js

# Тест создания demo-сессии и проверки защищённого маршрута
k6 run -e K6_HOST=http://localhost:3000 worker_jobs.js

# Тесты импорта банковских выписок
# Загрузка файлов разных размеров
k6 run -e K6_HOST=http://localhost:3000 imports_upload_test.js

# Тест автоматического сопоставления и применения правил
k6 run -e K6_HOST=http://localhost:3000 imports_matching_test.js

# Тест импорта операций
k6 run -e K6_HOST=http://localhost:3000 imports_import_test.js

# Тест работы с правилами маппинга
k6 run -e K6_HOST=http://localhost:3000 imports_rules_test.js

# Комплексный тест полного процесса импорта
k6 run -e K6_HOST=http://localhost:3000 imports_full_flow_test.js
```

## Тесты импорта банковских выписок

Новые тесты покрывают критически важный модуль импорта:

- **imports_upload_test.js** — тестирует загрузку файлов разных размеров (10, 100, 500, 1000 операций), проверяет валидацию размера файла
- **imports_matching_test.js** — тестирует автоматическое сопоставление операций, применение правил маппинга, массовое обновление операций
- **imports_import_test.js** — тестирует импорт операций из сессий в основную базу данных (полный и выборочный импорт)
- **imports_rules_test.js** — тестирует CRUD операции с правилами маппинга (создание, обновление, удаление, фильтрация)
- **imports_full_flow_test.js** — комплексный тест полного процесса: загрузка → применение правил → сопоставление → подтверждение → импорт

Все тесты используют утилиту `utils/generate-bank-file.js` для генерации тестовых файлов формата ClientBank Exchange.

Рекомендации:

- Запускайте smoke перед тяжёлыми тестами.
- Интегрируйте экспорт метрик в InfluxDB/Grafana для визуализации (`--out influxdb=...`).
- Перед прогоном на production-окружении убедитесь, что вы используете тестовый набор данных и учётные записи.
- Тесты импорта создают реальные сессии и операции — убедитесь, что используете тестовое окружение.
